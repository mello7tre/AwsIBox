AWSTemplateFormatVersion: '2010-09-09'
Conditions:
  BaseRegion:
    Fn::Equals:
      - eu-west-1
      - Ref: AWS::Region
  CapacityDesiredOverride:
    Fn::Not:
      - Fn::Equals:
          - Ref: CapacityDesired
          - ''
  CapacityMaxOverride:
    Fn::Not:
      - Fn::Equals:
          - Ref: CapacityMax
          - ''
  CapacityMinOverride:
    Fn::Not:
      - Fn::Equals:
          - Ref: CapacityMin
          - ''
  ClusterStackOverride:
    Fn::Not:
      - Fn::Equals:
          - Ref: ClusterStack
          - ''
  ContainerDefinitions1Command:
    Fn::Or:
      - Condition: ContainerDefinitions1CommandOverride
      - Fn::Equals:
          - 'True'
          - 'False'
  ContainerDefinitions1CommandOverride:
    Fn::Not:
      - Fn::Equals:
          - Fn::Select:
              - 0
              - Ref: ContainerDefinitions1Command
          - ''
  ContainerDefinitions1ContainerPort:
    Fn::Not:
      - Fn::Equals:
          - 0
          - 0
  ContainerDefinitions1CpuOverride:
    Fn::Not:
      - Fn::Equals:
          - Ref: ContainerDefinitions1Cpu
          - ''
  ContainerDefinitions1EnvironmentAWSDEFAULTREGIONValueOverride:
    Fn::Not:
      - Fn::Equals:
          - Ref: ContainerDefinitions1EnvironmentAWSDEFAULTREGIONValue
          - ''
  ContainerDefinitions1HostPort:
    Fn::Not:
      - Fn::Equals:
          - None
          - None
  ContainerDefinitions1MemoryOverride:
    Fn::Not:
      - Fn::Equals:
          - Ref: ContainerDefinitions1Memory
          - ''
  ContainerDefinitions1MemoryReservationOverride:
    Fn::Not:
      - Fn::Equals:
          - Ref: ContainerDefinitions1MemoryReservation
          - ''
  CpuOverride:
    Fn::Not:
      - Fn::Equals:
          - Ref: Cpu
          - ''
  CpuTask:
    Fn::Or:
      - Fn::And:
          - Condition: CpuOverride
          - Fn::Not:
              - Fn::Equals:
                  - Ref: Cpu
                  - None
      - Fn::And:
          - Fn::Not:
              - Condition: CpuOverride
          - Fn::Not:
              - Fn::Equals:
                  - None
                  - None
  DockerLabelLastUpdateOverride:
    Fn::Not:
      - Fn::Equals:
          - Ref: DockerLabelLastUpdate
          - ''
  LaunchTypeFarGate:
    Fn::Or:
      - Fn::And:
          - Condition: LaunchTypeOverride
          - Fn::Equals:
              - Ref: LaunchType
              - FARGATE
      - Fn::And:
          - Fn::Not:
              - Condition: LaunchTypeOverride
          - Fn::Equals:
              - EC2
              - FARGATE
  LaunchTypeOverride:
    Fn::Not:
      - Fn::Equals:
          - Ref: LaunchType
          - ''
  LoadBalancerApplicationStackOverride:
    Fn::Not:
      - Fn::Equals:
          - Ref: LoadBalancerApplicationStack
          - ''
  LogConfiguration:
    Fn::Or:
      - Fn::And:
          - Condition: LogDriverOverride
          - Fn::Not:
              - Fn::Equals:
                  - Ref: LogDriver
                  - None
      - Fn::And:
          - Fn::Not:
              - Condition: LogDriverOverride
          - Fn::Not:
              - Fn::Equals:
                  - awslogs
                  - None
  LogDriverOverride:
    Fn::Not:
      - Fn::Equals:
          - Ref: LogDriver
          - ''
  MemoryOverride:
    Fn::Not:
      - Fn::Equals:
          - Ref: Memory
          - ''
  NetworkModeAwsVpc:
    Fn::Or:
      - Fn::And:
          - Condition: NetworkModeOverride
          - Fn::Equals:
              - Ref: NetworkMode
              - awsvpc
      - Fn::And:
          - Fn::Not:
              - Condition: NetworkModeOverride
          - Fn::Equals:
              - bridge
              - awsvpc
      - Condition: LaunchTypeFarGate
  NetworkModeOverride:
    Fn::Not:
      - Fn::Equals:
          - Ref: NetworkMode
          - ''
  NetworkModeStandard:
    Fn::Or:
      - Fn::And:
          - Condition: NetworkModeOverride
          - Fn::Not:
              - Fn::Equals:
                  - Ref: NetworkMode
                  - awsvpc
      - Fn::And:
          - Fn::Not:
              - Condition: NetworkModeOverride
          - Fn::Not:
              - Fn::Equals:
                  - bridge
                  - awsvpc
  ScheduledActionDown:
    Fn::Or:
      - Fn::And:
          - Condition: ScheduledActionDownScheduleOverride
          - Fn::Not:
              - Fn::Equals:
                  - Ref: ScheduledActionDownSchedule
                  - None
      - Fn::And:
          - Fn::Not:
              - Condition: ScheduledActionDownScheduleOverride
          - Fn::Not:
              - Fn::Equals:
                  - cron(00 22 * * ? *)
                  - None
  ScheduledActionDownCapacityMaxOverride:
    Fn::Not:
      - Fn::Equals:
          - Ref: ScheduledActionDownCapacityMax
          - ''
  ScheduledActionDownCapacityMaxSize:
    Fn::Or:
      - Fn::And:
          - Condition: ScheduledActionDownCapacityMaxOverride
          - Fn::Equals:
              - Ref: ScheduledActionDownCapacityMax
              - CapacityMax
      - Fn::And:
          - Fn::Not:
              - Condition: ScheduledActionDownCapacityMaxOverride
          - Fn::Equals:
              - k
              - CapacityMax
  ScheduledActionDownCapacityMinOverride:
    Fn::Not:
      - Fn::Equals:
          - Ref: ScheduledActionDownCapacityMin
          - ''
  ScheduledActionDownCapacityMinSize:
    Fn::Or:
      - Fn::And:
          - Condition: ScheduledActionDownCapacityMinOverride
          - Fn::Equals:
              - Ref: ScheduledActionDownCapacityMin
              - CapacityMin
      - Fn::And:
          - Fn::Not:
              - Condition: ScheduledActionDownCapacityMinOverride
          - Fn::Equals:
              - k
              - CapacityMin
  ScheduledActionDownDisable:
    Fn::Or:
      - Fn::Not:
          - Condition: ScheduledActionDown
      - Fn::And:
          - Condition: ScheduledActionDownKeepMaxSize
          - Condition: ScheduledActionDownKeepMinSize
  ScheduledActionDownKeepMaxSize:
    Fn::Or:
      - Fn::And:
          - Condition: ScheduledActionDownCapacityMaxOverride
          - Fn::Equals:
              - Ref: ScheduledActionDownCapacityMax
              - k
      - Fn::And:
          - Fn::Not:
              - Condition: ScheduledActionDownCapacityMaxOverride
          - Fn::Equals:
              - k
              - k
  ScheduledActionDownKeepMinSize:
    Fn::Or:
      - Fn::And:
          - Condition: ScheduledActionDownCapacityMinOverride
          - Fn::Equals:
              - Ref: ScheduledActionDownCapacityMin
              - k
      - Fn::And:
          - Fn::Not:
              - Condition: ScheduledActionDownCapacityMinOverride
          - Fn::Equals:
              - k
              - k
  ScheduledActionDownScheduleOverride:
    Fn::Not:
      - Fn::Equals:
          - Ref: ScheduledActionDownSchedule
          - ''
  ScheduledActionDownStartTimeOverride:
    Fn::Not:
      - Fn::Equals:
          - Ref: ScheduledActionDownStartTime
          - ''
  ScheduledActionUp:
    Fn::Or:
      - Fn::And:
          - Condition: ScheduledActionUpScheduleOverride
          - Fn::Not:
              - Fn::Equals:
                  - Ref: ScheduledActionUpSchedule
                  - None
      - Fn::And:
          - Fn::Not:
              - Condition: ScheduledActionUpScheduleOverride
          - Fn::Not:
              - Fn::Equals:
                  - cron(00 06 * * ? *)
                  - None
  ScheduledActionUpCapacityMaxOverride:
    Fn::Not:
      - Fn::Equals:
          - Ref: ScheduledActionUpCapacityMax
          - ''
  ScheduledActionUpCapacityMaxSize:
    Fn::Or:
      - Fn::And:
          - Condition: ScheduledActionUpCapacityMaxOverride
          - Fn::Equals:
              - Ref: ScheduledActionUpCapacityMax
              - CapacityMax
      - Fn::And:
          - Fn::Not:
              - Condition: ScheduledActionUpCapacityMaxOverride
          - Fn::Equals:
              - Fn::FindInMap:
                  - Ref: EnvShort
                  - Ref: AWS::Region
                  - ScheduledActionUpCapacityMax
              - CapacityMax
  ScheduledActionUpCapacityMinOverride:
    Fn::Not:
      - Fn::Equals:
          - Ref: ScheduledActionUpCapacityMin
          - ''
  ScheduledActionUpCapacityMinSize:
    Fn::Or:
      - Fn::And:
          - Condition: ScheduledActionUpCapacityMinOverride
          - Fn::Equals:
              - Ref: ScheduledActionUpCapacityMin
              - CapacityMin
      - Fn::And:
          - Fn::Not:
              - Condition: ScheduledActionUpCapacityMinOverride
          - Fn::Equals:
              - Fn::FindInMap:
                  - Ref: EnvShort
                  - Ref: AWS::Region
                  - ScheduledActionUpCapacityMin
              - CapacityMin
  ScheduledActionUpDisable:
    Fn::Or:
      - Fn::Not:
          - Condition: ScheduledActionUp
      - Fn::And:
          - Condition: ScheduledActionUpKeepMaxSize
          - Condition: ScheduledActionUpKeepMinSize
  ScheduledActionUpKeepMaxSize:
    Fn::Or:
      - Fn::And:
          - Condition: ScheduledActionUpCapacityMaxOverride
          - Fn::Equals:
              - Ref: ScheduledActionUpCapacityMax
              - k
      - Fn::And:
          - Fn::Not:
              - Condition: ScheduledActionUpCapacityMaxOverride
          - Fn::Equals:
              - Fn::FindInMap:
                  - Ref: EnvShort
                  - Ref: AWS::Region
                  - ScheduledActionUpCapacityMax
              - k
  ScheduledActionUpKeepMinSize:
    Fn::Or:
      - Fn::And:
          - Condition: ScheduledActionUpCapacityMinOverride
          - Fn::Equals:
              - Ref: ScheduledActionUpCapacityMin
              - k
      - Fn::And:
          - Fn::Not:
              - Condition: ScheduledActionUpCapacityMinOverride
          - Fn::Equals:
              - Fn::FindInMap:
                  - Ref: EnvShort
                  - Ref: AWS::Region
                  - ScheduledActionUpCapacityMin
              - k
  ScheduledActionUpScheduleOverride:
    Fn::Not:
      - Fn::Equals:
          - Ref: ScheduledActionUpSchedule
          - ''
  ScheduledActionUpStartTimeOverride:
    Fn::Not:
      - Fn::Equals:
          - Ref: ScheduledActionUpStartTime
          - ''
  SecurityGroup0:
    Fn::Not:
      - Fn::Or:
          - Fn::And:
              - Condition: SecurityGroupsOverride
              - Fn::Equals:
                  - Fn::Select:
                      - 0
                      - Fn::Split:
                          - ','
                          - Ref: SecurityGroups
                  - None
          - Fn::And:
              - Fn::Not:
                  - Condition: SecurityGroupsOverride
              - Fn::Equals:
                  - Fn::Select:
                      - 0
                      - Fn::Split:
                          - ','
                          - BaseInstance,None,None,None
                  - None
  SecurityGroup1:
    Fn::Not:
      - Fn::Or:
          - Fn::And:
              - Condition: SecurityGroupsOverride
              - Fn::Equals:
                  - Fn::Select:
                      - 1
                      - Fn::Split:
                          - ','
                          - Ref: SecurityGroups
                  - None
          - Fn::And:
              - Fn::Not:
                  - Condition: SecurityGroupsOverride
              - Fn::Equals:
                  - Fn::Select:
                      - 1
                      - Fn::Split:
                          - ','
                          - BaseInstance,None,None,None
                  - None
  SecurityGroup2:
    Fn::Not:
      - Fn::Or:
          - Fn::And:
              - Condition: SecurityGroupsOverride
              - Fn::Equals:
                  - Fn::Select:
                      - 2
                      - Fn::Split:
                          - ','
                          - Ref: SecurityGroups
                  - None
          - Fn::And:
              - Fn::Not:
                  - Condition: SecurityGroupsOverride
              - Fn::Equals:
                  - Fn::Select:
                      - 2
                      - Fn::Split:
                          - ','
                          - BaseInstance,None,None,None
                  - None
  SecurityGroup3:
    Fn::Not:
      - Fn::Or:
          - Fn::And:
              - Condition: SecurityGroupsOverride
              - Fn::Equals:
                  - Fn::Select:
                      - 3
                      - Fn::Split:
                          - ','
                          - Ref: SecurityGroups
                  - None
          - Fn::And:
              - Fn::Not:
                  - Condition: SecurityGroupsOverride
              - Fn::Equals:
                  - Fn::Select:
                      - 3
                      - Fn::Split:
                          - ','
                          - BaseInstance,None,None,None
                  - None
  SecurityGroupsOverride:
    Fn::Not:
      - Fn::Equals:
          - Ref: SecurityGroups
          - ',,,'
  ServiceBaseDeploymentConfigurationMaximumPercentOverride:
    Fn::Not:
      - Fn::Equals:
          - Ref: ServiceBaseDeploymentConfigurationMaximumPercent
          - ''
  ServiceBaseDeploymentConfigurationMinimumHealthyPercentOverride:
    Fn::Not:
      - Fn::Equals:
          - Ref: ServiceBaseDeploymentConfigurationMinimumHealthyPercent
          - ''
Description: buildkite (Generated by awsibox 0.2.20) [ecs]
Mappings:
  dev:
    eu-central-1:
      AlarmTargetExternal5XXEvaluationPeriods: 0
      AlarmTargetInternal5XXEvaluationPeriods: 0
      CapacityDesired: 3
      CapacityMax: 4
      CapacityMin: 3
      ContainerDefinitions1Cpu: 128
      ScheduledActionUpCapacityMax: CapacityMax
      ScheduledActionUpCapacityMin: CapacityMin
    eu-west-1:
      AlarmTargetExternal5XXEvaluationPeriods: 0
      AlarmTargetInternal5XXEvaluationPeriods: 0
      CapacityDesired: 3
      CapacityMax: 4
      CapacityMin: 3
      ContainerDefinitions1Cpu: 128
      ScheduledActionUpCapacityMax: CapacityMax
      ScheduledActionUpCapacityMin: CapacityMin
    us-east-1:
      AlarmTargetExternal5XXEvaluationPeriods: 0
      AlarmTargetInternal5XXEvaluationPeriods: 0
      CapacityDesired: 3
      CapacityMax: 4
      CapacityMin: 3
      ContainerDefinitions1Cpu: 128
      ScheduledActionUpCapacityMax: CapacityMax
      ScheduledActionUpCapacityMin: CapacityMin
  prd:
    eu-central-1:
      AlarmTargetExternal5XXEvaluationPeriods: 2
      AlarmTargetInternal5XXEvaluationPeriods: 2
      CapacityDesired: 0
      CapacityMax: 9
      CapacityMin: 0
      ContainerDefinitions1Cpu: 256
      ScheduledActionUpCapacityMax: k
      ScheduledActionUpCapacityMin: k
    eu-west-1:
      AlarmTargetExternal5XXEvaluationPeriods: 2
      AlarmTargetInternal5XXEvaluationPeriods: 2
      CapacityDesired: 2
      CapacityMax: 9
      CapacityMin: 2
      ContainerDefinitions1Cpu: 256
      ScheduledActionUpCapacityMax: k
      ScheduledActionUpCapacityMin: k
    us-east-1:
      AlarmTargetExternal5XXEvaluationPeriods: 2
      AlarmTargetInternal5XXEvaluationPeriods: 2
      CapacityDesired: 2
      CapacityMax: 9
      CapacityMin: 2
      ContainerDefinitions1Cpu: 256
      ScheduledActionUpCapacityMax: k
      ScheduledActionUpCapacityMin: k
  stg:
    eu-central-1:
      AlarmTargetExternal5XXEvaluationPeriods: 0
      AlarmTargetInternal5XXEvaluationPeriods: 0
      CapacityDesired: 3
      CapacityMax: 4
      CapacityMin: 3
      ContainerDefinitions1Cpu: 128
      ScheduledActionUpCapacityMax: CapacityMax
      ScheduledActionUpCapacityMin: CapacityMin
    eu-west-1:
      AlarmTargetExternal5XXEvaluationPeriods: 0
      AlarmTargetInternal5XXEvaluationPeriods: 0
      CapacityDesired: 3
      CapacityMax: 4
      CapacityMin: 3
      ContainerDefinitions1Cpu: 128
      ScheduledActionUpCapacityMax: CapacityMax
      ScheduledActionUpCapacityMin: CapacityMin
    us-east-1:
      AlarmTargetExternal5XXEvaluationPeriods: 0
      AlarmTargetInternal5XXEvaluationPeriods: 0
      CapacityDesired: 3
      CapacityMax: 4
      CapacityMin: 3
      ContainerDefinitions1Cpu: 128
      ScheduledActionUpCapacityMax: CapacityMax
      ScheduledActionUpCapacityMin: CapacityMin
Outputs:
  BrandDomain:
    Value: numenor.arda
  Capacity:
    Value:
      Fn::Sub:
        - Desired=${CapacityDesired},Min=${CapacityMin},Max=${CapacityMax}
        - CapacityDesired:
            Fn::If:
              - CapacityDesiredOverride
              - Ref: CapacityDesired
              - Fn::FindInMap:
                  - Ref: EnvShort
                  - Ref: AWS::Region
                  - CapacityDesired
          CapacityMax:
            Fn::If:
              - CapacityMaxOverride
              - Ref: CapacityMax
              - Fn::FindInMap:
                  - Ref: EnvShort
                  - Ref: AWS::Region
                  - CapacityMax
          CapacityMin:
            Fn::If:
              - CapacityMinOverride
              - Ref: CapacityMin
              - Fn::FindInMap:
                  - Ref: EnvShort
                  - Ref: AWS::Region
                  - CapacityMin
  ContainerDefinitions1Command:
    Condition: ContainerDefinitions1Command
    Value:
      Fn::Join:
        - ','
        - Fn::If:
            - ContainerDefinitions1CommandOverride
            - Ref: ContainerDefinitions1Command
            - Ref: AWS::NoValue
  ContainerDefinitions1Constraints:
    Value:
      Fn::Join:
        - ''
        - - Cpu=
          - Fn::If:
              - CpuTask
              - Fn::If:
                  - CpuOverride
                  - Ref: Cpu
                  - None
              - Fn::If:
                  - ContainerDefinitions1CpuOverride
                  - Ref: ContainerDefinitions1Cpu
                  - Fn::FindInMap:
                      - Ref: EnvShort
                      - Ref: AWS::Region
                      - ContainerDefinitions1Cpu
          - ',Memory='
          - Fn::If:
              - LaunchTypeFarGate
              - Fn::If:
                  - MemoryOverride
                  - Ref: Memory
                  - 512
              - Fn::If:
                  - ContainerDefinitions1MemoryOverride
                  - Ref: ContainerDefinitions1Memory
                  - 128
          - ',MemoryReservation='
          - Fn::If:
              - ContainerDefinitions1MemoryReservationOverride
              - Ref: ContainerDefinitions1MemoryReservation
              - 64
  ContainerDefinitions1Environment:
    Value:
      Fn::Sub:
        - AWS_DEFAULT_REGION=${AWS_DEFAULT_REGION}
        - AWS_DEFAULT_REGION:
            Fn::If:
              - ContainerDefinitions1EnvironmentAWSDEFAULTREGIONValueOverride
              - Ref: ContainerDefinitions1EnvironmentAWSDEFAULTREGIONValue
              - Ref: AWS::Region
  Cpu:
    Condition: CpuTask
    Value:
      Fn::If:
        - CpuOverride
        - Ref: Cpu
        - None
  Env:
    Value:
      Ref: Env
  EnvApp1Version:
    Value:
      Ref: EnvApp1Version
  EnvRole:
    Value:
      Ref: EnvRole
  EnvStackVersion:
    Value:
      Ref: EnvStackVersion
  LaunchType:
    Value:
      Fn::If:
        - LaunchTypeOverride
        - Ref: LaunchType
        - EC2
  LogDriver:
    Value:
      Fn::If:
        - LogDriverOverride
        - Ref: LogDriver
        - awslogs
  Memory:
    Condition: LaunchTypeFarGate
    Value:
      Fn::If:
        - MemoryOverride
        - Ref: Memory
        - 512
  NetworkMode:
    Value:
      Fn::If:
        - NetworkModeAwsVpc
        - awsvpc
        - Fn::If:
            - NetworkModeOverride
            - Ref: NetworkMode
            - bridge
  RepoName:
    Value:
      Fn::Sub:
        - ${BrandRegion}.${Brand}.services.buildkite
        - Brand: numenor
          BrandRegion: arda
  ScheduledActionDown:
    Value:
      Fn::Join:
        - ''
        - - CapacityMin=
          - Fn::If:
              - ScheduledActionDownCapacityMinSize
              - Fn::If:
                  - CapacityMinOverride
                  - Ref: CapacityMin
                  - Fn::FindInMap:
                      - Ref: EnvShort
                      - Ref: AWS::Region
                      - CapacityMin
              - Fn::If:
                  - ScheduledActionDownKeepMinSize
                  - Ref: AWS::NoValue
                  - Fn::If:
                      - ScheduledActionDownCapacityMinOverride
                      - Ref: ScheduledActionDownCapacityMin
                      - k
          - ',CapacityMax='
          - Fn::If:
              - ScheduledActionDownCapacityMaxSize
              - Fn::If:
                  - CapacityMaxOverride
                  - Ref: CapacityMax
                  - Fn::FindInMap:
                      - Ref: EnvShort
                      - Ref: AWS::Region
                      - CapacityMax
              - Fn::If:
                  - ScheduledActionDownKeepMaxSize
                  - Ref: AWS::NoValue
                  - Fn::If:
                      - ScheduledActionDownCapacityMaxOverride
                      - Ref: ScheduledActionDownCapacityMax
                      - k
          - ',Schedule='
          - Fn::If:
              - ScheduledActionDownScheduleOverride
              - Ref: ScheduledActionDownSchedule
              - cron(00 22 * * ? *)
          - ',StartTime='
          - Fn::If:
              - ScheduledActionDownStartTimeOverride
              - Ref: ScheduledActionDownStartTime
              - Ref: AWS::NoValue
  ScheduledActionUp:
    Value:
      Fn::Join:
        - ''
        - - CapacityMin=
          - Fn::If:
              - ScheduledActionUpCapacityMinSize
              - Fn::If:
                  - CapacityMinOverride
                  - Ref: CapacityMin
                  - Fn::FindInMap:
                      - Ref: EnvShort
                      - Ref: AWS::Region
                      - CapacityMin
              - Fn::If:
                  - ScheduledActionUpKeepMinSize
                  - Ref: AWS::NoValue
                  - Fn::If:
                      - ScheduledActionUpCapacityMinOverride
                      - Ref: ScheduledActionUpCapacityMin
                      - Fn::FindInMap:
                          - Ref: EnvShort
                          - Ref: AWS::Region
                          - ScheduledActionUpCapacityMin
          - ',CapacityMax='
          - Fn::If:
              - ScheduledActionUpCapacityMaxSize
              - Fn::If:
                  - CapacityMaxOverride
                  - Ref: CapacityMax
                  - Fn::FindInMap:
                      - Ref: EnvShort
                      - Ref: AWS::Region
                      - CapacityMax
              - Fn::If:
                  - ScheduledActionUpKeepMaxSize
                  - Ref: AWS::NoValue
                  - Fn::If:
                      - ScheduledActionUpCapacityMaxOverride
                      - Ref: ScheduledActionUpCapacityMax
                      - Fn::FindInMap:
                          - Ref: EnvShort
                          - Ref: AWS::Region
                          - ScheduledActionUpCapacityMax
          - ',Schedule='
          - Fn::If:
              - ScheduledActionUpScheduleOverride
              - Ref: ScheduledActionUpSchedule
              - cron(00 06 * * ? *)
          - ',StartTime='
          - Fn::If:
              - ScheduledActionUpStartTimeOverride
              - Ref: ScheduledActionUpStartTime
              - Ref: AWS::NoValue
  SecurityGroups:
    Condition: NetworkModeAwsVpc
    Value:
      Fn::Sub:
        - Service=${SecurityGroupEcsService},${SecurityGroupName0}=${SecurityGroupValue0},${SecurityGroupName1}=${SecurityGroupValue1},${SecurityGroupName2}=${SecurityGroupValue2},${SecurityGroupName3}=${SecurityGroupValue3}
        - SecurityGroupEcsService:
            Ref: SecurityGroupEcsService
          SecurityGroupName0:
            Fn::Select:
              - 0
              - Fn::Split:
                  - ','
                  - Fn::If:
                      - SecurityGroupsOverride
                      - Ref: SecurityGroups
                      - BaseInstance,None,None,None
          SecurityGroupName1:
            Fn::Select:
              - 1
              - Fn::Split:
                  - ','
                  - Fn::If:
                      - SecurityGroupsOverride
                      - Ref: SecurityGroups
                      - BaseInstance,None,None,None
          SecurityGroupName2:
            Fn::Select:
              - 2
              - Fn::Split:
                  - ','
                  - Fn::If:
                      - SecurityGroupsOverride
                      - Ref: SecurityGroups
                      - BaseInstance,None,None,None
          SecurityGroupName3:
            Fn::Select:
              - 3
              - Fn::Split:
                  - ','
                  - Fn::If:
                      - SecurityGroupsOverride
                      - Ref: SecurityGroups
                      - BaseInstance,None,None,None
          SecurityGroupValue0:
            Fn::If:
              - SecurityGroup0
              - Fn::ImportValue:
                  Fn::Sub:
                    - SecurityGroup${ImportName}
                    - ImportName:
                        Fn::Select:
                          - 0
                          - Fn::Split:
                              - ','
                              - Fn::If:
                                  - SecurityGroupsOverride
                                  - Ref: SecurityGroups
                                  - BaseInstance,None,None,None
              - None
          SecurityGroupValue1:
            Fn::If:
              - SecurityGroup1
              - Fn::ImportValue:
                  Fn::Sub:
                    - SecurityGroup${ImportName}
                    - ImportName:
                        Fn::Select:
                          - 1
                          - Fn::Split:
                              - ','
                              - Fn::If:
                                  - SecurityGroupsOverride
                                  - Ref: SecurityGroups
                                  - BaseInstance,None,None,None
              - None
          SecurityGroupValue2:
            Fn::If:
              - SecurityGroup2
              - Fn::ImportValue:
                  Fn::Sub:
                    - SecurityGroup${ImportName}
                    - ImportName:
                        Fn::Select:
                          - 2
                          - Fn::Split:
                              - ','
                              - Fn::If:
                                  - SecurityGroupsOverride
                                  - Ref: SecurityGroups
                                  - BaseInstance,None,None,None
              - None
          SecurityGroupValue3:
            Fn::If:
              - SecurityGroup3
              - Fn::ImportValue:
                  Fn::Sub:
                    - SecurityGroup${ImportName}
                    - ImportName:
                        Fn::Select:
                          - 3
                          - Fn::Split:
                              - ','
                              - Fn::If:
                                  - SecurityGroupsOverride
                                  - Ref: SecurityGroups
                                  - BaseInstance,None,None,None
              - None
  ServiceBaseDeploymentConfigurationMaximumPercent:
    Value:
      Fn::If:
        - ServiceBaseDeploymentConfigurationMaximumPercentOverride
        - Ref: ServiceBaseDeploymentConfigurationMaximumPercent
        - 200
  ServiceBaseDeploymentConfigurationMinimumHealthyPercent:
    Value:
      Fn::If:
        - ServiceBaseDeploymentConfigurationMinimumHealthyPercentOverride
        - Ref: ServiceBaseDeploymentConfigurationMinimumHealthyPercent
        - 100
  StackType:
    Value: ecs
Parameters:
  CapacityDesired:
    Default: ''
    Description: Desired Autoscaling Capacity - empty for default based on env/role
    Type: String
  CapacityMax:
    Default: ''
    Description: Max Autoscaling Capacity - empty for default based on env/role
    Type: String
  CapacityMin:
    Default: ''
    Description: Min Autoscaling Capacity - empty for default based on env/role
    Type: String
  ClusterStack:
    Default: ''
    Description: Cluster Stack Name used to launch service on - empty for default
      based on env/role
    Type: String
  ContainerDefinitions1Command:
    Default: ''
    Description: Command to execute
    Type: CommaDelimitedList
  ContainerDefinitions1Cpu:
    Default: ''
    Description: Cpu Share - empty for mapped value
    Type: String
  ContainerDefinitions1EnvironmentAWSDEFAULTREGIONValue:
    Default: ''
    Description: AWS_DEFAULT_REGION - empty for default based on env/role
    Type: String
  ContainerDefinitions1Memory:
    Default: ''
    Description: Memory hard limit - empty for mapped value
    Type: String
  ContainerDefinitions1MemoryReservation:
    Default: ''
    Description: Memory soft limit - empty for mapped value
    Type: String
  Cpu:
    AllowedValues:
      - ''
      - None
      - '128'
      - '256'
      - '384'
      - '512'
      - '640'
      - '768'
      - '896'
      - '1024'
      - '1152'
      - '1280'
      - '1408'
      - '1536'
      - '1664'
      - '1792'
      - '1920'
      - '2048'
      - '2176'
      - '2304'
      - '2432'
      - '2560'
      - '2688'
      - '2816'
      - '2944'
      - '3072'
      - '3200'
      - '3328'
      - '3456'
      - '3584'
      - '3712'
      - '3840'
      - '3968'
      - '4096'
    Default: ''
    Description: Cpu used by task - empty for default based on env/role
    Type: String
  DockerLabelLastUpdate:
    Default: ''
    Description: 'Use to force redeploy - can use: $(date +%F_%T)'
    Type: String
  Env:
    AllowedValues:
      - dev
      - stg
      - prod
    Default: dev
    Description: Environment
    Type: String
  EnvApp1Version:
    AllowedPattern: ^[a-zA-Z0-9-_.]*$
    Default: '1'
    Description: EnvApp1Version
    Type: String
  EnvRole:
    AllowedPattern: ^[a-zA-Z0-9-_.]*$
    Default: ''
    Description: Service Role
    Type: String
  EnvShort:
    AllowedValues:
      - dev
      - stg
      - prd
    Default: dev
    Description: Environment Short - NEVER CHANGE!
    Type: String
  EnvStackVersion:
    Default: '1'
    Description: Stack version, if changed with UpdateMode=Cfn triggers cfn-hup
    Type: String
  LaunchType:
    AllowedValues:
      - ''
      - EC2
      - FARGATE
    Default: ''
    Description: RunTask LaunchType - empty for default based on env/role
    Type: String
  LoadBalancerApplicationStack:
    Default: ''
    Description: LoadBalancer Application Stack to use - empty for default based on
      env/role
    Type: String
  LogDriver:
    AllowedValues:
      - ''
      - None
      - awslogs
      - fluentd
      - gelf
      - journald
      - json-file
      - splunk
      - syslog
    Default: ''
    Description: Log driver for task container - empty for default
    Type: String
  Memory:
    Default: ''
    Description: Memory used by task - empty for default based on env/role
    Type: String
  NetworkMode:
    AllowedValues:
      - ''
      - awsvpc
      - bridge
    Default: ''
    Description: Task NetworkMode - empty for default based on env/role
    Type: String
  ScheduledActionDownCapacityMax:
    Default: ''
    Description: k to keep current value - empty for mapped value
    Type: String
  ScheduledActionDownCapacityMin:
    Default: ''
    Description: k to keep current value - empty for mapped value
    Type: String
  ScheduledActionDownSchedule:
    Default: ''
    Description: empty for mapped value
    Type: String
  ScheduledActionDownStartTime:
    Default: ''
    Description: ''
    Type: String
  ScheduledActionUpCapacityMax:
    Default: ''
    Description: k to keep current value - empty for mapped value
    Type: String
  ScheduledActionUpCapacityMin:
    Default: ''
    Description: k to keep current value - empty for mapped value
    Type: String
  ScheduledActionUpSchedule:
    Default: ''
    Description: empty for mapped value
    Type: String
  ScheduledActionUpStartTime:
    Default: ''
    Description: ''
    Type: String
  SecurityGroups:
    AllowedPattern: ^(\w*,\w*){3}$
    Default: ',,,'
    Description: SecurityGroups List Extra - ,,, for default based on env/role
    Type: String
  ServiceBaseDeploymentConfigurationMaximumPercent:
    Default: ''
    Description: empty for mapped value
    Type: String
  ServiceBaseDeploymentConfigurationMinimumHealthyPercent:
    Default: ''
    Description: empty for mapped value
    Type: String
Resources:
  IAMPolicyParameterStore:
    Properties:
      PolicyDocument:
        Statement:
          - Action: kms:Decrypt
            Effect: Allow
            Resource:
              Fn::ImportValue: KeyParameterStore
          - Action: ssm:DescribeParameters
            Effect: Allow
            Resource:
              Fn::Sub: arn:aws:ssm:${AWS::Region}:${AWS::AccountId}:*
          - Action: ssm:GetParameters
            Effect: Allow
            Resource:
              - Fn::Sub: arn:aws:ssm:${AWS::Region}:${AWS::AccountId}:parameter/${EnvRole}/*
              - Fn::Sub: arn:aws:ssm:${AWS::Region}:${AWS::AccountId}:parameter/${AWS::StackName}/${EnvRole}/*
        Version: '2012-10-17'
      PolicyName: ParameterStore
      Roles:
        - Ref: RoleTask
    Type: AWS::IAM::Policy
  IAMPolicyUpdateStack:
    Properties:
      PolicyDocument:
        Statement:
          - Action:
              - s3:Get*
              - s3:List*
              - s3:Put*
              - iam:PassRole
              - iam:ListServerCertificates
              - iam:GetRole
              - iam:PutRolePolicy
              - iam:GetInstanceProfile
              - elasticloadbalancing:*
              - ec2:*
              - ecs:*
              - ecr:*
              - sqs:*
              - sns:*
              - cloudwatch:*
              - autoscaling:*
              - route53:*
              - codedeploy:*
              - acm:*
              - cloudformation:DescribeStack*
              - cloudformation:GetTemplate*
              - cloudformation:ListStackResources
              - cloudformation:ListExports
              - cloudformation:UpdateStack
              - cloudformation:CancelUpdateStack
              - cloudformation:ValidateTemplate
              - cloudfront:GetDistribution*
              - cloudfront:ListDistributions
              - cloudfront:ListCloudFrontOriginAccessIdentities
              - lambda:*
              - events:*
              - waf:GetWebACL
              - waf:ListWebACLs
            Effect: Allow
            Resource: '*'
          - Action: ssm:GetParameter*
            Effect: Allow
            Resource:
              - arn:aws:ssm:*:*:parameter/aws/service/ecs/optimized-ami/amazon-linux/recommended/image_id
              - arn:aws:ssm:*:*:parameter/aws/service/ecs/optimized-ami/amazon-linux-2/recommended/image_id
              - arn:aws:ssm:*:*:parameter/aws/service/ami-amazon-linux-latest/amzn2-ami-hvm-x86_64-gp2
        Version: '2012-10-17'
      PolicyName: UpdateStack
      Roles:
        - Ref: RoleTask
    Type: AWS::IAM::Policy
  LogsLogGroup:
    Properties:
      LogGroupName:
        Fn::Sub: /aws/ecs/${AWS::StackName}
      RetentionInDays: 30
    Type: AWS::Logs::LogGroup
  RoleTask:
    Properties:
      AssumeRolePolicyDocument:
        Statement:
          - Action: sts:AssumeRole
            Effect: Allow
            Principal:
              Service:
                - ecs-tasks.amazonaws.com
      ManagedPolicyArns:
        - Fn::ImportValue: IAMPolicyCloudWatchPutMetric
      Path: /
    Type: AWS::IAM::Role
  ScalableTarget:
    Properties:
      MaxCapacity:
        Fn::If:
          - CapacityMaxOverride
          - Ref: CapacityMax
          - Fn::FindInMap:
              - Ref: EnvShort
              - Ref: AWS::Region
              - CapacityMax
      MinCapacity:
        Fn::If:
          - CapacityMinOverride
          - Ref: CapacityMin
          - Fn::FindInMap:
              - Ref: EnvShort
              - Ref: AWS::Region
              - CapacityMin
      ResourceId:
        Fn::Sub:
          - service/${Cluster}/${Service.Name}
          - Cluster:
              Fn::ImportValue:
                Fn::Sub:
                  - Cluster-${ClusterStack}
                  - ClusterStack:
                      Fn::If:
                        - ClusterStackOverride
                        - Ref: ClusterStack
                        - ecs-a
      RoleARN:
        Fn::ImportValue: RoleEC2ContainerServiceAutoscale
      ScalableDimension: ecs:service:DesiredCount
      ScheduledActions:
        - Fn::If:
            - ScheduledActionDownDisable
            - Ref: AWS::NoValue
            - ScalableTargetAction:
                MaxCapacity:
                  Fn::If:
                    - ScheduledActionDownCapacityMaxSize
                    - Fn::If:
                        - CapacityMaxOverride
                        - Ref: CapacityMax
                        - Fn::FindInMap:
                            - Ref: EnvShort
                            - Ref: AWS::Region
                            - CapacityMax
                    - Fn::If:
                        - ScheduledActionDownKeepMaxSize
                        - Ref: AWS::NoValue
                        - Fn::If:
                            - ScheduledActionDownCapacityMaxOverride
                            - Ref: ScheduledActionDownCapacityMax
                            - k
                MinCapacity:
                  Fn::If:
                    - ScheduledActionDownCapacityMinSize
                    - Fn::If:
                        - CapacityMinOverride
                        - Ref: CapacityMin
                        - Fn::FindInMap:
                            - Ref: EnvShort
                            - Ref: AWS::Region
                            - CapacityMin
                    - Fn::If:
                        - ScheduledActionDownKeepMinSize
                        - Ref: AWS::NoValue
                        - Fn::If:
                            - ScheduledActionDownCapacityMinOverride
                            - Ref: ScheduledActionDownCapacityMin
                            - k
              Schedule:
                Fn::If:
                  - ScheduledActionDownScheduleOverride
                  - Ref: ScheduledActionDownSchedule
                  - cron(00 22 * * ? *)
              ScheduledActionName: ScheduledActionDown
              StartTime:
                Fn::If:
                  - ScheduledActionDownStartTimeOverride
                  - Ref: ScheduledActionDownStartTime
                  - Ref: AWS::NoValue
        - Fn::If:
            - ScheduledActionUpDisable
            - Ref: AWS::NoValue
            - ScalableTargetAction:
                MaxCapacity:
                  Fn::If:
                    - ScheduledActionUpCapacityMaxSize
                    - Fn::If:
                        - CapacityMaxOverride
                        - Ref: CapacityMax
                        - Fn::FindInMap:
                            - Ref: EnvShort
                            - Ref: AWS::Region
                            - CapacityMax
                    - Fn::If:
                        - ScheduledActionUpKeepMaxSize
                        - Ref: AWS::NoValue
                        - Fn::If:
                            - ScheduledActionUpCapacityMaxOverride
                            - Ref: ScheduledActionUpCapacityMax
                            - Fn::FindInMap:
                                - Ref: EnvShort
                                - Ref: AWS::Region
                                - ScheduledActionUpCapacityMax
                MinCapacity:
                  Fn::If:
                    - ScheduledActionUpCapacityMinSize
                    - Fn::If:
                        - CapacityMinOverride
                        - Ref: CapacityMin
                        - Fn::FindInMap:
                            - Ref: EnvShort
                            - Ref: AWS::Region
                            - CapacityMin
                    - Fn::If:
                        - ScheduledActionUpKeepMinSize
                        - Ref: AWS::NoValue
                        - Fn::If:
                            - ScheduledActionUpCapacityMinOverride
                            - Ref: ScheduledActionUpCapacityMin
                            - Fn::FindInMap:
                                - Ref: EnvShort
                                - Ref: AWS::Region
                                - ScheduledActionUpCapacityMin
              Schedule:
                Fn::If:
                  - ScheduledActionUpScheduleOverride
                  - Ref: ScheduledActionUpSchedule
                  - cron(00 06 * * ? *)
              ScheduledActionName: ScheduledActionUp
              StartTime:
                Fn::If:
                  - ScheduledActionUpStartTimeOverride
                  - Ref: ScheduledActionUpStartTime
                  - Ref: AWS::NoValue
      ServiceNamespace: ecs
    Type: AWS::ApplicationAutoScaling::ScalableTarget
  SecurityGroupEcsService:
    Condition: NetworkModeAwsVpc
    Properties:
      GroupDescription: Enable access to Service
      SecurityGroupIngress: []
      VpcId:
        Fn::ImportValue: VpcId
    Type: AWS::EC2::SecurityGroup
  Service:
    Properties:
      Cluster:
        Fn::ImportValue:
          Fn::Sub:
            - Cluster-${ClusterStack}
            - ClusterStack:
                Fn::If:
                  - ClusterStackOverride
                  - Ref: ClusterStack
                  - ecs-a
      DeploymentConfiguration:
        MaximumPercent:
          Fn::If:
            - ServiceBaseDeploymentConfigurationMaximumPercentOverride
            - Ref: ServiceBaseDeploymentConfigurationMaximumPercent
            - 200
        MinimumHealthyPercent:
          Fn::If:
            - ServiceBaseDeploymentConfigurationMinimumHealthyPercentOverride
            - Ref: ServiceBaseDeploymentConfigurationMinimumHealthyPercent
            - 100
      DesiredCount:
        Fn::If:
          - CapacityDesiredOverride
          - Ref: CapacityDesired
          - Fn::FindInMap:
              - Ref: EnvShort
              - Ref: AWS::Region
              - CapacityDesired
      HealthCheckGracePeriodSeconds:
        Ref: AWS::NoValue
      LaunchType:
        Fn::If:
          - LaunchTypeOverride
          - Ref: LaunchType
          - EC2
      NetworkConfiguration:
        Fn::If:
          - NetworkModeAwsVpc
          - AwsvpcConfiguration:
              SecurityGroups:
                - Fn::GetAtt:
                    - SecurityGroupEcsService
                    - GroupId
                - Fn::If:
                    - SecurityGroup0
                    - Fn::ImportValue:
                        Fn::Sub:
                          - SecurityGroup${ImportName}
                          - ImportName:
                              Fn::Select:
                                - 0
                                - Fn::Split:
                                    - ','
                                    - Fn::If:
                                        - SecurityGroupsOverride
                                        - Ref: SecurityGroups
                                        - BaseInstance,None,None,None
                    - Ref: AWS::NoValue
                - Fn::If:
                    - SecurityGroup1
                    - Fn::ImportValue:
                        Fn::Sub:
                          - SecurityGroup${ImportName}
                          - ImportName:
                              Fn::Select:
                                - 1
                                - Fn::Split:
                                    - ','
                                    - Fn::If:
                                        - SecurityGroupsOverride
                                        - Ref: SecurityGroups
                                        - BaseInstance,None,None,None
                    - Ref: AWS::NoValue
                - Fn::If:
                    - SecurityGroup2
                    - Fn::ImportValue:
                        Fn::Sub:
                          - SecurityGroup${ImportName}
                          - ImportName:
                              Fn::Select:
                                - 2
                                - Fn::Split:
                                    - ','
                                    - Fn::If:
                                        - SecurityGroupsOverride
                                        - Ref: SecurityGroups
                                        - BaseInstance,None,None,None
                    - Ref: AWS::NoValue
                - Fn::If:
                    - SecurityGroup3
                    - Fn::ImportValue:
                        Fn::Sub:
                          - SecurityGroup${ImportName}
                          - ImportName:
                              Fn::Select:
                                - 3
                                - Fn::Split:
                                    - ','
                                    - Fn::If:
                                        - SecurityGroupsOverride
                                        - Ref: SecurityGroups
                                        - BaseInstance,None,None,None
                    - Ref: AWS::NoValue
              Subnets:
                Fn::Split:
                  - ','
                  - Fn::ImportValue: SubnetsPrivate
          - Ref: AWS::NoValue
      PlacementStrategies:
        Fn::If:
          - LaunchTypeFarGate
          - Ref: AWS::NoValue
          - - Field: instanceId
              Type: spread
      PlatformVersion:
        Fn::If:
          - LaunchTypeFarGate
          - LATEST
          - Ref: AWS::NoValue
      SchedulingStrategy: REPLICA
      TaskDefinition:
        Ref: TaskDefinition
    Type: AWS::ECS::Service
  TaskDefinition:
    Properties:
      ContainerDefinitions:
        - Command:
            Fn::If:
              - ContainerDefinitions1CommandOverride
              - Ref: ContainerDefinitions1Command
              - Ref: AWS::NoValue
          Cpu:
            Fn::If:
              - CpuTask
              - Fn::If:
                  - CpuOverride
                  - Ref: Cpu
                  - None
              - Fn::If:
                  - ContainerDefinitions1CpuOverride
                  - Ref: ContainerDefinitions1Cpu
                  - Fn::FindInMap:
                      - Ref: EnvShort
                      - Ref: AWS::Region
                      - ContainerDefinitions1Cpu
          DockerLabels:
            LastUpdate:
              Ref: DockerLabelLastUpdate
          Environment:
            - Name: Env
              Value:
                Ref: Env
            - Name: EnvAbbr
              Value:
                Ref: EnvShort
            - Name: EnvRole
              Value:
                Ref: EnvRole
            - Name: EnvStackName
              Value:
                Ref: AWS::StackName
            - Name: EnvRegion
              Value:
                Ref: AWS::Region
            - Name: EnvBrand
              Value: numenor.arda
            - Name: EnvClusterStackName
              Value:
                Fn::If:
                  - ClusterStackOverride
                  - Ref: ClusterStack
                  - ecs-a
            - Name: NODE_ENV
              Value: production
            - Name: AWS_DEFAULT_REGION
              Value:
                Ref: AWS::Region
          Essential: 'true'
          Image:
            Fn::Sub:
              - ${EcrAccount}.dkr.ecr.${AWS::Region}.amazonaws.com/${RepoName}:${EnvApp1Version}
              - EcrAccount:
                  Fn::FindInMap:
                    - Ref: EnvShort
                    - Ref: AWS::Region
                    - EcrAccount
                RepoName:
                  Fn::Sub:
                    - ${BrandRegion}.${Brand}.services.buildkite
                    - Brand: numenor
                      BrandRegion: arda
          LogConfiguration:
            Fn::If:
              - LogConfiguration
              - LogDriver:
                  Fn::If:
                    - LogDriverOverride
                    - Ref: LogDriver
                    - awslogs
                Options:
                  awslogs-group:
                    Ref: LogsLogGroup
                  awslogs-region:
                    Ref: AWS::Region
                  awslogs-stream-prefix:
                    Ref: AWS::StackName
              - Ref: AWS::NoValue
          Memory:
            Fn::If:
              - LaunchTypeFarGate
              - Fn::If:
                  - MemoryOverride
                  - Ref: Memory
                  - 512
              - Fn::If:
                  - ContainerDefinitions1MemoryOverride
                  - Ref: ContainerDefinitions1Memory
                  - 128
          MemoryReservation:
            Fn::If:
              - ContainerDefinitions1MemoryReservationOverride
              - Ref: ContainerDefinitions1MemoryReservation
              - 64
          MountPoints:
            - ContainerPath: /var/run/docker.sock
              ReadOnly: 'false'
              SourceVolume: DockerSock
          Name:
            Ref: EnvRole
          PortMappings:
            Fn::If:
              - ContainerDefinitions1ContainerPort
              - - ContainerPort: 0
                  HostPort:
                    Fn::If:
                      - NetworkModeAwsVpc
                      - 0
                      - Fn::If:
                          - ContainerDefinitions1HostPort
                          - None
                          - 0
                  Protocol: tcp
              - Ref: AWS::NoValue
      Cpu:
        Fn::If:
          - CpuTask
          - Fn::If:
              - CpuOverride
              - Ref: Cpu
              - None
          - Ref: AWS::NoValue
      ExecutionRoleArn:
        Fn::If:
          - LaunchTypeFarGate
          - Fn::ImportValue: RoleECSTaskExecution
          - Ref: AWS::NoValue
      Memory:
        Fn::If:
          - LaunchTypeFarGate
          - Fn::If:
              - MemoryOverride
              - Ref: Memory
              - 512
          - Ref: AWS::NoValue
      NetworkMode:
        Fn::If:
          - NetworkModeAwsVpc
          - awsvpc
          - Fn::If:
              - NetworkModeOverride
              - Ref: NetworkMode
              - bridge
      RequiresCompatibilities:
        Fn::If:
          - LaunchTypeFarGate
          - - EC2
            - FARGATE
          - - EC2
      TaskRoleArn:
        Ref: RoleTask
      Volumes:
        - Host:
            SourcePath: /var/run/docker.sock
          Name: DockerSock
    Type: AWS::ECS::TaskDefinition

