AWSTemplateFormatVersion: '2010-09-09'
Conditions:
  ASGLifecycleHookECSDrainInstanceHeartbeatTimeoutOverride:
    Fn::Not:
      - Fn::Equals:
          - Ref: ASGLifecycleHookECSDrainInstanceHeartbeatTimeout
          - ''
  AutoScalingGroupBaseHealthCheckGracePeriodOverride:
    Fn::Not:
      - Fn::Equals:
          - Ref: AutoScalingGroupBaseHealthCheckGracePeriod
          - ''
  AutoScalingScalingPolicyCustom:
    Fn::Or:
      - Fn::And:
          - Condition: AutoScalingScalingPolicyCustomTargetTrackingConfigurationTargetValueOverride
          - Fn::Not:
              - Fn::Equals:
                  - Ref: AutoScalingScalingPolicyCustomTargetTrackingConfigurationTargetValue
                  - '0'
      - Fn::And:
          - Fn::Not:
              - Condition: AutoScalingScalingPolicyCustomTargetTrackingConfigurationTargetValueOverride
          - Fn::Not:
              - Fn::Equals:
                  - 60
                  - '0'
  AutoScalingScalingPolicyCustomTargetTrackingConfigurationCustomizedMetricSpecificationStatisticOverride:
    Fn::Not:
      - Fn::Equals:
          - Ref: AutoScalingScalingPolicyCustomTargetTrackingConfigurationCustomizedMetricSpecificationStatistic
          - ''
  AutoScalingScalingPolicyCustomTargetTrackingConfigurationTargetValueOverride:
    Fn::Not:
      - Fn::Equals:
          - Ref: AutoScalingScalingPolicyCustomTargetTrackingConfigurationTargetValue
          - ''
  BaseRegion:
    Fn::Equals:
      - eu-west-1
      - Ref: AWS::Region
  CapacityDesiredOverride:
    Fn::Not:
      - Fn::Equals:
          - Ref: CapacityDesired
          - ''
  CapacityMaxOverride:
    Fn::Not:
      - Fn::Equals:
          - Ref: CapacityMax
          - ''
  CapacityMinOverride:
    Fn::Not:
      - Fn::Equals:
          - Ref: CapacityMin
          - ''
  CloudFormationInit:
    Fn::Equals:
      - Ref: UpdateMode
      - Cfn
  CloudWatchAgent:
    Fn::Or:
      - Fn::And:
          - Condition: CloudWatchAgentOverride
          - Fn::Not:
              - Fn::Equals:
                  - Ref: CloudWatchAgent
                  - None
      - Fn::And:
          - Fn::Not:
              - Condition: CloudWatchAgentOverride
          - Fn::Not:
              - Fn::Equals:
                  - None
                  - None
  CloudWatchAgentOverride:
    Fn::Not:
      - Fn::Equals:
          - Ref: CloudWatchAgent
          - ''
  DoNotSignal:
    Fn::And:
      - Condition: RollingUpdate
      - Fn::Equals:
          - Ref: DoNotSignal
          - 'True'
  EfsMounts:
    Fn::Not:
      - Fn::Equals:
          - Fn::Select:
              - '0'
              - Ref: EfsMounts
          - ''
  GPUInstance:
    Fn::Equals:
      - Ref: GPUInstance
      - 'True'
  GPUInstanceOverride:
    Fn::Not:
      - Fn::Equals:
          - Ref: GPUInstance
          - ''
  InstaceEphemeral0:
    Fn::Or:
      - Fn::And:
          - Condition: LaunchTemplateDataInstanceTypeOverride
          - Fn::Equals:
              - Fn::FindInMap:
                  - InstanceTypes
                  - Ref: LaunchTemplateDataInstanceType
                  - InstaceEphemeral0
              - '1'
      - Fn::And:
          - Fn::Not:
              - Condition: LaunchTemplateDataInstanceTypeOverride
          - Fn::Equals:
              - Fn::FindInMap:
                  - InstanceTypes
                  - Fn::FindInMap:
                      - Ref: EnvShort
                      - Ref: AWS::Region
                      - LaunchTemplateDataInstanceType
                  - InstaceEphemeral0
              - '1'
  InstaceEphemeral1:
    Fn::Or:
      - Fn::And:
          - Condition: LaunchTemplateDataInstanceTypeOverride
          - Fn::Equals:
              - Fn::FindInMap:
                  - InstanceTypes
                  - Ref: LaunchTemplateDataInstanceType
                  - InstaceEphemeral1
              - '1'
      - Fn::And:
          - Fn::Not:
              - Condition: LaunchTemplateDataInstanceTypeOverride
          - Fn::Equals:
              - Fn::FindInMap:
                  - InstanceTypes
                  - Fn::FindInMap:
                      - Ref: EnvShort
                      - Ref: AWS::Region
                      - LaunchTemplateDataInstanceType
                  - InstaceEphemeral1
              - '1'
  InstaceEphemeral2:
    Fn::Or:
      - Fn::And:
          - Condition: LaunchTemplateDataInstanceTypeOverride
          - Fn::Equals:
              - Fn::FindInMap:
                  - InstanceTypes
                  - Ref: LaunchTemplateDataInstanceType
                  - InstaceEphemeral2
              - '1'
      - Fn::And:
          - Fn::Not:
              - Condition: LaunchTemplateDataInstanceTypeOverride
          - Fn::Equals:
              - Fn::FindInMap:
                  - InstanceTypes
                  - Fn::FindInMap:
                      - Ref: EnvShort
                      - Ref: AWS::Region
                      - LaunchTemplateDataInstanceType
                  - InstaceEphemeral2
              - '1'
  LaunchTemplateDataBlockDeviceMappingsAdditionalStorage:
    Fn::Or:
      - Fn::And:
          - Condition: LaunchTemplateDataBlockDeviceMappingsAdditionalStorageEbsVolumeSizeOverride
          - Fn::Not:
              - Fn::Equals:
                  - Ref: LaunchTemplateDataBlockDeviceMappingsAdditionalStorageEbsVolumeSize
                  - '0'
      - Fn::And:
          - Fn::Not:
              - Condition: LaunchTemplateDataBlockDeviceMappingsAdditionalStorageEbsVolumeSizeOverride
          - Fn::Not:
              - Fn::Equals:
                  - 0
                  - '0'
  LaunchTemplateDataBlockDeviceMappingsAdditionalStorageEbsVolumeSizeOverride:
    Fn::Not:
      - Fn::Equals:
          - Ref: LaunchTemplateDataBlockDeviceMappingsAdditionalStorageEbsVolumeSize
          - ''
  LaunchTemplateDataBlockDeviceMappingsAdditionalStorageMount:
    Fn::And:
      - Condition: LaunchTemplateDataBlockDeviceMappingsAdditionalStorage
      - Fn::Not:
          - Fn::Equals:
              - true
              - None
  LaunchTemplateDataBlockDeviceMappingsXvdaEbsVolumeSizeOverride:
    Fn::Not:
      - Fn::Equals:
          - Ref: LaunchTemplateDataBlockDeviceMappingsXvdaEbsVolumeSize
          - ''
  LaunchTemplateDataImageIdLatest:
    Fn::Or:
      - Fn::And:
          - Condition: LaunchTemplateDataImageIdOverride
          - Fn::Equals:
              - Ref: LaunchTemplateDataImageId
              - latest
      - Fn::And:
          - Fn::Not:
              - Condition: LaunchTemplateDataImageIdOverride
          - Fn::Equals:
              - Fn::FindInMap:
                  - Ref: EnvShort
                  - Ref: AWS::Region
                  - LaunchTemplateDataImageId
              - latest
  LaunchTemplateDataImageIdOverride:
    Fn::Not:
      - Fn::Equals:
          - Ref: LaunchTemplateDataImageId
          - ''
  LaunchTemplateDataInstanceMarketOptionsSpotOptionsMaxPrice:
    Fn::Or:
      - Fn::And:
          - Condition: LaunchTemplateDataInstanceMarketOptionsSpotOptionsMaxPriceOverride
          - Fn::Not:
              - Fn::Equals:
                  - Ref: LaunchTemplateDataInstanceMarketOptionsSpotOptionsMaxPrice
                  - '0'
      - Fn::And:
          - Fn::Not:
              - Condition: LaunchTemplateDataInstanceMarketOptionsSpotOptionsMaxPriceOverride
          - Fn::Not:
              - Fn::Equals:
                  - '0'
                  - '0'
  LaunchTemplateDataInstanceMarketOptionsSpotOptionsMaxPriceOverride:
    Fn::Not:
      - Fn::Equals:
          - Ref: LaunchTemplateDataInstanceMarketOptionsSpotOptionsMaxPrice
          - ''
  LaunchTemplateDataInstanceTypeOverride:
    Fn::Not:
      - Fn::Equals:
          - Ref: LaunchTemplateDataInstanceType
          - default
  LaunchTemplateDataKeyNameOverride:
    Fn::Not:
      - Fn::Equals:
          - Ref: LaunchTemplateDataKeyName
          - ''
  RollingUpdate:
    Fn::Equals:
      - Ref: UpdateMode
      - Rolling
  ScheduledActionDown:
    Fn::Or:
      - Fn::And:
          - Condition: ScheduledActionDownRecurrenceOverride
          - Fn::Not:
              - Fn::Equals:
                  - Ref: ScheduledActionDownRecurrence
                  - None
      - Fn::And:
          - Fn::Not:
              - Condition: ScheduledActionDownRecurrenceOverride
          - Fn::Not:
              - Fn::Equals:
                  - 00 19 * * *
                  - None
  ScheduledActionDownCapacityDesiredSize:
    Fn::Or:
      - Fn::And:
          - Condition: ScheduledActionDownDesiredSizeOverride
          - Fn::Equals:
              - Ref: ScheduledActionDownDesiredSize
              - CapacityDesired
      - Fn::And:
          - Fn::Not:
              - Condition: ScheduledActionDownDesiredSizeOverride
          - Fn::Equals:
              - CapacityDesired
              - CapacityDesired
  ScheduledActionDownCapacityMaxSize:
    Fn::Or:
      - Fn::And:
          - Condition: ScheduledActionDownMaxSizeOverride
          - Fn::Equals:
              - Ref: ScheduledActionDownMaxSize
              - CapacityMax
      - Fn::And:
          - Fn::Not:
              - Condition: ScheduledActionDownMaxSizeOverride
          - Fn::Equals:
              - CapacityMax
              - CapacityMax
  ScheduledActionDownCapacityMinSize:
    Fn::Or:
      - Fn::And:
          - Condition: ScheduledActionDownMinSizeOverride
          - Fn::Equals:
              - Ref: ScheduledActionDownMinSize
              - CapacityMin
      - Fn::And:
          - Fn::Not:
              - Condition: ScheduledActionDownMinSizeOverride
          - Fn::Equals:
              - CapacityMin
              - CapacityMin
  ScheduledActionDownDesiredSizeOverride:
    Fn::Not:
      - Fn::Equals:
          - Ref: ScheduledActionDownDesiredSize
          - ''
  ScheduledActionDownKeepDesiredSize:
    Fn::Or:
      - Fn::And:
          - Condition: ScheduledActionDownDesiredSizeOverride
          - Fn::Equals:
              - Ref: ScheduledActionDownDesiredSize
              - k
      - Fn::And:
          - Fn::Not:
              - Condition: ScheduledActionDownDesiredSizeOverride
          - Fn::Equals:
              - CapacityDesired
              - k
  ScheduledActionDownKeepMaxSize:
    Fn::Or:
      - Fn::And:
          - Condition: ScheduledActionDownMaxSizeOverride
          - Fn::Equals:
              - Ref: ScheduledActionDownMaxSize
              - k
      - Fn::And:
          - Fn::Not:
              - Condition: ScheduledActionDownMaxSizeOverride
          - Fn::Equals:
              - CapacityMax
              - k
  ScheduledActionDownKeepMinSize:
    Fn::Or:
      - Fn::And:
          - Condition: ScheduledActionDownMinSizeOverride
          - Fn::Equals:
              - Ref: ScheduledActionDownMinSize
              - k
      - Fn::And:
          - Fn::Not:
              - Condition: ScheduledActionDownMinSizeOverride
          - Fn::Equals:
              - CapacityMin
              - k
  ScheduledActionDownMaxSizeOverride:
    Fn::Not:
      - Fn::Equals:
          - Ref: ScheduledActionDownMaxSize
          - ''
  ScheduledActionDownMinSizeOverride:
    Fn::Not:
      - Fn::Equals:
          - Ref: ScheduledActionDownMinSize
          - ''
  ScheduledActionDownRecurrenceOverride:
    Fn::Not:
      - Fn::Equals:
          - Ref: ScheduledActionDownRecurrence
          - ''
  ScheduledActionDownStartTimeOverride:
    Fn::Not:
      - Fn::Equals:
          - Ref: ScheduledActionDownStartTime
          - ''
  ScheduledActionRotate:
    Fn::Or:
      - Fn::And:
          - Condition: ScheduledActionRotateRecurrenceOverride
          - Fn::Not:
              - Fn::Equals:
                  - Ref: ScheduledActionRotateRecurrence
                  - None
      - Fn::And:
          - Fn::Not:
              - Condition: ScheduledActionRotateRecurrenceOverride
          - Fn::Not:
              - Fn::Equals:
                  - 45 5 * * *
                  - None
  ScheduledActionRotateCapacityDesiredSize:
    Fn::Or:
      - Fn::And:
          - Condition: ScheduledActionRotateDesiredSizeOverride
          - Fn::Equals:
              - Ref: ScheduledActionRotateDesiredSize
              - CapacityDesired
      - Fn::And:
          - Fn::Not:
              - Condition: ScheduledActionRotateDesiredSizeOverride
          - Fn::Equals:
              - CapacityDesired
              - CapacityDesired
  ScheduledActionRotateCapacityMaxSize:
    Fn::Or:
      - Fn::And:
          - Condition: ScheduledActionRotateMaxSizeOverride
          - Fn::Equals:
              - Ref: ScheduledActionRotateMaxSize
              - CapacityMax
      - Fn::And:
          - Fn::Not:
              - Condition: ScheduledActionRotateMaxSizeOverride
          - Fn::Equals:
              - CapacityMax
              - CapacityMax
  ScheduledActionRotateCapacityMinSize:
    Fn::Or:
      - Fn::And:
          - Condition: ScheduledActionRotateMinSizeOverride
          - Fn::Equals:
              - Ref: ScheduledActionRotateMinSize
              - CapacityMin
      - Fn::And:
          - Fn::Not:
              - Condition: ScheduledActionRotateMinSizeOverride
          - Fn::Equals:
              - CapacityMin
              - CapacityMin
  ScheduledActionRotateDesiredSizeOverride:
    Fn::Not:
      - Fn::Equals:
          - Ref: ScheduledActionRotateDesiredSize
          - ''
  ScheduledActionRotateKeepDesiredSize:
    Fn::Or:
      - Fn::And:
          - Condition: ScheduledActionRotateDesiredSizeOverride
          - Fn::Equals:
              - Ref: ScheduledActionRotateDesiredSize
              - k
      - Fn::And:
          - Fn::Not:
              - Condition: ScheduledActionRotateDesiredSizeOverride
          - Fn::Equals:
              - CapacityDesired
              - k
  ScheduledActionRotateKeepMaxSize:
    Fn::Or:
      - Fn::And:
          - Condition: ScheduledActionRotateMaxSizeOverride
          - Fn::Equals:
              - Ref: ScheduledActionRotateMaxSize
              - k
      - Fn::And:
          - Fn::Not:
              - Condition: ScheduledActionRotateMaxSizeOverride
          - Fn::Equals:
              - CapacityMax
              - k
  ScheduledActionRotateKeepMinSize:
    Fn::Or:
      - Fn::And:
          - Condition: ScheduledActionRotateMinSizeOverride
          - Fn::Equals:
              - Ref: ScheduledActionRotateMinSize
              - k
      - Fn::And:
          - Fn::Not:
              - Condition: ScheduledActionRotateMinSizeOverride
          - Fn::Equals:
              - CapacityMin
              - k
  ScheduledActionRotateMaxSizeOverride:
    Fn::Not:
      - Fn::Equals:
          - Ref: ScheduledActionRotateMaxSize
          - ''
  ScheduledActionRotateMinSizeOverride:
    Fn::Not:
      - Fn::Equals:
          - Ref: ScheduledActionRotateMinSize
          - ''
  ScheduledActionRotateRecurrenceOverride:
    Fn::Not:
      - Fn::Equals:
          - Ref: ScheduledActionRotateRecurrence
          - ''
  ScheduledActionRotateStartTimeOverride:
    Fn::Not:
      - Fn::Equals:
          - Ref: ScheduledActionRotateStartTime
          - ''
  ScheduledActionUp:
    Fn::Or:
      - Fn::And:
          - Condition: ScheduledActionUpRecurrenceOverride
          - Fn::Not:
              - Fn::Equals:
                  - Ref: ScheduledActionUpRecurrence
                  - None
      - Fn::And:
          - Fn::Not:
              - Condition: ScheduledActionUpRecurrenceOverride
          - Fn::Not:
              - Fn::Equals:
                  - 30 08 * * mon-fri
                  - None
  ScheduledActionUpCapacityDesiredSize:
    Fn::Or:
      - Fn::And:
          - Condition: ScheduledActionUpDesiredSizeOverride
          - Fn::Equals:
              - Ref: ScheduledActionUpDesiredSize
              - CapacityDesired
      - Fn::And:
          - Fn::Not:
              - Condition: ScheduledActionUpDesiredSizeOverride
          - Fn::Equals:
              - CapacityDesired
              - CapacityDesired
  ScheduledActionUpCapacityMaxSize:
    Fn::Or:
      - Fn::And:
          - Condition: ScheduledActionUpMaxSizeOverride
          - Fn::Equals:
              - Ref: ScheduledActionUpMaxSize
              - CapacityMax
      - Fn::And:
          - Fn::Not:
              - Condition: ScheduledActionUpMaxSizeOverride
          - Fn::Equals:
              - CapacityMax
              - CapacityMax
  ScheduledActionUpCapacityMinSize:
    Fn::Or:
      - Fn::And:
          - Condition: ScheduledActionUpMinSizeOverride
          - Fn::Equals:
              - Ref: ScheduledActionUpMinSize
              - CapacityMin
      - Fn::And:
          - Fn::Not:
              - Condition: ScheduledActionUpMinSizeOverride
          - Fn::Equals:
              - CapacityMin
              - CapacityMin
  ScheduledActionUpDesiredSizeOverride:
    Fn::Not:
      - Fn::Equals:
          - Ref: ScheduledActionUpDesiredSize
          - ''
  ScheduledActionUpKeepDesiredSize:
    Fn::Or:
      - Fn::And:
          - Condition: ScheduledActionUpDesiredSizeOverride
          - Fn::Equals:
              - Ref: ScheduledActionUpDesiredSize
              - k
      - Fn::And:
          - Fn::Not:
              - Condition: ScheduledActionUpDesiredSizeOverride
          - Fn::Equals:
              - CapacityDesired
              - k
  ScheduledActionUpKeepMaxSize:
    Fn::Or:
      - Fn::And:
          - Condition: ScheduledActionUpMaxSizeOverride
          - Fn::Equals:
              - Ref: ScheduledActionUpMaxSize
              - k
      - Fn::And:
          - Fn::Not:
              - Condition: ScheduledActionUpMaxSizeOverride
          - Fn::Equals:
              - CapacityMax
              - k
  ScheduledActionUpKeepMinSize:
    Fn::Or:
      - Fn::And:
          - Condition: ScheduledActionUpMinSizeOverride
          - Fn::Equals:
              - Ref: ScheduledActionUpMinSize
              - k
      - Fn::And:
          - Fn::Not:
              - Condition: ScheduledActionUpMinSizeOverride
          - Fn::Equals:
              - CapacityMin
              - k
  ScheduledActionUpMaxSizeOverride:
    Fn::Not:
      - Fn::Equals:
          - Ref: ScheduledActionUpMaxSize
          - ''
  ScheduledActionUpMinSizeOverride:
    Fn::Not:
      - Fn::Equals:
          - Ref: ScheduledActionUpMinSize
          - ''
  ScheduledActionUpRecurrenceOverride:
    Fn::Not:
      - Fn::Equals:
          - Ref: ScheduledActionUpRecurrence
          - ''
  ScheduledActionUpStartTimeOverride:
    Fn::Not:
      - Fn::Equals:
          - Ref: ScheduledActionUpStartTime
          - ''
  SecurityGroup0:
    Fn::Not:
      - Fn::Or:
          - Fn::And:
              - Condition: SecurityGroupsOverride
              - Fn::Equals:
                  - Fn::Select:
                      - 0
                      - Fn::Split:
                          - ','
                          - Ref: SecurityGroups
                  - None
          - Fn::And:
              - Fn::Not:
                  - Condition: SecurityGroupsOverride
              - Fn::Equals:
                  - Fn::Select:
                      - 0
                      - Fn::Split:
                          - ','
                          - BaseInstance,None,None,None
                  - None
  SecurityGroup1:
    Fn::Not:
      - Fn::Or:
          - Fn::And:
              - Condition: SecurityGroupsOverride
              - Fn::Equals:
                  - Fn::Select:
                      - 1
                      - Fn::Split:
                          - ','
                          - Ref: SecurityGroups
                  - None
          - Fn::And:
              - Fn::Not:
                  - Condition: SecurityGroupsOverride
              - Fn::Equals:
                  - Fn::Select:
                      - 1
                      - Fn::Split:
                          - ','
                          - BaseInstance,None,None,None
                  - None
  SecurityGroup2:
    Fn::Not:
      - Fn::Or:
          - Fn::And:
              - Condition: SecurityGroupsOverride
              - Fn::Equals:
                  - Fn::Select:
                      - 2
                      - Fn::Split:
                          - ','
                          - Ref: SecurityGroups
                  - None
          - Fn::And:
              - Fn::Not:
                  - Condition: SecurityGroupsOverride
              - Fn::Equals:
                  - Fn::Select:
                      - 2
                      - Fn::Split:
                          - ','
                          - BaseInstance,None,None,None
                  - None
  SecurityGroup3:
    Fn::Not:
      - Fn::Or:
          - Fn::And:
              - Condition: SecurityGroupsOverride
              - Fn::Equals:
                  - Fn::Select:
                      - 3
                      - Fn::Split:
                          - ','
                          - Ref: SecurityGroups
                  - None
          - Fn::And:
              - Fn::Not:
                  - Condition: SecurityGroupsOverride
              - Fn::Equals:
                  - Fn::Select:
                      - 3
                      - Fn::Split:
                          - ','
                          - BaseInstance,None,None,None
                  - None
  SecurityGroupsOverride:
    Fn::Not:
      - Fn::Equals:
          - Ref: SecurityGroups
          - ',,,'
  Spot:
    Fn::Or:
      - Condition: SpotAuto
      - Condition: LaunchTemplateDataInstanceMarketOptionsSpotOptionsMaxPrice
  SpotAuto:
    Fn::Or:
      - Fn::And:
          - Condition: SpotAutoOverride
          - Fn::Not:
              - Fn::Equals:
                  - Ref: SpotAuto
                  - None
      - Fn::And:
          - Fn::Not:
              - Condition: SpotAutoOverride
          - Fn::Not:
              - Fn::Equals:
                  - None
                  - None
  SpotAutoAllowedInstances:
    Fn::And:
      - Condition: SpotAuto
      - Fn::Or:
          - Fn::And:
              - Condition: SpotAutoAllowedInstancesOverride
              - Fn::Not:
                  - Fn::Equals:
                      - Ref: SpotAutoAllowedInstances
                      - None
          - Fn::And:
              - Fn::Not:
                  - Condition: SpotAutoAllowedInstancesOverride
              - Fn::Not:
                  - Fn::Equals:
                      - None
                      - None
  SpotAutoAllowedInstancesOverride:
    Fn::Not:
      - Fn::Equals:
          - Ref: SpotAutoAllowedInstances
          - ''
  SpotAutoMinOnDemandNumber:
    Fn::And:
      - Condition: SpotAuto
      - Fn::Or:
          - Fn::And:
              - Condition: SpotAutoMinOnDemandNumberOverride
              - Fn::Not:
                  - Fn::Equals:
                      - Ref: SpotAutoMinOnDemandNumber
                      - None
          - Fn::And:
              - Fn::Not:
                  - Condition: SpotAutoMinOnDemandNumberOverride
              - Fn::Not:
                  - Fn::Equals:
                      - None
                      - None
  SpotAutoMinOnDemandNumberOverride:
    Fn::Not:
      - Fn::Equals:
          - Ref: SpotAutoMinOnDemandNumber
          - ''
  SpotAutoOverride:
    Fn::Not:
      - Fn::Equals:
          - Ref: SpotAuto
          - ''
  WillReplace:
    Fn::Equals:
      - Ref: UpdateMode
      - Replace
Description: ecs-cluster (Generated by awsibox 0.2.20) [ec2]
Mappings:
  InstanceTypes:
    a1.2xlarge:
      InstaceEphemeral0: '0'
      InstaceEphemeral1: '0'
      InstaceEphemeral2: '0'
    a1.4xlarge:
      InstaceEphemeral0: '0'
      InstaceEphemeral1: '0'
      InstaceEphemeral2: '0'
    a1.large:
      InstaceEphemeral0: '0'
      InstaceEphemeral1: '0'
      InstaceEphemeral2: '0'
    a1.medium:
      InstaceEphemeral0: '0'
      InstaceEphemeral1: '0'
      InstaceEphemeral2: '0'
    a1.xlarge:
      InstaceEphemeral0: '0'
      InstaceEphemeral1: '0'
      InstaceEphemeral2: '0'
    c3.2xlarge:
      InstaceEphemeral0: '1'
      InstaceEphemeral1: '1'
      InstaceEphemeral2: '0'
    c3.4xlarge:
      InstaceEphemeral0: '1'
      InstaceEphemeral1: '1'
      InstaceEphemeral2: '0'
    c3.large:
      InstaceEphemeral0: '1'
      InstaceEphemeral1: '1'
      InstaceEphemeral2: '0'
    c3.xlarge:
      InstaceEphemeral0: '1'
      InstaceEphemeral1: '1'
      InstaceEphemeral2: '0'
    c4.2xlarge:
      InstaceEphemeral0: '0'
      InstaceEphemeral1: '0'
      InstaceEphemeral2: '0'
    c4.4xlarge:
      InstaceEphemeral0: '0'
      InstaceEphemeral1: '0'
      InstaceEphemeral2: '0'
    c4.large:
      InstaceEphemeral0: '0'
      InstaceEphemeral1: '0'
      InstaceEphemeral2: '0'
    c4.xlarge:
      InstaceEphemeral0: '0'
      InstaceEphemeral1: '0'
      InstaceEphemeral2: '0'
    c5.12xlarge:
      InstaceEphemeral0: '0'
      InstaceEphemeral1: '0'
      InstaceEphemeral2: '0'
    c5.18xlarge:
      InstaceEphemeral0: '0'
      InstaceEphemeral1: '0'
      InstaceEphemeral2: '0'
    c5.24xlarge:
      InstaceEphemeral0: '0'
      InstaceEphemeral1: '0'
      InstaceEphemeral2: '0'
    c5.2xlarge:
      InstaceEphemeral0: '0'
      InstaceEphemeral1: '0'
      InstaceEphemeral2: '0'
    c5.4xlarge:
      InstaceEphemeral0: '0'
      InstaceEphemeral1: '0'
      InstaceEphemeral2: '0'
    c5.9xlarge:
      InstaceEphemeral0: '0'
      InstaceEphemeral1: '0'
      InstaceEphemeral2: '0'
    c5.large:
      InstaceEphemeral0: '0'
      InstaceEphemeral1: '0'
      InstaceEphemeral2: '0'
    c5.xlarge:
      InstaceEphemeral0: '0'
      InstaceEphemeral1: '0'
      InstaceEphemeral2: '0'
    c5a.12xlarge:
      InstaceEphemeral0: '0'
      InstaceEphemeral1: '0'
      InstaceEphemeral2: '0'
    c5a.16xlarge:
      InstaceEphemeral0: '0'
      InstaceEphemeral1: '0'
      InstaceEphemeral2: '0'
    c5a.24xlarge:
      InstaceEphemeral0: '0'
      InstaceEphemeral1: '0'
      InstaceEphemeral2: '0'
    c5a.2xlarge:
      InstaceEphemeral0: '0'
      InstaceEphemeral1: '0'
      InstaceEphemeral2: '0'
    c5a.4xlarge:
      InstaceEphemeral0: '0'
      InstaceEphemeral1: '0'
      InstaceEphemeral2: '0'
    c5a.8xlarge:
      InstaceEphemeral0: '0'
      InstaceEphemeral1: '0'
      InstaceEphemeral2: '0'
    c5a.large:
      InstaceEphemeral0: '0'
      InstaceEphemeral1: '0'
      InstaceEphemeral2: '0'
    c5a.xlarge:
      InstaceEphemeral0: '0'
      InstaceEphemeral1: '0'
      InstaceEphemeral2: '0'
    d2.2xlarge:
      InstaceEphemeral0: '1'
      InstaceEphemeral1: '1'
      InstaceEphemeral2: '1'
    d2.4xlarge:
      InstaceEphemeral0: '1'
      InstaceEphemeral1: '1'
      InstaceEphemeral2: '1'
    d2.xlarge:
      InstaceEphemeral0: '1'
      InstaceEphemeral1: '1'
      InstaceEphemeral2: '1'
    default:
      InstaceEphemeral0: '0'
      InstaceEphemeral1: '0'
      InstaceEphemeral2: '0'
    g2.2xlarge:
      InstaceEphemeral0: '1'
      InstaceEphemeral1: '0'
      InstaceEphemeral2: '0'
    g3s.xlarge:
      InstaceEphemeral0: '0'
      InstaceEphemeral1: '0'
      InstaceEphemeral2: '0'
    i2.2xlarge:
      InstaceEphemeral0: '1'
      InstaceEphemeral1: '1'
      InstaceEphemeral2: '0'
    i2.4xlarge:
      InstaceEphemeral0: '1'
      InstaceEphemeral1: '1'
      InstaceEphemeral2: '1'
    i2.xlarge:
      InstaceEphemeral0: '1'
      InstaceEphemeral1: '0'
      InstaceEphemeral2: '0'
    m3.2xlarge:
      InstaceEphemeral0: '1'
      InstaceEphemeral1: '1'
      InstaceEphemeral2: '0'
    m3.large:
      InstaceEphemeral0: '1'
      InstaceEphemeral1: '0'
      InstaceEphemeral2: '0'
    m3.medium:
      InstaceEphemeral0: '1'
      InstaceEphemeral1: '0'
      InstaceEphemeral2: '0'
    m3.xlarge:
      InstaceEphemeral0: '1'
      InstaceEphemeral1: '1'
      InstaceEphemeral2: '0'
    m4.2xlarge:
      InstaceEphemeral0: '0'
      InstaceEphemeral1: '0'
      InstaceEphemeral2: '0'
    m4.4xlarge:
      InstaceEphemeral0: '0'
      InstaceEphemeral1: '0'
      InstaceEphemeral2: '0'
    m4.large:
      InstaceEphemeral0: '0'
      InstaceEphemeral1: '0'
      InstaceEphemeral2: '0'
    m4.xlarge:
      InstaceEphemeral0: '0'
      InstaceEphemeral1: '0'
      InstaceEphemeral2: '0'
    m5.12xlarge:
      InstaceEphemeral0: '0'
      InstaceEphemeral1: '0'
      InstaceEphemeral2: '0'
    m5.16xlarge:
      InstaceEphemeral0: '0'
      InstaceEphemeral1: '0'
      InstaceEphemeral2: '0'
    m5.24xlarge:
      InstaceEphemeral0: '0'
      InstaceEphemeral1: '0'
      InstaceEphemeral2: '0'
    m5.2xlarge:
      InstaceEphemeral0: '0'
      InstaceEphemeral1: '0'
      InstaceEphemeral2: '0'
    m5.4xlarge:
      InstaceEphemeral0: '0'
      InstaceEphemeral1: '0'
      InstaceEphemeral2: '0'
    m5.8xlarge:
      InstaceEphemeral0: '0'
      InstaceEphemeral1: '0'
      InstaceEphemeral2: '0'
    m5.large:
      InstaceEphemeral0: '0'
      InstaceEphemeral1: '0'
      InstaceEphemeral2: '0'
    m5.xlarge:
      InstaceEphemeral0: '0'
      InstaceEphemeral1: '0'
      InstaceEphemeral2: '0'
    m5a.12xlarge:
      InstaceEphemeral0: '0'
      InstaceEphemeral1: '0'
      InstaceEphemeral2: '0'
    m5a.16xlarge:
      InstaceEphemeral0: '0'
      InstaceEphemeral1: '0'
      InstaceEphemeral2: '0'
    m5a.24xlarge:
      InstaceEphemeral0: '0'
      InstaceEphemeral1: '0'
      InstaceEphemeral2: '0'
    m5a.2xlarge:
      InstaceEphemeral0: '0'
      InstaceEphemeral1: '0'
      InstaceEphemeral2: '0'
    m5a.4xlarge:
      InstaceEphemeral0: '0'
      InstaceEphemeral1: '0'
      InstaceEphemeral2: '0'
    m5a.8xlarge:
      InstaceEphemeral0: '0'
      InstaceEphemeral1: '0'
      InstaceEphemeral2: '0'
    m5a.large:
      InstaceEphemeral0: '0'
      InstaceEphemeral1: '0'
      InstaceEphemeral2: '0'
    m5a.xlarge:
      InstaceEphemeral0: '0'
      InstaceEphemeral1: '0'
      InstaceEphemeral2: '0'
    r3.2xlarge:
      InstaceEphemeral0: '1'
      InstaceEphemeral1: '0'
      InstaceEphemeral2: '0'
    r3.4xlarge:
      InstaceEphemeral0: '1'
      InstaceEphemeral1: '0'
      InstaceEphemeral2: '0'
    r3.large:
      InstaceEphemeral0: '1'
      InstaceEphemeral1: '0'
      InstaceEphemeral2: '0'
    r3.xlarge:
      InstaceEphemeral0: '1'
      InstaceEphemeral1: '0'
      InstaceEphemeral2: '0'
    r4.2xlarge:
      InstaceEphemeral0: '0'
      InstaceEphemeral1: '0'
      InstaceEphemeral2: '0'
    r4.4xlarge:
      InstaceEphemeral0: '0'
      InstaceEphemeral1: '0'
      InstaceEphemeral2: '0'
    r4.large:
      InstaceEphemeral0: '0'
      InstaceEphemeral1: '0'
      InstaceEphemeral2: '0'
    r4.xlarge:
      InstaceEphemeral0: '0'
      InstaceEphemeral1: '0'
      InstaceEphemeral2: '0'
    r5.12xlarge:
      InstaceEphemeral0: '0'
      InstaceEphemeral1: '0'
      InstaceEphemeral2: '0'
    r5.16xlarge:
      InstaceEphemeral0: '0'
      InstaceEphemeral1: '0'
      InstaceEphemeral2: '0'
    r5.24xlarge:
      InstaceEphemeral0: '0'
      InstaceEphemeral1: '0'
      InstaceEphemeral2: '0'
    r5.2xlarge:
      InstaceEphemeral0: '0'
      InstaceEphemeral1: '0'
      InstaceEphemeral2: '0'
    r5.4xlarge:
      InstaceEphemeral0: '0'
      InstaceEphemeral1: '0'
      InstaceEphemeral2: '0'
    r5.8xlarge:
      InstaceEphemeral0: '0'
      InstaceEphemeral1: '0'
      InstaceEphemeral2: '0'
    r5.large:
      InstaceEphemeral0: '0'
      InstaceEphemeral1: '0'
      InstaceEphemeral2: '0'
    r5.xlarge:
      InstaceEphemeral0: '0'
      InstaceEphemeral1: '0'
      InstaceEphemeral2: '0'
    r5a.12xlarge:
      InstaceEphemeral0: '0'
      InstaceEphemeral1: '0'
      InstaceEphemeral2: '0'
    r5a.16xlarge:
      InstaceEphemeral0: '0'
      InstaceEphemeral1: '0'
      InstaceEphemeral2: '0'
    r5a.24xlarge:
      InstaceEphemeral0: '0'
      InstaceEphemeral1: '0'
      InstaceEphemeral2: '0'
    r5a.2xlarge:
      InstaceEphemeral0: '0'
      InstaceEphemeral1: '0'
      InstaceEphemeral2: '0'
    r5a.4xlarge:
      InstaceEphemeral0: '0'
      InstaceEphemeral1: '0'
      InstaceEphemeral2: '0'
    r5a.8xlarge:
      InstaceEphemeral0: '0'
      InstaceEphemeral1: '0'
      InstaceEphemeral2: '0'
    r5a.large:
      InstaceEphemeral0: '0'
      InstaceEphemeral1: '0'
      InstaceEphemeral2: '0'
    r5a.xlarge:
      InstaceEphemeral0: '0'
      InstaceEphemeral1: '0'
      InstaceEphemeral2: '0'
    t2.2xlarge:
      InstaceEphemeral0: '0'
      InstaceEphemeral1: '0'
      InstaceEphemeral2: '0'
    t2.large:
      InstaceEphemeral0: '0'
      InstaceEphemeral1: '0'
      InstaceEphemeral2: '0'
    t2.medium:
      InstaceEphemeral0: '0'
      InstaceEphemeral1: '0'
      InstaceEphemeral2: '0'
    t2.micro:
      InstaceEphemeral0: '0'
      InstaceEphemeral1: '0'
      InstaceEphemeral2: '0'
    t2.nano:
      InstaceEphemeral0: '0'
      InstaceEphemeral1: '0'
      InstaceEphemeral2: '0'
    t2.small:
      InstaceEphemeral0: '0'
      InstaceEphemeral1: '0'
      InstaceEphemeral2: '0'
    t2.xlarge:
      InstaceEphemeral0: '0'
      InstaceEphemeral1: '0'
      InstaceEphemeral2: '0'
    t3.2xlarge:
      InstaceEphemeral0: '0'
      InstaceEphemeral1: '0'
      InstaceEphemeral2: '0'
    t3.large:
      InstaceEphemeral0: '0'
      InstaceEphemeral1: '0'
      InstaceEphemeral2: '0'
    t3.medium:
      InstaceEphemeral0: '0'
      InstaceEphemeral1: '0'
      InstaceEphemeral2: '0'
    t3.micro:
      InstaceEphemeral0: '0'
      InstaceEphemeral1: '0'
      InstaceEphemeral2: '0'
    t3.nano:
      InstaceEphemeral0: '0'
      InstaceEphemeral1: '0'
      InstaceEphemeral2: '0'
    t3.small:
      InstaceEphemeral0: '0'
      InstaceEphemeral1: '0'
      InstaceEphemeral2: '0'
    t3.xlarge:
      InstaceEphemeral0: '0'
      InstaceEphemeral1: '0'
      InstaceEphemeral2: '0'
    t3a.2xlarge:
      InstaceEphemeral0: '0'
      InstaceEphemeral1: '0'
      InstaceEphemeral2: '0'
    t3a.large:
      InstaceEphemeral0: '0'
      InstaceEphemeral1: '0'
      InstaceEphemeral2: '0'
    t3a.medium:
      InstaceEphemeral0: '0'
      InstaceEphemeral1: '0'
      InstaceEphemeral2: '0'
    t3a.micro:
      InstaceEphemeral0: '0'
      InstaceEphemeral1: '0'
      InstaceEphemeral2: '0'
    t3a.nano:
      InstaceEphemeral0: '0'
      InstaceEphemeral1: '0'
      InstaceEphemeral2: '0'
    t3a.small:
      InstaceEphemeral0: '0'
      InstaceEphemeral1: '0'
      InstaceEphemeral2: '0'
    t3a.xlarge:
      InstaceEphemeral0: '0'
      InstaceEphemeral1: '0'
      InstaceEphemeral2: '0'
    t4g.2xlarge:
      InstaceEphemeral0: '0'
      InstaceEphemeral1: '0'
      InstaceEphemeral2: '0'
    t4g.large:
      InstaceEphemeral0: '0'
      InstaceEphemeral1: '0'
      InstaceEphemeral2: '0'
    t4g.medium:
      InstaceEphemeral0: '0'
      InstaceEphemeral1: '0'
      InstaceEphemeral2: '0'
    t4g.micro:
      InstaceEphemeral0: '0'
      InstaceEphemeral1: '0'
      InstaceEphemeral2: '0'
    t4g.nano:
      InstaceEphemeral0: '0'
      InstaceEphemeral1: '0'
      InstaceEphemeral2: '0'
    t4g.small:
      InstaceEphemeral0: '0'
      InstaceEphemeral1: '0'
      InstaceEphemeral2: '0'
    t4g.xlarge:
      InstaceEphemeral0: '0'
      InstaceEphemeral1: '0'
      InstaceEphemeral2: '0'
  dev:
    eu-central-1:
      ASGLifecycleHookECSDrainInstanceHeartbeatTimeout: 900
      AlarmBackendExternal5XXEvaluationPeriods: 0
      AlarmBackendInternal5XXEvaluationPeriods: 0
      AlarmTargetEC2External5XXEvaluationPeriods: 0
      AlarmTargetEC2Internal5XXEvaluationPeriods: 0
      CapacityDesired: 1
      CapacityMax: 3
      CapacityMin: 1
      LaunchTemplateDataBlockDeviceMappingsXvdaEbsVolumeSize: 100
      LaunchTemplateDataImageId: ami-0e1d30823ff9f8459
      LaunchTemplateDataInstanceType: t3.large
    eu-west-1:
      ASGLifecycleHookECSDrainInstanceHeartbeatTimeout: 900
      AlarmBackendExternal5XXEvaluationPeriods: 0
      AlarmBackendInternal5XXEvaluationPeriods: 0
      AlarmTargetEC2External5XXEvaluationPeriods: 0
      AlarmTargetEC2Internal5XXEvaluationPeriods: 0
      CapacityDesired: 1
      CapacityMax: 3
      CapacityMin: 1
      LaunchTemplateDataBlockDeviceMappingsXvdaEbsVolumeSize: 100
      LaunchTemplateDataImageId: ami-02bf9e90a6e30dc74
      LaunchTemplateDataInstanceType: t3.large
    us-east-1:
      ASGLifecycleHookECSDrainInstanceHeartbeatTimeout: 900
      AlarmBackendExternal5XXEvaluationPeriods: 0
      AlarmBackendInternal5XXEvaluationPeriods: 0
      AlarmTargetEC2External5XXEvaluationPeriods: 0
      AlarmTargetEC2Internal5XXEvaluationPeriods: 0
      CapacityDesired: 1
      CapacityMax: 3
      CapacityMin: 1
      LaunchTemplateDataBlockDeviceMappingsXvdaEbsVolumeSize: 100
      LaunchTemplateDataImageId: ami-0b16d80945b1a9c7d
      LaunchTemplateDataInstanceType: t3.large
  prd:
    eu-central-1:
      ASGLifecycleHookECSDrainInstanceHeartbeatTimeout: 3600
      AlarmBackendExternal5XXEvaluationPeriods: 2
      AlarmBackendInternal5XXEvaluationPeriods: 2
      AlarmTargetEC2External5XXEvaluationPeriods: 2
      AlarmTargetEC2Internal5XXEvaluationPeriods: 2
      CapacityDesired: 0
      CapacityMax: 9
      CapacityMin: 0
      LaunchTemplateDataBlockDeviceMappingsXvdaEbsVolumeSize: 50
      LaunchTemplateDataImageId: ami-0e1d30823ff9f8459
      LaunchTemplateDataInstanceType: c5.xlarge
    eu-west-1:
      ASGLifecycleHookECSDrainInstanceHeartbeatTimeout: 3600
      AlarmBackendExternal5XXEvaluationPeriods: 2
      AlarmBackendInternal5XXEvaluationPeriods: 2
      AlarmTargetEC2External5XXEvaluationPeriods: 2
      AlarmTargetEC2Internal5XXEvaluationPeriods: 2
      CapacityDesired: 2
      CapacityMax: 9
      CapacityMin: 2
      LaunchTemplateDataBlockDeviceMappingsXvdaEbsVolumeSize: 50
      LaunchTemplateDataImageId: ami-02bf9e90a6e30dc74
      LaunchTemplateDataInstanceType: c5.xlarge
    us-east-1:
      ASGLifecycleHookECSDrainInstanceHeartbeatTimeout: 3600
      AlarmBackendExternal5XXEvaluationPeriods: 2
      AlarmBackendInternal5XXEvaluationPeriods: 2
      AlarmTargetEC2External5XXEvaluationPeriods: 2
      AlarmTargetEC2Internal5XXEvaluationPeriods: 2
      CapacityDesired: 2
      CapacityMax: 9
      CapacityMin: 2
      LaunchTemplateDataBlockDeviceMappingsXvdaEbsVolumeSize: 50
      LaunchTemplateDataImageId: ami-0b16d80945b1a9c7d
      LaunchTemplateDataInstanceType: c5.xlarge
  stg:
    eu-central-1:
      ASGLifecycleHookECSDrainInstanceHeartbeatTimeout: 900
      AlarmBackendExternal5XXEvaluationPeriods: 0
      AlarmBackendInternal5XXEvaluationPeriods: 0
      AlarmTargetEC2External5XXEvaluationPeriods: 0
      AlarmTargetEC2Internal5XXEvaluationPeriods: 0
      CapacityDesired: 1
      CapacityMax: 3
      CapacityMin: 1
      LaunchTemplateDataBlockDeviceMappingsXvdaEbsVolumeSize: 100
      LaunchTemplateDataImageId: ami-0e1d30823ff9f8459
      LaunchTemplateDataInstanceType: t3.large
    eu-west-1:
      ASGLifecycleHookECSDrainInstanceHeartbeatTimeout: 900
      AlarmBackendExternal5XXEvaluationPeriods: 0
      AlarmBackendInternal5XXEvaluationPeriods: 0
      AlarmTargetEC2External5XXEvaluationPeriods: 0
      AlarmTargetEC2Internal5XXEvaluationPeriods: 0
      CapacityDesired: 1
      CapacityMax: 3
      CapacityMin: 1
      LaunchTemplateDataBlockDeviceMappingsXvdaEbsVolumeSize: 100
      LaunchTemplateDataImageId: ami-02bf9e90a6e30dc74
      LaunchTemplateDataInstanceType: t3.large
    us-east-1:
      ASGLifecycleHookECSDrainInstanceHeartbeatTimeout: 900
      AlarmBackendExternal5XXEvaluationPeriods: 0
      AlarmBackendInternal5XXEvaluationPeriods: 0
      AlarmTargetEC2External5XXEvaluationPeriods: 0
      AlarmTargetEC2Internal5XXEvaluationPeriods: 0
      CapacityDesired: 1
      CapacityMax: 3
      CapacityMin: 1
      LaunchTemplateDataBlockDeviceMappingsXvdaEbsVolumeSize: 100
      LaunchTemplateDataImageId: ami-0b16d80945b1a9c7d
      LaunchTemplateDataInstanceType: t3.large
Outputs:
  AutoScalingScalingPolicy:
    Value:
      Fn::Sub:
        - Cpu${Statistic}:${Cpu}
        - Cpu:
            Fn::If:
              - AutoScalingScalingPolicyCustomTargetTrackingConfigurationTargetValueOverride
              - Ref: AutoScalingScalingPolicyCustomTargetTrackingConfigurationTargetValue
              - 60
          Statistic:
            Fn::If:
              - AutoScalingScalingPolicyCustomTargetTrackingConfigurationCustomizedMetricSpecificationStatisticOverride
              - Ref: AutoScalingScalingPolicyCustomTargetTrackingConfigurationCustomizedMetricSpecificationStatistic
              - Maximum
  BrandDomain:
    Value: numenor.arda
  Capacity:
    Value:
      Fn::Sub:
        - Desired=${CapacityDesired},Min=${CapacityMin},Max=${CapacityMax}
        - CapacityDesired:
            Fn::If:
              - CapacityDesiredOverride
              - Ref: CapacityDesired
              - Fn::FindInMap:
                  - Ref: EnvShort
                  - Ref: AWS::Region
                  - CapacityDesired
          CapacityMax:
            Fn::If:
              - CapacityMaxOverride
              - Ref: CapacityMax
              - Fn::FindInMap:
                  - Ref: EnvShort
                  - Ref: AWS::Region
                  - CapacityMax
          CapacityMin:
            Fn::If:
              - CapacityMinOverride
              - Ref: CapacityMin
              - Fn::FindInMap:
                  - Ref: EnvShort
                  - Ref: AWS::Region
                  - CapacityMin
  Cluster:
    Export:
      Name:
        Fn::Sub: Cluster-${AWS::StackName}
    Value:
      Ref: Cluster
  DoNotSignal:
    Value:
      Ref: DoNotSignal
  EfsMounts:
    Condition: EfsMounts
    Value:
      Fn::Join:
        - ','
        - Ref: EfsMounts
  Env:
    Value:
      Ref: Env
  EnvRole:
    Value:
      Ref: EnvRole
  EnvStackVersion:
    Value:
      Ref: EnvStackVersion
  LaunchTemplateDataBlockDeviceMappingsAdditionalStorageEbsVolumeSize:
    Value:
      Fn::If:
        - LaunchTemplateDataBlockDeviceMappingsAdditionalStorageEbsVolumeSizeOverride
        - Ref: LaunchTemplateDataBlockDeviceMappingsAdditionalStorageEbsVolumeSize
        - 0
  LaunchTemplateDataBlockDeviceMappingsXvdaEbsVolumeSize:
    Value:
      Fn::If:
        - LaunchTemplateDataBlockDeviceMappingsXvdaEbsVolumeSizeOverride
        - Ref: LaunchTemplateDataBlockDeviceMappingsXvdaEbsVolumeSize
        - Fn::FindInMap:
            - Ref: EnvShort
            - Ref: AWS::Region
            - LaunchTemplateDataBlockDeviceMappingsXvdaEbsVolumeSize
  LaunchTemplateDataImageId:
    Value:
      Fn::If:
        - LaunchTemplateDataImageIdLatest
        - Ref: LaunchTemplateDataImageIdLatest
        - Fn::If:
            - LaunchTemplateDataImageIdOverride
            - Ref: LaunchTemplateDataImageId
            - Fn::FindInMap:
                - Ref: EnvShort
                - Ref: AWS::Region
                - LaunchTemplateDataImageId
  LaunchTemplateDataInstanceType:
    Value:
      Fn::If:
        - LaunchTemplateDataInstanceTypeOverride
        - Ref: LaunchTemplateDataInstanceType
        - Fn::FindInMap:
            - Ref: EnvShort
            - Ref: AWS::Region
            - LaunchTemplateDataInstanceType
  LaunchTemplateDataKeyName:
    Value:
      Fn::If:
        - LaunchTemplateDataKeyNameOverride
        - Ref: LaunchTemplateDataKeyName
        - None
  ScheduledActionDown:
    Value:
      Fn::Join:
        - ''
        - - DesiredSize=
          - Fn::If:
              - ScheduledActionDownCapacityDesiredSize
              - Fn::If:
                  - CapacityDesiredOverride
                  - Ref: CapacityDesired
                  - Fn::FindInMap:
                      - Ref: EnvShort
                      - Ref: AWS::Region
                      - CapacityDesired
              - Fn::If:
                  - ScheduledActionDownKeepDesiredSize
                  - Ref: AWS::NoValue
                  - Fn::If:
                      - ScheduledActionDownDesiredSizeOverride
                      - Ref: ScheduledActionDownDesiredSize
                      - CapacityDesired
          - ',MinSize='
          - Fn::If:
              - ScheduledActionDownCapacityMinSize
              - Fn::If:
                  - CapacityMinOverride
                  - Ref: CapacityMin
                  - Fn::FindInMap:
                      - Ref: EnvShort
                      - Ref: AWS::Region
                      - CapacityMin
              - Fn::If:
                  - ScheduledActionDownKeepMinSize
                  - Ref: AWS::NoValue
                  - Fn::If:
                      - ScheduledActionDownMinSizeOverride
                      - Ref: ScheduledActionDownMinSize
                      - CapacityMin
          - ',MaxSize='
          - Fn::If:
              - ScheduledActionDownCapacityMaxSize
              - Fn::If:
                  - CapacityMaxOverride
                  - Ref: CapacityMax
                  - Fn::FindInMap:
                      - Ref: EnvShort
                      - Ref: AWS::Region
                      - CapacityMax
              - Fn::If:
                  - ScheduledActionDownKeepMaxSize
                  - Ref: AWS::NoValue
                  - Fn::If:
                      - ScheduledActionDownMaxSizeOverride
                      - Ref: ScheduledActionDownMaxSize
                      - CapacityMax
          - ',Recurrence='
          - Fn::If:
              - ScheduledActionDownRecurrenceOverride
              - Ref: ScheduledActionDownRecurrence
              - 00 19 * * *
          - ',StartTime='
          - Fn::If:
              - ScheduledActionDownStartTimeOverride
              - Ref: ScheduledActionDownStartTime
              - Ref: AWS::NoValue
  ScheduledActionRotate:
    Value:
      Fn::Join:
        - ''
        - - DesiredSize=
          - Fn::If:
              - ScheduledActionRotateCapacityDesiredSize
              - Fn::If:
                  - CapacityDesiredOverride
                  - Ref: CapacityDesired
                  - Fn::FindInMap:
                      - Ref: EnvShort
                      - Ref: AWS::Region
                      - CapacityDesired
              - Fn::If:
                  - ScheduledActionRotateKeepDesiredSize
                  - Ref: AWS::NoValue
                  - Fn::If:
                      - ScheduledActionRotateDesiredSizeOverride
                      - Ref: ScheduledActionRotateDesiredSize
                      - CapacityDesired
          - ',MinSize='
          - Fn::If:
              - ScheduledActionRotateCapacityMinSize
              - Fn::If:
                  - CapacityMinOverride
                  - Ref: CapacityMin
                  - Fn::FindInMap:
                      - Ref: EnvShort
                      - Ref: AWS::Region
                      - CapacityMin
              - Fn::If:
                  - ScheduledActionRotateKeepMinSize
                  - Ref: AWS::NoValue
                  - Fn::If:
                      - ScheduledActionRotateMinSizeOverride
                      - Ref: ScheduledActionRotateMinSize
                      - CapacityMin
          - ',MaxSize='
          - Fn::If:
              - ScheduledActionRotateCapacityMaxSize
              - Fn::If:
                  - CapacityMaxOverride
                  - Ref: CapacityMax
                  - Fn::FindInMap:
                      - Ref: EnvShort
                      - Ref: AWS::Region
                      - CapacityMax
              - Fn::If:
                  - ScheduledActionRotateKeepMaxSize
                  - Ref: AWS::NoValue
                  - Fn::If:
                      - ScheduledActionRotateMaxSizeOverride
                      - Ref: ScheduledActionRotateMaxSize
                      - CapacityMax
          - ',Recurrence='
          - Fn::If:
              - ScheduledActionRotateRecurrenceOverride
              - Ref: ScheduledActionRotateRecurrence
              - 45 5 * * *
          - ',StartTime='
          - Fn::If:
              - ScheduledActionRotateStartTimeOverride
              - Ref: ScheduledActionRotateStartTime
              - Ref: AWS::NoValue
  ScheduledActionUp:
    Value:
      Fn::Join:
        - ''
        - - DesiredSize=
          - Fn::If:
              - ScheduledActionUpCapacityDesiredSize
              - Fn::If:
                  - CapacityDesiredOverride
                  - Ref: CapacityDesired
                  - Fn::FindInMap:
                      - Ref: EnvShort
                      - Ref: AWS::Region
                      - CapacityDesired
              - Fn::If:
                  - ScheduledActionUpKeepDesiredSize
                  - Ref: AWS::NoValue
                  - Fn::If:
                      - ScheduledActionUpDesiredSizeOverride
                      - Ref: ScheduledActionUpDesiredSize
                      - CapacityDesired
          - ',MinSize='
          - Fn::If:
              - ScheduledActionUpCapacityMinSize
              - Fn::If:
                  - CapacityMinOverride
                  - Ref: CapacityMin
                  - Fn::FindInMap:
                      - Ref: EnvShort
                      - Ref: AWS::Region
                      - CapacityMin
              - Fn::If:
                  - ScheduledActionUpKeepMinSize
                  - Ref: AWS::NoValue
                  - Fn::If:
                      - ScheduledActionUpMinSizeOverride
                      - Ref: ScheduledActionUpMinSize
                      - CapacityMin
          - ',MaxSize='
          - Fn::If:
              - ScheduledActionUpCapacityMaxSize
              - Fn::If:
                  - CapacityMaxOverride
                  - Ref: CapacityMax
                  - Fn::FindInMap:
                      - Ref: EnvShort
                      - Ref: AWS::Region
                      - CapacityMax
              - Fn::If:
                  - ScheduledActionUpKeepMaxSize
                  - Ref: AWS::NoValue
                  - Fn::If:
                      - ScheduledActionUpMaxSizeOverride
                      - Ref: ScheduledActionUpMaxSize
                      - CapacityMax
          - ',Recurrence='
          - Fn::If:
              - ScheduledActionUpRecurrenceOverride
              - Ref: ScheduledActionUpRecurrence
              - 30 08 * * mon-fri
          - ',StartTime='
          - Fn::If:
              - ScheduledActionUpStartTimeOverride
              - Ref: ScheduledActionUpStartTime
              - Ref: AWS::NoValue
  SecurityGroups:
    Value:
      Fn::Sub:
        - Rules=${SecurityGroupInstancesRules},${SecurityGroupName0}=${SecurityGroupValue0},${SecurityGroupName1}=${SecurityGroupValue1},${SecurityGroupName2}=${SecurityGroupValue2},${SecurityGroupName3}=${SecurityGroupValue3}
        - SecurityGroupInstancesRules:
            Ref: SecurityGroupInstancesRules
          SecurityGroupName0:
            Fn::Select:
              - 0
              - Fn::Split:
                  - ','
                  - Fn::If:
                      - SecurityGroupsOverride
                      - Ref: SecurityGroups
                      - BaseInstance,None,None,None
          SecurityGroupName1:
            Fn::Select:
              - 1
              - Fn::Split:
                  - ','
                  - Fn::If:
                      - SecurityGroupsOverride
                      - Ref: SecurityGroups
                      - BaseInstance,None,None,None
          SecurityGroupName2:
            Fn::Select:
              - 2
              - Fn::Split:
                  - ','
                  - Fn::If:
                      - SecurityGroupsOverride
                      - Ref: SecurityGroups
                      - BaseInstance,None,None,None
          SecurityGroupName3:
            Fn::Select:
              - 3
              - Fn::Split:
                  - ','
                  - Fn::If:
                      - SecurityGroupsOverride
                      - Ref: SecurityGroups
                      - BaseInstance,None,None,None
          SecurityGroupValue0:
            Fn::If:
              - SecurityGroup0
              - Fn::ImportValue:
                  Fn::Sub:
                    - SecurityGroup${ImportName}
                    - ImportName:
                        Fn::Select:
                          - 0
                          - Fn::Split:
                              - ','
                              - Fn::If:
                                  - SecurityGroupsOverride
                                  - Ref: SecurityGroups
                                  - BaseInstance,None,None,None
              - None
          SecurityGroupValue1:
            Fn::If:
              - SecurityGroup1
              - Fn::ImportValue:
                  Fn::Sub:
                    - SecurityGroup${ImportName}
                    - ImportName:
                        Fn::Select:
                          - 1
                          - Fn::Split:
                              - ','
                              - Fn::If:
                                  - SecurityGroupsOverride
                                  - Ref: SecurityGroups
                                  - BaseInstance,None,None,None
              - None
          SecurityGroupValue2:
            Fn::If:
              - SecurityGroup2
              - Fn::ImportValue:
                  Fn::Sub:
                    - SecurityGroup${ImportName}
                    - ImportName:
                        Fn::Select:
                          - 2
                          - Fn::Split:
                              - ','
                              - Fn::If:
                                  - SecurityGroupsOverride
                                  - Ref: SecurityGroups
                                  - BaseInstance,None,None,None
              - None
          SecurityGroupValue3:
            Fn::If:
              - SecurityGroup3
              - Fn::ImportValue:
                  Fn::Sub:
                    - SecurityGroup${ImportName}
                    - ImportName:
                        Fn::Select:
                          - 3
                          - Fn::Split:
                              - ','
                              - Fn::If:
                                  - SecurityGroupsOverride
                                  - Ref: SecurityGroups
                                  - BaseInstance,None,None,None
              - None
  StackType:
    Value: ec2
  UpdateMode:
    Value:
      Ref: UpdateMode
Parameters:
  ASGLifecycleHookECSDrainInstanceHeartbeatTimeout:
    Default: ''
    Description: ECSDrainInstance ASGLifecycleHook and Lambda HeartbeatTimeout - empty
      for default based on env/role
    Type: String
  AutoScalingGroupBaseHealthCheckGracePeriod:
    Default: ''
    Description: How long to wait before ASG check instance health - empty for default
      based on env/role
    Type: String
  AutoScalingScalingPolicyCustomTargetTrackingConfigurationCustomizedMetricSpecificationStatistic:
    Default: ''
    Description: 0 to disable - empty for mapped value
    Type: String
  AutoScalingScalingPolicyCustomTargetTrackingConfigurationTargetValue:
    Default: ''
    Description: 0 to disable - empty for mapped value
    Type: String
  CapacityDesired:
    Default: ''
    Description: Desired Autoscaling Capacity - empty for default based on env/role
    Type: String
  CapacityMax:
    Default: ''
    Description: Max Autoscaling Capacity - empty for default based on env/role
    Type: String
  CapacityMin:
    Default: ''
    Description: Min Autoscaling Capacity - empty for default based on env/role
    Type: String
  CloudWatchAgent:
    AllowedValues:
      - ''
      - 'True'
      - None
    Default: ''
    Description: CloudWatch Agent Install - empty for default based on env/role
    Type: String
  DoNotSignal:
    AllowedValues:
      - 'False'
      - 'True'
    Default: 'False'
    Description: Do Not Signal ASG - WARNING need to manually exec cfn-signal!
    Type: String
  EfsMounts:
    Default: ''
    Description: Efs Mounts List
    Type: CommaDelimitedList
  Env:
    AllowedValues:
      - dev
      - stg
      - prod
    Default: dev
    Description: Environment
    Type: String
  EnvRole:
    AllowedPattern: ^[a-zA-Z0-9-_.]*$
    Default: ''
    Description: Service Role
    Type: String
  EnvShort:
    AllowedValues:
      - dev
      - stg
      - prd
    Default: dev
    Description: Environment Short - NEVER CHANGE!
    Type: String
  EnvStackVersion:
    Default: '1'
    Description: Stack version, if changed with UpdateMode=Cfn triggers cfn-hup
    Type: String
  GPUInstance:
    AllowedValues:
      - 'True'
      - None
    Default: None
    Description: Install Coda and nvidia-docker2
    Type: String
  LaunchTemplateDataBlockDeviceMappingsAdditionalStorageEbsVolumeSize:
    AllowedValues:
      - ''
      - '0'
      - '4'
      - '8'
      - '16'
      - '32'
      - '64'
      - '128'
      - '256'
      - '512'
      - '1024'
    Default: ''
    Description: Size in GiB of additional EBS storage - 0 to disable - empty for
      default
    Type: String
  LaunchTemplateDataBlockDeviceMappingsXvdaEbsVolumeSize:
    Default: ''
    Description: Size of HD in GB - empty for default based on env/role
    Type: String
  LaunchTemplateDataImageId:
    Default: ''
    Description: AMI ID - empty for default based on env/role/region
    Type: String
  LaunchTemplateDataImageIdLatest:
    AllowedValues:
      - /aws/service/ecs/optimized-ami/amazon-linux/recommended/image_id
      - /aws/service/ecs/optimized-ami/amazon-linux-2/recommended/image_id
    Default: /aws/service/ecs/optimized-ami/amazon-linux-2/recommended/image_id
    Description: Latest ecs ami available from SSM
    Type: AWS::SSM::Parameter::Value<String>
  LaunchTemplateDataInstanceMarketOptionsSpotOptionsMaxPrice:
    Default: ''
    Description: Maximum Spot Price of ASG - empty for default based on env/role -
      0 to disable
    Type: String
  LaunchTemplateDataInstanceType:
    AllowedValues:
      - default
      - m3.medium
      - m3.large
      - m3.xlarge
      - m3.2xlarge
      - c3.large
      - c3.xlarge
      - c3.2xlarge
      - c3.4xlarge
      - r3.large
      - r3.xlarge
      - r3.2xlarge
      - r3.4xlarge
      - i2.xlarge
      - i2.2xlarge
      - i2.4xlarge
      - d2.xlarge
      - d2.2xlarge
      - d2.4xlarge
      - t2.nano
      - t2.micro
      - t2.small
      - t2.medium
      - t2.large
      - t2.xlarge
      - t2.2xlarge
      - m4.large
      - m4.xlarge
      - m4.2xlarge
      - m4.4xlarge
      - c4.large
      - c4.xlarge
      - c4.2xlarge
      - c4.4xlarge
      - r4.large
      - r4.xlarge
      - r4.2xlarge
      - r4.4xlarge
      - g2.2xlarge
      - g3s.xlarge
      - t3.nano
      - t3.micro
      - t3.small
      - t3.medium
      - t3.large
      - t3.xlarge
      - t3.2xlarge
      - m5.large
      - m5.xlarge
      - m5.2xlarge
      - m5.4xlarge
      - m5.8xlarge
      - m5.12xlarge
      - m5.16xlarge
      - m5.24xlarge
      - c5.large
      - c5.xlarge
      - c5.2xlarge
      - c5.4xlarge
      - c5.9xlarge
      - c5.12xlarge
      - c5.18xlarge
      - c5.24xlarge
      - r5.large
      - r5.xlarge
      - r5.2xlarge
      - r5.4xlarge
      - r5.8xlarge
      - r5.12xlarge
      - r5.16xlarge
      - r5.24xlarge
      - a1.medium
      - a1.large
      - a1.xlarge
      - a1.2xlarge
      - a1.4xlarge
      - m5a.large
      - m5a.xlarge
      - m5a.2xlarge
      - m5a.4xlarge
      - m5a.8xlarge
      - m5a.12xlarge
      - m5a.16xlarge
      - m5a.24xlarge
      - r5a.large
      - r5a.xlarge
      - r5a.2xlarge
      - r5a.4xlarge
      - r5a.8xlarge
      - r5a.12xlarge
      - r5a.16xlarge
      - r5a.24xlarge
      - c5a.large
      - c5a.xlarge
      - c5a.2xlarge
      - c5a.4xlarge
      - c5a.8xlarge
      - c5a.12xlarge
      - c5a.16xlarge
      - c5a.24xlarge
      - t3a.nano
      - t3a.micro
      - t3a.small
      - t3a.medium
      - t3a.large
      - t3a.xlarge
      - t3a.2xlarge
      - t4g.nano
      - t4g.micro
      - t4g.small
      - t4g.medium
      - t4g.large
      - t4g.xlarge
      - t4g.2xlarge
    ConstraintDescription: must be a valid EC2 instance type.
    Default: default
    Description: InstanceType - default for default based on env/role
    Type: String
  LaunchTemplateDataKeyName:
    Default: ''
    Description: EC2 SSH Key - empty for default
    Type: String
  ScheduledActionDownDesiredSize:
    Default: ''
    Description: k to keep current value - empty for mapped value
    Type: String
  ScheduledActionDownMaxSize:
    Default: ''
    Description: k to keep current value - empty for mapped value
    Type: String
  ScheduledActionDownMinSize:
    Default: ''
    Description: k to keep current value - empty for mapped value
    Type: String
  ScheduledActionDownRecurrence:
    Default: ''
    Description: empty for mapped value
    Type: String
  ScheduledActionDownStartTime:
    Default: ''
    Description: ''
    Type: String
  ScheduledActionRotateDesiredSize:
    Default: ''
    Description: k to keep current value - empty for mapped value
    Type: String
  ScheduledActionRotateMaxSize:
    Default: ''
    Description: k to keep current value - empty for mapped value
    Type: String
  ScheduledActionRotateMinSize:
    Default: ''
    Description: k to keep current value - empty for mapped value
    Type: String
  ScheduledActionRotateRecurrence:
    Default: ''
    Description: empty for mapped value
    Type: String
  ScheduledActionRotateStartTime:
    Default: ''
    Description: ''
    Type: String
  ScheduledActionUpDesiredSize:
    Default: ''
    Description: k to keep current value - empty for mapped value
    Type: String
  ScheduledActionUpMaxSize:
    Default: ''
    Description: k to keep current value - empty for mapped value
    Type: String
  ScheduledActionUpMinSize:
    Default: ''
    Description: k to keep current value - empty for mapped value
    Type: String
  ScheduledActionUpRecurrence:
    Default: ''
    Description: empty for mapped value
    Type: String
  ScheduledActionUpStartTime:
    Default: ''
    Description: ''
    Type: String
  SecurityGroups:
    AllowedPattern: ^(\w*,\w*){3}$
    Default: ',,,'
    Description: SecurityGroups List Extra - ,,, for default based on env/role
    Type: String
  SpotAuto:
    AllowedValues:
      - ''
      - 'True'
      - None
    Default: ''
    Description: ASG TAG for autospotting https://github.com/AutoSpotting/AutoSpotting
      - empty for default based on env/role
    Type: String
  SpotAutoAllowedInstances:
    Default: ''
    Description: ASG TAG for autospotting allowed instance types (space delimited)
      - current to use the same of ASG - empty for default based on env/role - None
      to disable
    Type: String
  SpotAutoMinOnDemandNumber:
    Default: ''
    Description: ASG TAG for autospotting minimum on-demand instance to keep - empty
      for default based on env/role - None to disable
    Type: String
  UpdateMode:
    Default: None
    Description: How to update Instances
    Type: String
Resources:
  ASGLifecycleHookECSDrainInstance:
    Properties:
      AutoScalingGroupName:
        Ref: AutoScalingGroup
      DefaultResult: ABANDON
      HeartbeatTimeout:
        Fn::If:
          - ASGLifecycleHookECSDrainInstanceHeartbeatTimeoutOverride
          - Ref: ASGLifecycleHookECSDrainInstanceHeartbeatTimeout
          - Fn::FindInMap:
              - Ref: EnvShort
              - Ref: AWS::Region
              - ASGLifecycleHookECSDrainInstanceHeartbeatTimeout
      LifecycleTransition: autoscaling:EC2_INSTANCE_TERMINATING
      NotificationTargetARN:
        Fn::ImportValue: SNSTopicECSDrainInstance
      RoleARN:
        Fn::ImportValue: RoleASGLifecycleHookECSDrainInstance
    Type: AWS::AutoScaling::LifecycleHook
  AutoScalingGroup:
    CreationPolicy:
      ResourceSignal:
        Count:
          Fn::If:
            - CapacityDesiredOverride
            - Ref: CapacityDesired
            - Fn::FindInMap:
                - Ref: EnvShort
                - Ref: AWS::Region
                - CapacityDesired
        Timeout: PT15M
    Properties:
      AvailabilityZones:
        Fn::GetAZs: ''
      DesiredCapacity:
        Fn::If:
          - CapacityDesiredOverride
          - Ref: CapacityDesired
          - Fn::FindInMap:
              - Ref: EnvShort
              - Ref: AWS::Region
              - CapacityDesired
      HealthCheckGracePeriod:
        Fn::If:
          - AutoScalingGroupBaseHealthCheckGracePeriodOverride
          - Ref: AutoScalingGroupBaseHealthCheckGracePeriod
          - 600
      HealthCheckType: EC2
      LaunchTemplate:
        LaunchTemplateId:
          Ref: LaunchTemplate
        Version:
          Fn::GetAtt:
            - LaunchTemplate
            - LatestVersionNumber
      LoadBalancerNames: []
      MaxSize:
        Fn::If:
          - CapacityMaxOverride
          - Ref: CapacityMax
          - Fn::FindInMap:
              - Ref: EnvShort
              - Ref: AWS::Region
              - CapacityMax
      MetricsCollection:
        - Granularity: 1Minute
      MinSize:
        Fn::If:
          - CapacityMinOverride
          - Ref: CapacityMin
          - Fn::FindInMap:
              - Ref: EnvShort
              - Ref: AWS::Region
              - CapacityMin
      Tags:
        - Key: Name
          PropagateAtLaunch: true
          Value:
            Ref: EnvRole
        - Key: EnvStackName
          PropagateAtLaunch: true
          Value:
            Ref: AWS::StackName
        - Fn::If:
            - SpotAuto
            - Key: spot-enabled
              PropagateAtLaunch: true
              Value: 'true'
            - Ref: AWS::NoValue
        - Fn::If:
            - SpotAutoMinOnDemandNumber
            - Key: autospotting_min_on_demand_number
              PropagateAtLaunch: true
              Value:
                Fn::If:
                  - SpotAutoMinOnDemandNumberOverride
                  - Ref: SpotAutoMinOnDemandNumber
                  - None
            - Ref: AWS::NoValue
        - Fn::If:
            - SpotAutoAllowedInstances
            - Key: autospotting_allowed_instance_types
              PropagateAtLaunch: true
              Value:
                Fn::If:
                  - SpotAutoAllowedInstancesOverride
                  - Ref: SpotAutoAllowedInstances
                  - None
            - Ref: AWS::NoValue
      TargetGroupARNs: []
      TerminationPolicies:
        - OldestInstance
      VPCZoneIdentifier:
        Fn::Split:
          - ','
          - Fn::ImportValue: SubnetsPrivate
    Type: AWS::AutoScaling::AutoScalingGroup
    UpdatePolicy:
      AutoScalingReplacingUpdate:
        Fn::If:
          - WillReplace
          - WillReplace: 'true'
          - Ref: AWS::NoValue
      AutoScalingRollingUpdate:
        Fn::If:
          - RollingUpdate
          - MaxBatchSize: 1
            MinInstancesInService:
              Fn::If:
                - CapacityDesiredOverride
                - Ref: CapacityDesired
                - Fn::FindInMap:
                    - Ref: EnvShort
                    - Ref: AWS::Region
                    - CapacityDesired
            MinSuccessfulInstancesPercent: 100
            PauseTime: PT20M
            SuspendProcesses:
              - HealthCheck
              - ReplaceUnhealthy
              - AlarmNotification
              - ScheduledActions
            WaitOnResourceSignals: 'true'
          - Ref: AWS::NoValue
      AutoScalingScheduledAction:
        IgnoreUnmodifiedGroupSizeProperties: 'true'
  AutoScalingScalingPolicyCustom:
    Condition: AutoScalingScalingPolicyCustom
    Properties:
      AutoScalingGroupName:
        Ref: AutoScalingGroup
      EstimatedInstanceWarmup: 60
      PolicyType: TargetTrackingScaling
      TargetTrackingConfiguration:
        CustomizedMetricSpecification:
          Dimensions:
            - Name: AutoScalingGroupName
              Value:
                Ref: AutoScalingGroup
          MetricName: CPUUtilization
          Namespace: AWS/EC2
          Statistic:
            Fn::If:
              - AutoScalingScalingPolicyCustomTargetTrackingConfigurationCustomizedMetricSpecificationStatisticOverride
              - Ref: AutoScalingScalingPolicyCustomTargetTrackingConfigurationCustomizedMetricSpecificationStatistic
              - Maximum
          Unit: Percent
        TargetValue:
          Fn::If:
            - AutoScalingScalingPolicyCustomTargetTrackingConfigurationTargetValueOverride
            - Ref: AutoScalingScalingPolicyCustomTargetTrackingConfigurationTargetValue
            - 60
    Type: AWS::AutoScaling::ScalingPolicy
  Cluster:
    Type: AWS::ECS::Cluster
  IAMPolicyCloudFormation:
    Properties:
      PolicyDocument:
        Statement:
          - Action:
              - cloudformation:DescribeStackResource
              - cloudformation:SignalResource
            Effect: Allow
            Resource:
              Fn::Sub: arn:aws:cloudformation:*:*:stack/${AWS::StackName}/*
        Version: '2012-10-17'
      PolicyName: CloudFormation
      Roles:
        - Ref: RoleInstance
    Type: AWS::IAM::Policy
  IAMPolicyParameterStore:
    Properties:
      PolicyDocument:
        Statement:
          - Action: kms:Decrypt
            Effect: Allow
            Resource:
              Fn::ImportValue: KeyParameterStore
          - Action: ssm:DescribeParameters
            Effect: Allow
            Resource:
              Fn::Sub: arn:aws:ssm:${AWS::Region}:${AWS::AccountId}:*
          - Action: ssm:GetParameters
            Effect: Allow
            Resource:
              - Fn::Sub: arn:aws:ssm:${AWS::Region}:${AWS::AccountId}:parameter/${EnvRole}/*
              - Fn::Sub: arn:aws:ssm:${AWS::Region}:${AWS::AccountId}:parameter/${AWS::StackName}/${EnvRole}/*
        Version: '2012-10-17'
      PolicyName: ParameterStore
      Roles:
        - Ref: RoleInstance
    Type: AWS::IAM::Policy
  InstanceProfile:
    Properties:
      Path: /
      Roles:
        - Ref: RoleInstance
    Type: AWS::IAM::InstanceProfile
  LaunchTemplate:
    Metadata:
      AWS::CloudFormation::Authentication:
        CfnS3Auth:
          buckets:
            - Fn::Sub: ${AWS::Region}-arda-numenor-app-repository
            - Fn::Sub: ${AWS::Region}-arda-numenor-app-data
          roleName:
            Ref: RoleInstance
          type: S3
      AWS::CloudFormation::Init:
        CWAGENT:
          files:
            /opt/aws/amazon-cloudwatch-agent/etc/amazon-cloudwatch-agent.json:
              content:
                Fn::Join:
                  - ''
                  - - "{\n"
                    - "  \"metrics\": {\n"
                    - "    \"append_dimensions\": {\n"
                    - "      \"AutoScalingGroupName\": \"${aws:AutoScalingGroupName}\"\
                      ,\n"
                    - "      \"InstanceId\": \"${!aws:InstanceId}\"\n"
                    - "    },\n"
                    - "    \"aggregation_dimensions\": [\n"
                    - "      [\"AutoScalingGroupName\"]\n"
                    - "    ],\n"
                    - "    \"metrics_collected\": {\n"
                    - "      \"mem\": {\n"
                    - "        \"measurement\": [\n"
                    - "          \"mem_used_percent\"\n"
                    - "        ]\n"
                    - "      },\n"
                    - "      \"disk\": {\n"
                    - "        \"resources\": [\n"
                    - "          \"/\"\n"
                    - "        ],\n"
                    - "        \"measurement\": [\n"
                    - "          {\n"
                    - "            \"name\": \"disk_used_percent\",\n"
                    - "            \"rename\": \"root_disk_used_percent\"\n"
                    - "          }\n"
                    - "        ],\n"
                    - "        \"drop_device\": true\n"
                    - "      }\n"
                    - "    }\n"
                    - "  }\n"
                    - "}\n"
          packages:
            rpm:
              amazon-cloudwatch-agent: https://s3.amazonaws.com/amazoncloudwatch-agent/amazon_linux/amd64/latest/amazon-cloudwatch-agent.rpm
          services:
            sysvinit:
              amazon-cloudwatch-agent:
                ensureRunning: 'true'
                files:
                  - /opt/aws/amazon-cloudwatch-agent/etc/amazon-cloudwatch-agent.json
        PACKAGES:
          packages:
            yum:
              automake:
                Fn::If:
                  - GPUInstance
                  - []
                  - Ref: AWS::NoValue
              dkms-nvidia:
                Fn::If:
                  - GPUInstance
                  - []
                  - Ref: AWS::NoValue
              gcc:
                Fn::If:
                  - GPUInstance
                  - []
                  - Ref: AWS::NoValue
              gcc-c++:
                Fn::If:
                  - GPUInstance
                  - []
                  - Ref: AWS::NoValue
              kernel-devel:
                Fn::If:
                  - GPUInstance
                  - []
                  - Ref: AWS::NoValue
              make:
                Fn::If:
                  - GPUInstance
                  - []
                  - Ref: AWS::NoValue
              nfs-utils: []
              nvidia-docker2:
                Fn::If:
                  - GPUInstance
                  - []
                  - Ref: AWS::NoValue
              nvidia-driver-cuda:
                Fn::If:
                  - GPUInstance
                  - []
                  - Ref: AWS::NoValue
        REPOSITORIES:
          commands:
            Fn::If:
              - GPUInstance
              - 10-epel-repo:
                  command: amazon-linux-extras install -y epel
                  test: '! test -e /etc/yum.repos.d/epel.repo'
                nvidia-docker:
                  command: curl -s -L https://nvidia.github.io/nvidia-docker/amzn2/nvidia-docker.repo
                    | tee /etc/yum.repos.d/nvidia-docker.repo
                  test: test ! -e /etc/yum.repos.d/nvidia-docker.repo
              - Ref: AWS::NoValue
          files:
            Fn::If:
              - GPUInstance
              - /etc/yum.repos.d/epel-nvidia.repo:
                  content:
                    Fn::Join:
                      - "\n"
                      - - '[epel-nvidia]'
                        - name=negativo17 - Nvidia
                        - baseurl=https://negativo17.org/repos/nvidia/epel-7/$basearch/
                        - enabled=1
                        - skip_if_unavailable=1
                        - gpgcheck=1
                        - gpgkey=https://negativo17.org/repos/RPM-GPG-KEY-slaanesh
                        - enabled_metadata=1
                        - metadata_expire=6h
                        - type=rpm-md
                        - repo_gpgcheck=0
              - Ref: AWS::NoValue
        SERVICES:
          commands:
            01-kern-modules:
              Fn::If:
                - GPUInstance
                - command: rmmod nvidia_modeset;rmmod nvidia_uvm;rmmod nvidia;modprobe
                    nvidia;modprobe nvidia_uvm;true
                - Ref: AWS::NoValue
            02-restart-docker:
              Fn::If:
                - GPUInstance
                - command: pkill -SIGHUP dockerd
                - Ref: AWS::NoValue
          files:
            /etc/docker/daemon.json:
              Fn::If:
                - GPUInstance
                - content:
                    Fn::Join:
                      - "\n"
                      - - '{'
                        - '  "default-runtime": "nvidia",'
                        - '  "runtimes": {'
                        - '    "nvidia": {'
                        - '      "path": "/usr/bin/nvidia-container-runtime",'
                        - '      "runtimeArgs": []'
                        - '    }'
                        - '  }'
                        - '}'
                - Ref: AWS::NoValue
            /etc/ecs/ecs.config:
              content:
                Fn::Join:
                  - "\n"
                  - - Fn::Sub: ECS_CLUSTER=${Cluster}
                    - Fn::If:
                        - GPUInstance
                        - ECS_DISABLE_PRIVILEGED=false
                        - Ref: AWS::NoValue
        SETUP:
          commands:
            01_disk:
              command:
                Fn::Join:
                  - ''
                  - - "n=0\n"
                    - "for disk in /dev/xvd[b-d]; do\n"
                    - "  [ -b \"$disk\" ] || continue\n"
                    - '  file -s "$disk" | grep -q "ext[34] filesystem" || '
                    - "  { mkfs.ext4 $disk || continue; }\n"
                    - '  mkdir -p /media/ephemeral${n} && '
                    - "  mount $disk /media/ephemeral${n}\n"
                    - "  n=$(($n+1))\n"
                    - done
            02_disk_additional:
              Fn::If:
                - LaunchTemplateDataBlockDeviceMappingsAdditionalStorageMount
                - command:
                    Fn::Sub:
                      - "file -s ${LaunchTemplateDataBlockDeviceMappingsAdditionalStorageDeviceName}1\
                        \ | grep -q \"ext[34] filesystem\" || { parted -s ${LaunchTemplateDataBlockDeviceMappingsAdditionalStorageDeviceName}\
                        \ mklabel gpt && parted -s ${LaunchTemplateDataBlockDeviceMappingsAdditionalStorageDeviceName}\
                        \ mkpart primary ext2 1 ${LaunchTemplateDataBlockDeviceMappingsAdditionalStorageEbsVolumeSize}G\
                        \ && mkfs.ext4 ${LaunchTemplateDataBlockDeviceMappingsAdditionalStorageDeviceName}1\
                        \ || continue; }\nmkdir -p /data && mount ${LaunchTemplateDataBlockDeviceMappingsAdditionalStorageDeviceName}1\
                        \ /data"
                      - LaunchTemplateDataBlockDeviceMappingsAdditionalStorageDeviceName: /dev/xvdx
                        LaunchTemplateDataBlockDeviceMappingsAdditionalStorageEbsVolumeSize:
                          Fn::If:
                            - LaunchTemplateDataBlockDeviceMappingsAdditionalStorageEbsVolumeSizeOverride
                            - Ref: LaunchTemplateDataBlockDeviceMappingsAdditionalStorageEbsVolumeSize
                            - 0
                - Ref: AWS::NoValue
            03_efs_mounts:
              Fn::If:
                - EfsMounts
                - command:
                    Fn::Join:
                      - ''
                      - - 'for mounts in '
                        - Fn::Join:
                            - ' '
                            - Ref: EfsMounts
                        - ";do\n"
                        - "  mkdir -p \"/media/${mounts}\"\n"
                        - '  mountpoint -q "/media/${mounts}" ||'
                        - '    mount -t nfs4 -o nfsvers=4,rsize=1048576,wsize=1048576,hard,timeo=600,retrans=2 '
                        - '    efs-${mounts}.'
                        - internal.numenor.arda
                        - ':/ '
                        - "    /media/${mounts}\n"
                        - done
                - Ref: AWS::NoValue
            04_rmdir_tmp_ibox:
              command: rm -fr /tmp/ibox
          files:
            /etc/cfn/cfn-hup.conf:
              content:
                Fn::Join:
                  - ''
                  - - "[main]\n"
                    - stack=
                    - Ref: AWS::StackId
                    - "\n"
                    - region=
                    - Ref: AWS::Region
                    - "\n"
                    - role=
                    - Ref: RoleInstance
                    - "\n"
                    - "interval=5\n"
              group: root
              mode: '000400'
              owner: root
            /etc/cfn/hooks.d/cfn-auto-reloader.conf:
              content:
                Fn::Join:
                  - ''
                  - - "[cfn-auto-reloader-hook]\n"
                    - "triggers=post.add, post.update\n"
                    - "path=Resources.LaunchTemplate.Metadata.CloudFormationInitVersion\n"
                    - action=/opt/aws/bin/cfn-init -v
                    - ' --stack '
                    - Ref: AWS::StackName
                    - ' --role '
                    - Ref: RoleInstance
                    - ' --resource LaunchTemplate'
                    - ' --region '
                    - Ref: AWS::Region
                    - "\n"
                    - "runas=root\n"
            /etc/profile.d/ibox_env.sh:
              content:
                Fn::Join:
                  - ''
                  - - "#setup ibox environment variables\n"
                    - export Env=
                    - Ref: Env
                    - "\n"
                    - export EnvAbbr=
                    - Ref: EnvShort
                    - "\n"
                    - export EnvRegion=
                    - Ref: AWS::Region
                    - "\n"
                    - export EnvAccountId=
                    - Ref: AWS::AccountId
                    - "\n"
                    - export EnvRole=
                    - Ref: EnvRole
                    - "\n"
                    - export EnvBrand=
                    - numenor.arda
                    - "\n"
                    - export EnvStackName=
                    - Ref: AWS::StackName
                    - "\n"
          services:
            sysvinit:
              cfn-hup:
                enabled: 'false'
                ensureRunning: 'true'
                files:
                  - /etc/cfn/cfn-hup.conf
                  - /etc/cfn/hooks.d/cfn-auto-reloader.conf
        configSets:
          buildami:
            - REPOSITORIES
            - PACKAGES
          buildamifull:
            - REPOSITORIES
            - PACKAGES
            - SETUP
          default:
            - REPOSITORIES
            - PACKAGES
            - SETUP
            - Ref: AWS::NoValue
            - SERVICES
            - Fn::If:
                - CloudWatchAgent
                - CWAGENT
                - Ref: AWS::NoValue
            - Ref: AWS::NoValue
      CloudFormationInitVersion:
        Fn::If:
          - CloudFormationInit
          - Ref: EnvStackVersion
          - Ref: AWS::NoValue
    Properties:
      LaunchTemplateData:
        BlockDeviceMappings:
          - DeviceName: /dev/xvda
            Ebs:
              VolumeSize:
                Fn::If:
                  - LaunchTemplateDataBlockDeviceMappingsXvdaEbsVolumeSizeOverride
                  - Ref: LaunchTemplateDataBlockDeviceMappingsXvdaEbsVolumeSize
                  - Fn::FindInMap:
                      - Ref: EnvShort
                      - Ref: AWS::Region
                      - LaunchTemplateDataBlockDeviceMappingsXvdaEbsVolumeSize
              VolumeType: gp2
          - Fn::If:
              - LaunchTemplateDataBlockDeviceMappingsAdditionalStorage
              - DeviceName: /dev/xvdx
                Ebs:
                  VolumeSize:
                    Fn::If:
                      - LaunchTemplateDataBlockDeviceMappingsAdditionalStorageEbsVolumeSizeOverride
                      - Ref: LaunchTemplateDataBlockDeviceMappingsAdditionalStorageEbsVolumeSize
                      - 0
                  VolumeType: gp2
              - Ref: AWS::NoValue
          - Fn::If:
              - InstaceEphemeral0
              - DeviceName: /dev/xvdb
                VirtualName: ephemeral0
              - Ref: AWS::NoValue
          - Fn::If:
              - InstaceEphemeral1
              - DeviceName: /dev/xvdc
                VirtualName: ephemeral1
              - Ref: AWS::NoValue
          - Fn::If:
              - InstaceEphemeral2
              - DeviceName: /dev/xvdd
                VirtualName: ephemeral2
              - Ref: AWS::NoValue
        IamInstanceProfile:
          Arn:
            Fn::GetAtt:
              - InstanceProfile
              - Arn
        ImageId:
          Fn::If:
            - LaunchTemplateDataImageIdLatest
            - Ref: LaunchTemplateDataImageIdLatest
            - Fn::If:
                - LaunchTemplateDataImageIdOverride
                - Ref: LaunchTemplateDataImageId
                - Fn::FindInMap:
                    - Ref: EnvShort
                    - Ref: AWS::Region
                    - LaunchTemplateDataImageId
        InstanceMarketOptions:
          Fn::If:
            - LaunchTemplateDataInstanceMarketOptionsSpotOptionsMaxPrice
            - MarketType: spot
              SpotOptions:
                MaxPrice:
                  Fn::If:
                    - LaunchTemplateDataInstanceMarketOptionsSpotOptionsMaxPriceOverride
                    - Ref: LaunchTemplateDataInstanceMarketOptionsSpotOptionsMaxPrice
                    - '0'
            - Ref: AWS::NoValue
        InstanceType:
          Fn::If:
            - LaunchTemplateDataInstanceTypeOverride
            - Ref: LaunchTemplateDataInstanceType
            - Fn::FindInMap:
                - Ref: EnvShort
                - Ref: AWS::Region
                - LaunchTemplateDataInstanceType
        KeyName:
          Fn::If:
            - LaunchTemplateDataKeyNameOverride
            - Ref: LaunchTemplateDataKeyName
            - None
        Monitoring:
          Enabled: 'false'
        NetworkInterfaces:
          - AssociatePublicIpAddress: 'false'
            DeviceIndex: 0
            Groups:
              - Fn::GetAtt:
                  - SecurityGroupInstancesRules
                  - GroupId
              - Fn::If:
                  - SecurityGroup0
                  - Fn::ImportValue:
                      Fn::Sub:
                        - SecurityGroup${ImportName}
                        - ImportName:
                            Fn::Select:
                              - 0
                              - Fn::Split:
                                  - ','
                                  - Fn::If:
                                      - SecurityGroupsOverride
                                      - Ref: SecurityGroups
                                      - BaseInstance,None,None,None
                  - Ref: AWS::NoValue
              - Fn::If:
                  - SecurityGroup1
                  - Fn::ImportValue:
                      Fn::Sub:
                        - SecurityGroup${ImportName}
                        - ImportName:
                            Fn::Select:
                              - 1
                              - Fn::Split:
                                  - ','
                                  - Fn::If:
                                      - SecurityGroupsOverride
                                      - Ref: SecurityGroups
                                      - BaseInstance,None,None,None
                  - Ref: AWS::NoValue
              - Fn::If:
                  - SecurityGroup2
                  - Fn::ImportValue:
                      Fn::Sub:
                        - SecurityGroup${ImportName}
                        - ImportName:
                            Fn::Select:
                              - 2
                              - Fn::Split:
                                  - ','
                                  - Fn::If:
                                      - SecurityGroupsOverride
                                      - Ref: SecurityGroups
                                      - BaseInstance,None,None,None
                  - Ref: AWS::NoValue
              - Fn::If:
                  - SecurityGroup3
                  - Fn::ImportValue:
                      Fn::Sub:
                        - SecurityGroup${ImportName}
                        - ImportName:
                            Fn::Select:
                              - 3
                              - Fn::Split:
                                  - ','
                                  - Fn::If:
                                      - SecurityGroupsOverride
                                      - Ref: SecurityGroups
                                      - BaseInstance,None,None,None
                  - Ref: AWS::NoValue
        TagSpecifications:
          - ResourceType: instance
            Tags:
              - Key: Name
                Value:
                  Ref: EnvRole
              - Key: EnvStackName
                Value:
                  Ref: AWS::StackName
          - ResourceType: volume
            Tags:
              - Key: Name
                Value:
                  Ref: EnvRole
              - Key: EnvStackName
                Value:
                  Ref: AWS::StackName
        UserData:
          Fn::Base64:
            Fn::Join:
              - ''
              - - "#!/bin/bash\n"
                - "PATH=/opt/aws/bin:$PATH\n"
                - "export BASH_ENV=/etc/profile.d/ibox_env.sh\n"
                - "export ENV=$BASH_ENV\n"
                - "yum -C list installed aws-cfn-bootstrap || yum install -y aws-cfn-bootstrap\n"
                - Fn::Sub: ''
                - cfn-init -v
                - ' --stack '
                - Ref: AWS::StackName
                - ' --role '
                - Ref: RoleInstance
                - ' --resource LaunchTemplate'
                - ' --region '
                - Ref: AWS::Region
                - "\n"
                - Fn::If:
                    - DoNotSignal
                    - Ref: AWS::NoValue
                    - Fn::Sub: "cfn-signal -e $? --stack ${AWS::StackName} --role\
                        \ ${RoleInstance} --resource AutoScalingGroup --region ${AWS::Region}\n"
                - "rm /var/lib/cloud/instance/sem/config_scripts_user\n"
      LaunchTemplateName:
        Fn::Sub: ${AWS::StackName}-${EnvRole}
    Type: AWS::EC2::LaunchTemplate
  RoleInstance:
    Properties:
      AssumeRolePolicyDocument:
        Statement:
          - Action: sts:AssumeRole
            Effect: Allow
            Principal:
              Service:
                - ec2.amazonaws.com
      ManagedPolicyArns:
        - Fn::ImportValue: IAMPolicyBaseInstance
        - Fn::ImportValue: IAMPolicySSM
        - Fn::If:
            - CloudWatchAgent
            - arn:aws:iam::aws:policy/CloudWatchAgentServerPolicy
            - Ref: AWS::NoValue
        - Fn::ImportValue: IAMPolicyEcs
      Path: /
    Type: AWS::IAM::Role
  ScheduledActionDown:
    Condition: ScheduledActionDown
    Properties:
      AutoScalingGroupName:
        Ref: AutoScalingGroup
      DesiredCapacity:
        Fn::If:
          - ScheduledActionDownCapacityDesiredSize
          - Fn::If:
              - CapacityDesiredOverride
              - Ref: CapacityDesired
              - Fn::FindInMap:
                  - Ref: EnvShort
                  - Ref: AWS::Region
                  - CapacityDesired
          - Fn::If:
              - ScheduledActionDownKeepDesiredSize
              - Ref: AWS::NoValue
              - Fn::If:
                  - ScheduledActionDownDesiredSizeOverride
                  - Ref: ScheduledActionDownDesiredSize
                  - CapacityDesired
      MaxSize:
        Fn::If:
          - ScheduledActionDownCapacityMaxSize
          - Fn::If:
              - CapacityMaxOverride
              - Ref: CapacityMax
              - Fn::FindInMap:
                  - Ref: EnvShort
                  - Ref: AWS::Region
                  - CapacityMax
          - Fn::If:
              - ScheduledActionDownKeepMaxSize
              - Ref: AWS::NoValue
              - Fn::If:
                  - ScheduledActionDownMaxSizeOverride
                  - Ref: ScheduledActionDownMaxSize
                  - CapacityMax
      MinSize:
        Fn::If:
          - ScheduledActionDownCapacityMinSize
          - Fn::If:
              - CapacityMinOverride
              - Ref: CapacityMin
              - Fn::FindInMap:
                  - Ref: EnvShort
                  - Ref: AWS::Region
                  - CapacityMin
          - Fn::If:
              - ScheduledActionDownKeepMinSize
              - Ref: AWS::NoValue
              - Fn::If:
                  - ScheduledActionDownMinSizeOverride
                  - Ref: ScheduledActionDownMinSize
                  - CapacityMin
      Recurrence:
        Fn::If:
          - ScheduledActionDownRecurrenceOverride
          - Ref: ScheduledActionDownRecurrence
          - 00 19 * * *
      StartTime:
        Fn::If:
          - ScheduledActionDownStartTimeOverride
          - Ref: ScheduledActionDownStartTime
          - Ref: AWS::NoValue
    Type: AWS::AutoScaling::ScheduledAction
  ScheduledActionRotate:
    Condition: ScheduledActionRotate
    Properties:
      AutoScalingGroupName:
        Ref: AutoScalingGroup
      DesiredCapacity:
        Fn::If:
          - ScheduledActionRotateCapacityDesiredSize
          - Fn::If:
              - CapacityDesiredOverride
              - Ref: CapacityDesired
              - Fn::FindInMap:
                  - Ref: EnvShort
                  - Ref: AWS::Region
                  - CapacityDesired
          - Fn::If:
              - ScheduledActionRotateKeepDesiredSize
              - Ref: AWS::NoValue
              - Fn::If:
                  - ScheduledActionRotateDesiredSizeOverride
                  - Ref: ScheduledActionRotateDesiredSize
                  - CapacityDesired
      MaxSize:
        Fn::If:
          - ScheduledActionRotateCapacityMaxSize
          - Fn::If:
              - CapacityMaxOverride
              - Ref: CapacityMax
              - Fn::FindInMap:
                  - Ref: EnvShort
                  - Ref: AWS::Region
                  - CapacityMax
          - Fn::If:
              - ScheduledActionRotateKeepMaxSize
              - Ref: AWS::NoValue
              - Fn::If:
                  - ScheduledActionRotateMaxSizeOverride
                  - Ref: ScheduledActionRotateMaxSize
                  - CapacityMax
      MinSize:
        Fn::If:
          - ScheduledActionRotateCapacityMinSize
          - Fn::If:
              - CapacityMinOverride
              - Ref: CapacityMin
              - Fn::FindInMap:
                  - Ref: EnvShort
                  - Ref: AWS::Region
                  - CapacityMin
          - Fn::If:
              - ScheduledActionRotateKeepMinSize
              - Ref: AWS::NoValue
              - Fn::If:
                  - ScheduledActionRotateMinSizeOverride
                  - Ref: ScheduledActionRotateMinSize
                  - CapacityMin
      Recurrence:
        Fn::If:
          - ScheduledActionRotateRecurrenceOverride
          - Ref: ScheduledActionRotateRecurrence
          - 45 5 * * *
      StartTime:
        Fn::If:
          - ScheduledActionRotateStartTimeOverride
          - Ref: ScheduledActionRotateStartTime
          - Ref: AWS::NoValue
    Type: AWS::AutoScaling::ScheduledAction
  ScheduledActionUp:
    Condition: ScheduledActionUp
    Properties:
      AutoScalingGroupName:
        Ref: AutoScalingGroup
      DesiredCapacity:
        Fn::If:
          - ScheduledActionUpCapacityDesiredSize
          - Fn::If:
              - CapacityDesiredOverride
              - Ref: CapacityDesired
              - Fn::FindInMap:
                  - Ref: EnvShort
                  - Ref: AWS::Region
                  - CapacityDesired
          - Fn::If:
              - ScheduledActionUpKeepDesiredSize
              - Ref: AWS::NoValue
              - Fn::If:
                  - ScheduledActionUpDesiredSizeOverride
                  - Ref: ScheduledActionUpDesiredSize
                  - CapacityDesired
      MaxSize:
        Fn::If:
          - ScheduledActionUpCapacityMaxSize
          - Fn::If:
              - CapacityMaxOverride
              - Ref: CapacityMax
              - Fn::FindInMap:
                  - Ref: EnvShort
                  - Ref: AWS::Region
                  - CapacityMax
          - Fn::If:
              - ScheduledActionUpKeepMaxSize
              - Ref: AWS::NoValue
              - Fn::If:
                  - ScheduledActionUpMaxSizeOverride
                  - Ref: ScheduledActionUpMaxSize
                  - CapacityMax
      MinSize:
        Fn::If:
          - ScheduledActionUpCapacityMinSize
          - Fn::If:
              - CapacityMinOverride
              - Ref: CapacityMin
              - Fn::FindInMap:
                  - Ref: EnvShort
                  - Ref: AWS::Region
                  - CapacityMin
          - Fn::If:
              - ScheduledActionUpKeepMinSize
              - Ref: AWS::NoValue
              - Fn::If:
                  - ScheduledActionUpMinSizeOverride
                  - Ref: ScheduledActionUpMinSize
                  - CapacityMin
      Recurrence:
        Fn::If:
          - ScheduledActionUpRecurrenceOverride
          - Ref: ScheduledActionUpRecurrence
          - 30 08 * * mon-fri
      StartTime:
        Fn::If:
          - ScheduledActionUpStartTimeOverride
          - Ref: ScheduledActionUpStartTime
          - Ref: AWS::NoValue
    Type: AWS::AutoScaling::ScheduledAction
  SecurityGroupIngressContainerInstanceExternal:
    Properties:
      FromPort: 32768
      GroupId:
        Fn::GetAtt:
          - SecurityGroupInstancesRules
          - GroupId
      IpProtocol: tcp
      SourceSecurityGroupId:
        Fn::ImportValue: SecurityGroupLoadBalancerApplicationExternal
      ToPort: 60999
    Type: AWS::EC2::SecurityGroupIngress
  SecurityGroupIngressContainerInstanceInternal:
    Properties:
      FromPort: 32768
      GroupId:
        Fn::GetAtt:
          - SecurityGroupInstancesRules
          - GroupId
      IpProtocol: tcp
      SourceSecurityGroupId:
        Fn::ImportValue: SecurityGroupLoadBalancerApplicationInternal
      ToPort: 60999
    Type: AWS::EC2::SecurityGroupIngress
  SecurityGroupInstancesRules:
    Properties:
      GroupDescription: Enable Access from LoadBalancer to Instances and between Instances
      VpcId:
        Fn::ImportValue: VpcId
    Type: AWS::EC2::SecurityGroup

