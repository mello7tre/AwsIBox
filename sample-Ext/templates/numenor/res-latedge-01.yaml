AWSTemplateFormatVersion: '2010-09-09'
Conditions:
  BaseRegion:
    Fn::Equals:
      - eu-west-1
      - Ref: AWS::Region
  LambdaAtEdgeAddHeadersVersion:
    Fn::Or:
      - Condition: LambdaAtEdgeAddHeadersVersionA
      - Condition: LambdaAtEdgeAddHeadersVersionB
  LambdaAtEdgeAddHeadersVersionA:
    Fn::And:
      - Condition: LambdaAtEdgeAddHeaders
      - Fn::Equals:
          - Ref: LambdaAtEdgeAddHeadersVersion
          - A
  LambdaAtEdgeAddHeadersVersionB:
    Fn::And:
      - Condition: LambdaAtEdgeAddHeaders
      - Fn::Equals:
          - Ref: LambdaAtEdgeAddHeadersVersion
          - B
  LambdaAtEdgeAddHeadersVersionOverride:
    Fn::Not:
      - Fn::Equals:
          - Ref: LambdaAtEdgeAddHeadersVersion
          - ''
Description: res-latedge-01 (Generated by awsibox 0.2.20) [res]
Outputs:
  BrandDomain:
    Value: numenor.arda
  Env:
    Value:
      Ref: Env
  EnvRole:
    Value:
      Ref: EnvRole
  EnvStackVersion:
    Value:
      Ref: EnvStackVersion
  LambdaAtEdgeAddHeadersVersion:
    Condition: LambdaAtEdgeAddHeadersVersion
    Value:
      Fn::If:
        - LambdaAtEdgeAddHeadersVersionA
        - Ref: LambdaAtEdgeAddHeadersVersionA
        - Ref: LambdaAtEdgeAddHeadersVersionB
  StackType:
    Value: res
Parameters:
  Env:
    AllowedValues:
      - dev
      - stg
      - prod
    Default: dev
    Description: Environment
    Type: String
  EnvRole:
    AllowedPattern: ^[a-zA-Z0-9-_.]*$
    Default: ''
    Description: Service Role
    Type: String
  EnvShort:
    AllowedValues:
      - dev
      - stg
      - prd
    Default: dev
    Description: Environment Short - NEVER CHANGE!
    Type: String
  EnvStackVersion:
    Default: '1'
    Description: Stack version, if changed with UpdateMode=Cfn triggers cfn-hup
    Type: String
  LambdaAtEdgeAddHeadersVersion:
    AllowedValues:
      - ''
      - A
      - B
    Default: ''
    Description: LambdaVersion - change between A/B to force deploy new version
    Type: String
Resources:
  LambdaAtEdgeAddHeaders:
    Properties:
      Code:
        ZipFile:
          Fn::Join:
            - ''
            - - "# vim: ft=python\n"
              - "\n"
              - "CACHE_CONTROL = (\n"
              - '"'
              - 31536000
              - '"'
              - ")\n"
              - "\n"
              - "HEADER_CACHE_CONTROL = [{\n"
              - "    'key': 'cache-control',\n"
              - "    'value': f'max-age={CACHE_CONTROL}'\n"
              - "}]\n"
              - "\n"
              - "HEADER_XROBOTS_TAG = [{\n"
              - "    'key': 'x-robots-tag',\n"
              - "    'value': 'noindex, follow',\n"
              - "}]\n"
              - "\n"
              - "\n"
              - "def lambda_handler(event, context):\n"
              - "    response = event['Records'][0]['cf']['response']\n"
              - "    request = event['Records'][0]['cf']['request']\n"
              - "\n"
              - "    headers = response['headers']\n"
              - "\n"
              - "    if response['status'].startswith('2'):\n"
              - "        if request['uri'].startswith('/sitemap/'):\n"
              - "            headers['x-robots-tag'] = HEADER_XROBOTS_TAG\n"
              - "        else:\n"
              - "            headers['cache-control'] = HEADER_CACHE_CONTROL\n"
              - "\n"
              - "    if response['status'] == '403':\n"
              - "        response['status'] = '404'\n"
              - "\n"
              - "    return response\n"
      Description: Lambda@Edge add Headers
      FunctionName:
        Fn::Sub: ${AWS::StackName}-${EnvRole}-AtEdgeAddHeaders
      Handler: index.lambda_handler
      MemorySize: 128
      Role:
        Fn::GetAtt:
          - RoleLambdaAtEdgeAddHeaders
          - Arn
      Runtime: python3.7
      Timeout: 10
    Type: AWS::Lambda::Function
  LambdaAtEdgeAddHeadersVersionA:
    Condition: LambdaAtEdgeAddHeadersVersionA
    Properties:
      FunctionName:
        Ref: LambdaAtEdgeAddHeaders
    Type: AWS::Lambda::Version
  LambdaAtEdgeAddHeadersVersionB:
    Condition: LambdaAtEdgeAddHeadersVersionB
    Properties:
      FunctionName:
        Ref: LambdaAtEdgeAddHeaders
    Type: AWS::Lambda::Version
  RoleLambdaAtEdgeAddHeaders:
    Properties:
      AssumeRolePolicyDocument:
        Statement:
          - Action: sts:AssumeRole
            Effect: Allow
            Principal:
              Service:
                - lambda.amazonaws.com
                - edgelambda.amazonaws.com
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/AmazonEC2ReadOnlyAccess
        - arn:aws:iam::aws:policy/service-role/AWSLambdaVPCAccessExecutionRole
      Path: /
    Type: AWS::IAM::Role

