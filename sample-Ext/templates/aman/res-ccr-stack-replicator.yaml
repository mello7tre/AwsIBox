AWSTemplateFormatVersion: '2010-09-09'
Conditions:
  BaseRegion:
    Fn::Equals:
      - eu-west-1
      - Ref: AWS::Region
  CCRReplicateRegionsOverride:
    Fn::Not:
      - Fn::Equals:
          - Fn::Select:
              - 0
              - Ref: CCRReplicateRegions
          - ''
  LambdaCCRStackReplicatorCodeS3KeyOverride:
    Fn::Not:
      - Fn::Equals:
          - Ref: LambdaCCRStackReplicatorCodeS3Key
          - ''
  MytestOverride:
    Fn::Not:
      - Fn::Equals:
          - Ref: Mytest
          - ''
Description: res-ccr-stack-replicator (Generated by awsibox 0.2.20) [res]
Outputs:
  BrandDomain:
    Value: aman.arda
  Env:
    Value:
      Ref: Env
  EnvRole:
    Value:
      Ref: EnvRole
  EnvStackVersion:
    Value:
      Ref: EnvStackVersion
  LambdaCCRStackReplicator:
    Export:
      Name: LambdaCCRStackReplicator
    Value:
      Fn::GetAtt:
        - LambdaCCRStackReplicator
        - Arn
  LambdaCCRStackReplicatorCodeS3Key:
    Value:
      Fn::If:
        - LambdaCCRStackReplicatorCodeS3KeyOverride
        - Ref: LambdaCCRStackReplicatorCodeS3Key
        - ibox-tools/stack-replicator/stack_replicator.zip
  Mytest:
    Value:
      Ref: Mytest
  StackType:
    Value: res
Parameters:
  CCRReplicateRegions:
    Default: ''
    Description: Regions where to replicate - None to disable - empty for default
      based on env/role
    Type: CommaDelimitedList
  Env:
    AllowedValues:
      - dev
      - stg
      - prod
    Default: dev
    Description: Environment
    Type: String
  EnvRole:
    AllowedPattern: ^[a-zA-Z0-9-_.]*$
    Default: ''
    Description: Service Role
    Type: String
  EnvShort:
    AllowedValues:
      - dev
      - stg
      - prd
    Default: dev
    Description: Environment Short - NEVER CHANGE!
    Type: String
  EnvStackVersion:
    Default: '1'
    Description: Stack version, if changed with UpdateMode=Cfn triggers cfn-hup
    Type: String
  LambdaCCRStackReplicatorCodeS3Key:
    Default: ''
    Description: S3Key Name for lambda CCRStackReplicator Code
    Type: String
  Mytest:
    Default: ''
    Description: ssm test to change
    Type: String
Resources:
  CloudFormationCustomResourceStackReplicator:
    DependsOn: IAMPolicyLambdaCCRStackReplicator
    Properties:
      CCRReplicateRegions:
        Fn::If:
          - CCRReplicateRegionsOverride
          - Ref: CCRReplicateRegions
          - - eu-west-1
            - eu-central-1
      Env:
        Ref: Env
      EnvRole:
        Ref: EnvRole
      EnvShort:
        Ref: EnvShort
      EnvStackVersion:
        Ref: EnvStackVersion
      LambdaCCRStackReplicatorCodeS3Key:
        Fn::If:
          - LambdaCCRStackReplicatorCodeS3KeyOverride
          - Ref: LambdaCCRStackReplicatorCodeS3Key
          - ibox-tools/stack-replicator/stack_replicator.zip
      Mytest:
        Fn::If:
          - MytestOverride
          - Ref: Mytest
          - gatto
      ServiceToken:
        Fn::GetAtt:
          - LambdaCCRStackReplicator
          - Arn
    Type: AWS::CloudFormation::CustomResource
  IAMPolicyLambdaCCRStackReplicator:
    Condition: LambdaCCRStackReplicator
    Properties:
      PolicyDocument:
        Statement:
          - Action:
              - '*'
            Effect: Allow
            Resource: '*'
        Version: '2012-10-17'
      PolicyName: LambdaCCRStackReplicator
      Roles:
        - Ref: RoleLambdaCCRStackReplicator
    Type: AWS::IAM::Policy
  LambdaCCRStackReplicator:
    Properties:
      Code:
        S3Bucket:
          Fn::Sub: ${AWS::Region}-arda-aman-app-repository
        S3Key:
          Fn::If:
            - LambdaCCRStackReplicatorCodeS3KeyOverride
            - Ref: LambdaCCRStackReplicatorCodeS3Key
            - ibox-tools/stack-replicator/stack_replicator.zip
      Description: Replicate Stacks
      Environment:
        Variables:
          Env:
            Ref: EnvShort
          EnvRole:
            Ref: EnvRole
      FunctionName:
        Fn::Sub: ${AWS::StackName}-${EnvRole}-CCRStackReplicator
      Handler: index.lambda_handler
      MemorySize: 128
      Role:
        Fn::GetAtt:
          - RoleLambdaCCRStackReplicator
          - Arn
      Runtime: python3.7
      Timeout: 300
    Type: AWS::Lambda::Function
  RoleLambdaCCRStackReplicator:
    Properties:
      AssumeRolePolicyDocument:
        Statement:
          - Action: sts:AssumeRole
            Effect: Allow
            Principal:
              Service:
                - lambda.amazonaws.com
                - Ref: AWS::NoValue
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/AmazonEC2ReadOnlyAccess
        - arn:aws:iam::aws:policy/service-role/AWSLambdaVPCAccessExecutionRole
      Path: /
    Type: AWS::IAM::Role

