AWSTemplateFormatVersion: '2010-09-09'
Conditions:
  BaseRegion:
    Fn::Equals:
      - eu-west-1
      - Ref: AWS::Region
  LambdaStacksOpsCodeS3KeyOverride:
    Fn::Not:
      - Fn::Equals:
          - Ref: LambdaStacksOpsCodeS3Key
          - ''
  LambdaStacksOpsLayers0:
    Fn::Or:
      - Fn::And:
          - Condition: LambdaStacksOpsLayers0Override
          - Fn::Not:
              - Fn::Equals:
                  - Ref: LambdaStacksOpsLayers0
                  - ''
      - Fn::And:
          - Fn::Not:
              - Condition: LambdaStacksOpsLayers0Override
          - Fn::Not:
              - Fn::Equals:
                  - Fn::Select:
                      - 0
                      - - Fn::Sub: arn:aws:lambda:${AWS::Region}:${AWS::AccountId}:layer:LambdaLayerVersionPython37SSM:1
                  - ''
  LambdaStacksOpsLayers0Override:
    Fn::Not:
      - Fn::Equals:
          - Ref: LambdaStacksOpsLayers0
          - ''
Description: stacks-ops (Generated by awsibox 0.2.20) [res]
Outputs:
  BrandDomain:
    Value: aman.arda
  Env:
    Value:
      Ref: Env
  EnvRole:
    Value:
      Ref: EnvRole
  EnvStackVersion:
    Value:
      Ref: EnvStackVersion
  LambdaStacksOpsCodeS3Key:
    Value:
      Fn::If:
        - LambdaStacksOpsCodeS3KeyOverride
        - Ref: LambdaStacksOpsCodeS3Key
        - ibox-tools/stacks-ops/stacks-ops-01.zip
  StackType:
    Value: res
Parameters:
  Env:
    AllowedValues:
      - dev
      - stg
      - prod
    Default: dev
    Description: Environment
    Type: String
  EnvRole:
    AllowedPattern: ^[a-zA-Z0-9-_.]*$
    Default: ''
    Description: Service Role
    Type: String
  EnvShort:
    AllowedValues:
      - dev
      - stg
      - prd
    Default: dev
    Description: Environment Short - NEVER CHANGE!
    Type: String
  EnvStackVersion:
    Default: '1'
    Description: Stack version, if changed with UpdateMode=Cfn triggers cfn-hup
    Type: String
  LambdaStacksOpsCodeS3Key:
    Default: ''
    Description: S3Key Name for lambda StacksOps Code
    Type: String
  LambdaStacksOpsLayers0:
    Default: ''
    Description: LambdaStacksOpsLayers0
    Type: String
Resources:
  IAMPolicyUpdateStack:
    Properties:
      PolicyDocument:
        Statement:
          - Action:
              - s3:Get*
              - s3:List*
              - s3:Put*
              - iam:PassRole
              - iam:ListServerCertificates
              - iam:GetRole
              - iam:PutRolePolicy
              - iam:GetInstanceProfile
              - elasticloadbalancing:*
              - ec2:*
              - ecs:*
              - ecr:*
              - sqs:*
              - sns:*
              - cloudwatch:*
              - autoscaling:*
              - route53:*
              - codedeploy:*
              - acm:*
              - cloudformation:DescribeStack*
              - cloudformation:GetTemplate*
              - cloudformation:ListStackResources
              - cloudformation:ListExports
              - cloudformation:UpdateStack
              - cloudformation:CancelUpdateStack
              - cloudformation:ValidateTemplate
              - cloudfront:GetDistribution*
              - cloudfront:ListDistributions
              - cloudfront:ListCloudFrontOriginAccessIdentities
              - lambda:*
              - events:*
              - waf:GetWebACL
              - waf:ListWebACLs
            Effect: Allow
            Resource: '*'
          - Action: ssm:GetParameter*
            Effect: Allow
            Resource:
              - arn:aws:ssm:*:*:parameter/aws/service/ecs/optimized-ami/amazon-linux/recommended/image_id
              - arn:aws:ssm:*:*:parameter/aws/service/ecs/optimized-ami/amazon-linux-2/recommended/image_id
              - arn:aws:ssm:*:*:parameter/aws/service/ami-amazon-linux-latest/amzn2-ami-hvm-x86_64-gp2
          - Action: ssm:GetParameter*
            Effect: Allow
            Resource: arn:aws:ssm:*:*:parameter/buildkite/*
          - Action:
              - ssm:DescribeParameters
              - kms:ListAliases
            Effect: Allow
            Resource: '*'
          - Action: kms:Decrypt
            Effect: Allow
            Resource:
              Fn::ImportValue: KeyParameterStore
        Version: '2012-10-17'
      PolicyName: UpdateStack
      Roles:
        - Ref: RoleLambdaStacksOps
    Type: AWS::IAM::Policy
  LambdaStacksOps:
    Properties:
      Code:
        S3Bucket:
          Fn::Sub: ${AWS::Region}-arda-aman-app-repository
        S3Key:
          Fn::If:
            - LambdaStacksOpsCodeS3KeyOverride
            - Ref: LambdaStacksOpsCodeS3Key
            - ibox-tools/stacks-ops/stacks-ops-01.zip
      Description: Stacks Operations
      Environment:
        Variables:
          CloudFormationNotificationArn:
            Fn::ImportValue: SNSTopicCloudFormationNotification
          Env:
            Ref: EnvShort
          EnvRole:
            Ref: EnvRole
      FunctionName:
        Fn::Sub: ${AWS::StackName}-${EnvRole}-StacksOps
      Handler: index.lambda_handler
      Layers:
        - Fn::If:
            - LambdaStacksOpsLayers0
            - Fn::If:
                - LambdaStacksOpsLayers0Override
                - Ref: LambdaStacksOpsLayers0
                - Fn::Select:
                    - 0
                    - - Fn::Sub: arn:aws:lambda:${AWS::Region}:${AWS::AccountId}:layer:LambdaLayerVersionPython37SSM:1
            - Ref: AWS::NoValue
      MemorySize: 128
      Role:
        Fn::GetAtt:
          - RoleLambdaStacksOps
          - Arn
      Runtime: python3.7
      Timeout: 60
    Type: AWS::Lambda::Function
  RoleLambdaStacksOps:
    Properties:
      AssumeRolePolicyDocument:
        Statement:
          - Action: sts:AssumeRole
            Effect: Allow
            Principal:
              Service:
                - lambda.amazonaws.com
                - Ref: AWS::NoValue
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/AmazonEC2ReadOnlyAccess
        - arn:aws:iam::aws:policy/service-role/AWSLambdaVPCAccessExecutionRole
      Path: /
    Type: AWS::IAM::Role

