AWSTemplateFormatVersion: '2010-09-09'
Conditions:
  AlarmBackendInternal5XX:
    Fn::Or:
      - Fn::And:
          - Condition: AlarmBackendInternal5XXEvaluationPeriodsOverride
          - Fn::Not:
              - Fn::Equals:
                  - Ref: AlarmBackendInternal5XXEvaluationPeriods
                  - '0'
      - Fn::And:
          - Fn::Not:
              - Condition: AlarmBackendInternal5XXEvaluationPeriodsOverride
          - Fn::Not:
              - Fn::Equals:
                  - Fn::FindInMap:
                      - Ref: EnvShort
                      - Ref: AWS::Region
                      - AlarmBackendInternal5XXEvaluationPeriods
                  - '0'
  AlarmBackendInternal5XXEvaluationPeriodsOverride:
    Fn::Not:
      - Fn::Equals:
          - Ref: AlarmBackendInternal5XXEvaluationPeriods
          - ''
  AlarmBackendInternal5XXThresholdOverride:
    Fn::Not:
      - Fn::Equals:
          - Ref: AlarmBackendInternal5XXThreshold
          - ''
  AlarmCPUHigh:
    Fn::Or:
      - Fn::And:
          - Condition: AlarmCPUHighEvaluationPeriodsOverride
          - Fn::Not:
              - Fn::Equals:
                  - Ref: AlarmCPUHighEvaluationPeriods
                  - '0'
      - Fn::And:
          - Fn::Not:
              - Condition: AlarmCPUHighEvaluationPeriodsOverride
          - Fn::Not:
              - Fn::Equals:
                  - 0
                  - '0'
  AlarmCPUHighEvaluationPeriodsOverride:
    Fn::Not:
      - Fn::Equals:
          - Ref: AlarmCPUHighEvaluationPeriods
          - ''
  AlarmCPUHighThresholdOverride:
    Fn::Not:
      - Fn::Equals:
          - Ref: AlarmCPUHighThreshold
          - ''
  AlarmCPULow:
    Fn::Or:
      - Fn::And:
          - Condition: AlarmCPULowEvaluationPeriodsOverride
          - Fn::Not:
              - Fn::Equals:
                  - Ref: AlarmCPULowEvaluationPeriods
                  - '0'
      - Fn::And:
          - Fn::Not:
              - Condition: AlarmCPULowEvaluationPeriodsOverride
          - Fn::Not:
              - Fn::Equals:
                  - 0
                  - '0'
  AlarmCPULowEvaluationPeriodsOverride:
    Fn::Not:
      - Fn::Equals:
          - Ref: AlarmCPULowEvaluationPeriods
          - ''
  AlarmCPULowThresholdOverride:
    Fn::Not:
      - Fn::Equals:
          - Ref: AlarmCPULowThreshold
          - ''
  AlarmDiskUsed:
    Fn::Or:
      - Fn::And:
          - Condition: AlarmDiskUsedEvaluationPeriodsOverride
          - Fn::Not:
              - Fn::Equals:
                  - Ref: AlarmDiskUsedEvaluationPeriods
                  - '0'
      - Fn::And:
          - Fn::Not:
              - Condition: AlarmDiskUsedEvaluationPeriodsOverride
          - Fn::Not:
              - Fn::Equals:
                  - 3
                  - '0'
  AlarmDiskUsedEvaluationPeriodsOverride:
    Fn::Not:
      - Fn::Equals:
          - Ref: AlarmDiskUsedEvaluationPeriods
          - ''
  AlarmDiskUsedThresholdOverride:
    Fn::Not:
      - Fn::Equals:
          - Ref: AlarmDiskUsedThreshold
          - ''
  AutoScalingGroupBaseHealthCheckGracePeriodOverride:
    Fn::Not:
      - Fn::Equals:
          - Ref: AutoScalingGroupBaseHealthCheckGracePeriod
          - ''
  BaseRegion:
    Fn::Equals:
      - eu-west-1
      - Ref: AWS::Region
  CapacityDesiredOverride:
    Fn::Not:
      - Fn::Equals:
          - Ref: CapacityDesired
          - ''
  CapacityMaxOverride:
    Fn::Not:
      - Fn::Equals:
          - Ref: CapacityMax
          - ''
  CapacityMinOverride:
    Fn::Not:
      - Fn::Equals:
          - Ref: CapacityMin
          - ''
  CloudFormationInit:
    Fn::Equals:
      - Ref: UpdateMode
      - Cfn
  CloudWatchAgent:
    Fn::Or:
      - Fn::And:
          - Condition: CloudWatchAgentOverride
          - Fn::Not:
              - Fn::Equals:
                  - Ref: CloudWatchAgent
                  - None
      - Fn::And:
          - Fn::Not:
              - Condition: CloudWatchAgentOverride
          - Fn::Not:
              - Fn::Equals:
                  - None
                  - None
  CloudWatchAgentOverride:
    Fn::Not:
      - Fn::Equals:
          - Ref: CloudWatchAgent
          - ''
  DoNotSignal:
    Fn::And:
      - Condition: RollingUpdate
      - Fn::Equals:
          - Ref: DoNotSignal
          - 'True'
  EfsMounts:
    Fn::Not:
      - Fn::Equals:
          - Fn::Select:
              - '0'
              - Ref: EfsMounts
          - ''
  EventsRuleElasticSearchSnapShotScheduleExpressionOverride:
    Fn::Not:
      - Fn::Equals:
          - Ref: EventsRuleElasticSearchSnapShotScheduleExpression
          - ''
  EventsRuleElasticSearchSnapShotStateOverride:
    Fn::Not:
      - Fn::Equals:
          - Ref: EventsRuleElasticSearchSnapShotState
          - ''
  InstaceEphemeral0:
    Fn::Or:
      - Fn::And:
          - Condition: LaunchTemplateDataInstanceTypeOverride
          - Fn::Equals:
              - Fn::FindInMap:
                  - InstanceTypes
                  - Ref: LaunchTemplateDataInstanceType
                  - InstaceEphemeral0
              - '1'
      - Fn::And:
          - Fn::Not:
              - Condition: LaunchTemplateDataInstanceTypeOverride
          - Fn::Equals:
              - Fn::FindInMap:
                  - InstanceTypes
                  - Fn::FindInMap:
                      - Ref: EnvShort
                      - Ref: AWS::Region
                      - LaunchTemplateDataInstanceType
                  - InstaceEphemeral0
              - '1'
  InstaceEphemeral1:
    Fn::Or:
      - Fn::And:
          - Condition: LaunchTemplateDataInstanceTypeOverride
          - Fn::Equals:
              - Fn::FindInMap:
                  - InstanceTypes
                  - Ref: LaunchTemplateDataInstanceType
                  - InstaceEphemeral1
              - '1'
      - Fn::And:
          - Fn::Not:
              - Condition: LaunchTemplateDataInstanceTypeOverride
          - Fn::Equals:
              - Fn::FindInMap:
                  - InstanceTypes
                  - Fn::FindInMap:
                      - Ref: EnvShort
                      - Ref: AWS::Region
                      - LaunchTemplateDataInstanceType
                  - InstaceEphemeral1
              - '1'
  InstaceEphemeral2:
    Fn::Or:
      - Fn::And:
          - Condition: LaunchTemplateDataInstanceTypeOverride
          - Fn::Equals:
              - Fn::FindInMap:
                  - InstanceTypes
                  - Ref: LaunchTemplateDataInstanceType
                  - InstaceEphemeral2
              - '1'
      - Fn::And:
          - Fn::Not:
              - Condition: LaunchTemplateDataInstanceTypeOverride
          - Fn::Equals:
              - Fn::FindInMap:
                  - InstanceTypes
                  - Fn::FindInMap:
                      - Ref: EnvShort
                      - Ref: AWS::Region
                      - LaunchTemplateDataInstanceType
                  - InstaceEphemeral2
              - '1'
  LaunchTemplateDataBlockDeviceMappingsAdditionalStorage:
    Fn::Or:
      - Fn::And:
          - Condition: LaunchTemplateDataBlockDeviceMappingsAdditionalStorageEbsVolumeSizeOverride
          - Fn::Not:
              - Fn::Equals:
                  - Ref: LaunchTemplateDataBlockDeviceMappingsAdditionalStorageEbsVolumeSize
                  - '0'
      - Fn::And:
          - Fn::Not:
              - Condition: LaunchTemplateDataBlockDeviceMappingsAdditionalStorageEbsVolumeSizeOverride
          - Fn::Not:
              - Fn::Equals:
                  - 0
                  - '0'
  LaunchTemplateDataBlockDeviceMappingsAdditionalStorageEbsVolumeSizeOverride:
    Fn::Not:
      - Fn::Equals:
          - Ref: LaunchTemplateDataBlockDeviceMappingsAdditionalStorageEbsVolumeSize
          - ''
  LaunchTemplateDataBlockDeviceMappingsAdditionalStorageMount:
    Fn::And:
      - Condition: LaunchTemplateDataBlockDeviceMappingsAdditionalStorage
      - Fn::Not:
          - Fn::Equals:
              - true
              - None
  LaunchTemplateDataBlockDeviceMappingsXvdaEbsVolumeSizeOverride:
    Fn::Not:
      - Fn::Equals:
          - Ref: LaunchTemplateDataBlockDeviceMappingsXvdaEbsVolumeSize
          - ''
  LaunchTemplateDataImageIdLatest:
    Fn::Or:
      - Fn::And:
          - Condition: LaunchTemplateDataImageIdOverride
          - Fn::Equals:
              - Ref: LaunchTemplateDataImageId
              - latest
      - Fn::And:
          - Fn::Not:
              - Condition: LaunchTemplateDataImageIdOverride
          - Fn::Equals:
              - Fn::FindInMap:
                  - Ref: EnvShort
                  - Ref: AWS::Region
                  - LaunchTemplateDataImageId
              - latest
  LaunchTemplateDataImageIdOverride:
    Fn::Not:
      - Fn::Equals:
          - Ref: LaunchTemplateDataImageId
          - ''
  LaunchTemplateDataInstanceMarketOptionsSpotOptionsMaxPrice:
    Fn::Or:
      - Fn::And:
          - Condition: LaunchTemplateDataInstanceMarketOptionsSpotOptionsMaxPriceOverride
          - Fn::Not:
              - Fn::Equals:
                  - Ref: LaunchTemplateDataInstanceMarketOptionsSpotOptionsMaxPrice
                  - '0'
      - Fn::And:
          - Fn::Not:
              - Condition: LaunchTemplateDataInstanceMarketOptionsSpotOptionsMaxPriceOverride
          - Fn::Not:
              - Fn::Equals:
                  - '0'
                  - '0'
  LaunchTemplateDataInstanceMarketOptionsSpotOptionsMaxPriceOverride:
    Fn::Not:
      - Fn::Equals:
          - Ref: LaunchTemplateDataInstanceMarketOptionsSpotOptionsMaxPrice
          - ''
  LaunchTemplateDataInstanceTypeOverride:
    Fn::Not:
      - Fn::Equals:
          - Ref: LaunchTemplateDataInstanceType
          - default
  LaunchTemplateDataKeyNameOverride:
    Fn::Not:
      - Fn::Equals:
          - Ref: LaunchTemplateDataKeyName
          - ''
  ListenerLoadBalancerHttpPort:
    Fn::Or:
      - Fn::And:
          - Condition: ListenerLoadBalancerHttpPortOverride
          - Fn::Not:
              - Fn::Equals:
                  - Ref: ListenerLoadBalancerHttpPort
                  - None
      - Fn::And:
          - Fn::Not:
              - Condition: ListenerLoadBalancerHttpPortOverride
          - Fn::Not:
              - Fn::Equals:
                  - 80
                  - None
  ListenerLoadBalancerHttpPortOverride:
    Fn::Not:
      - Fn::Equals:
          - Ref: ListenerLoadBalancerHttpPort
          - ''
  ListenerLoadBalancerHttpsPort:
    Fn::Or:
      - Fn::And:
          - Condition: ListenerLoadBalancerHttpsPortOverride
          - Fn::Not:
              - Fn::Equals:
                  - Ref: ListenerLoadBalancerHttpsPort
                  - None
      - Fn::And:
          - Fn::Not:
              - Condition: ListenerLoadBalancerHttpsPortOverride
          - Fn::Not:
              - Fn::Equals:
                  - 443
                  - None
  ListenerLoadBalancerHttpsPortOverride:
    Fn::Not:
      - Fn::Equals:
          - Ref: ListenerLoadBalancerHttpsPort
          - ''
  LoadBalancerCookieSticky:
    Fn::Not:
      - Fn::Equals:
          - None
          - None
  LoadBalancerLog:
    Fn::Or:
      - Fn::And:
          - Condition: LoadBalancerLogOverride
          - Fn::Not:
              - Fn::Equals:
                  - Ref: LoadBalancerLog
                  - None
      - Fn::And:
          - Fn::Not:
              - Condition: LoadBalancerLogOverride
          - Fn::Not:
              - Fn::Equals:
                  - None
                  - None
  LoadBalancerLogOverride:
    Fn::Not:
      - Fn::Equals:
          - Ref: LoadBalancerLog
          - ''
  RollingUpdate:
    Fn::Equals:
      - Ref: UpdateMode
      - Rolling
  ScheduledActionDown:
    Fn::Or:
      - Fn::And:
          - Condition: ScheduledActionDownRecurrenceOverride
          - Fn::Not:
              - Fn::Equals:
                  - Ref: ScheduledActionDownRecurrence
                  - None
      - Fn::And:
          - Fn::Not:
              - Condition: ScheduledActionDownRecurrenceOverride
          - Fn::Not:
              - Fn::Equals:
                  - 00 19 * * *
                  - None
  ScheduledActionDownCapacityDesiredSize:
    Fn::Or:
      - Fn::And:
          - Condition: ScheduledActionDownDesiredSizeOverride
          - Fn::Equals:
              - Ref: ScheduledActionDownDesiredSize
              - CapacityDesired
      - Fn::And:
          - Fn::Not:
              - Condition: ScheduledActionDownDesiredSizeOverride
          - Fn::Equals:
              - Fn::FindInMap:
                  - Ref: EnvShort
                  - Ref: AWS::Region
                  - ScheduledActionDownDesiredSize
              - CapacityDesired
  ScheduledActionDownCapacityMaxSize:
    Fn::Or:
      - Fn::And:
          - Condition: ScheduledActionDownMaxSizeOverride
          - Fn::Equals:
              - Ref: ScheduledActionDownMaxSize
              - CapacityMax
      - Fn::And:
          - Fn::Not:
              - Condition: ScheduledActionDownMaxSizeOverride
          - Fn::Equals:
              - CapacityMax
              - CapacityMax
  ScheduledActionDownCapacityMinSize:
    Fn::Or:
      - Fn::And:
          - Condition: ScheduledActionDownMinSizeOverride
          - Fn::Equals:
              - Ref: ScheduledActionDownMinSize
              - CapacityMin
      - Fn::And:
          - Fn::Not:
              - Condition: ScheduledActionDownMinSizeOverride
          - Fn::Equals:
              - CapacityMin
              - CapacityMin
  ScheduledActionDownDesiredSizeOverride:
    Fn::Not:
      - Fn::Equals:
          - Ref: ScheduledActionDownDesiredSize
          - ''
  ScheduledActionDownKeepDesiredSize:
    Fn::Or:
      - Fn::And:
          - Condition: ScheduledActionDownDesiredSizeOverride
          - Fn::Equals:
              - Ref: ScheduledActionDownDesiredSize
              - k
      - Fn::And:
          - Fn::Not:
              - Condition: ScheduledActionDownDesiredSizeOverride
          - Fn::Equals:
              - Fn::FindInMap:
                  - Ref: EnvShort
                  - Ref: AWS::Region
                  - ScheduledActionDownDesiredSize
              - k
  ScheduledActionDownKeepMaxSize:
    Fn::Or:
      - Fn::And:
          - Condition: ScheduledActionDownMaxSizeOverride
          - Fn::Equals:
              - Ref: ScheduledActionDownMaxSize
              - k
      - Fn::And:
          - Fn::Not:
              - Condition: ScheduledActionDownMaxSizeOverride
          - Fn::Equals:
              - CapacityMax
              - k
  ScheduledActionDownKeepMinSize:
    Fn::Or:
      - Fn::And:
          - Condition: ScheduledActionDownMinSizeOverride
          - Fn::Equals:
              - Ref: ScheduledActionDownMinSize
              - k
      - Fn::And:
          - Fn::Not:
              - Condition: ScheduledActionDownMinSizeOverride
          - Fn::Equals:
              - CapacityMin
              - k
  ScheduledActionDownMaxSizeOverride:
    Fn::Not:
      - Fn::Equals:
          - Ref: ScheduledActionDownMaxSize
          - ''
  ScheduledActionDownMinSizeOverride:
    Fn::Not:
      - Fn::Equals:
          - Ref: ScheduledActionDownMinSize
          - ''
  ScheduledActionDownRecurrenceOverride:
    Fn::Not:
      - Fn::Equals:
          - Ref: ScheduledActionDownRecurrence
          - ''
  ScheduledActionDownStartTimeOverride:
    Fn::Not:
      - Fn::Equals:
          - Ref: ScheduledActionDownStartTime
          - ''
  ScheduledActionUp:
    Fn::Or:
      - Fn::And:
          - Condition: ScheduledActionUpRecurrenceOverride
          - Fn::Not:
              - Fn::Equals:
                  - Ref: ScheduledActionUpRecurrence
                  - None
      - Fn::And:
          - Fn::Not:
              - Condition: ScheduledActionUpRecurrenceOverride
          - Fn::Not:
              - Fn::Equals:
                  - 30 08 * * mon-fri
                  - None
  ScheduledActionUpCapacityDesiredSize:
    Fn::Or:
      - Fn::And:
          - Condition: ScheduledActionUpDesiredSizeOverride
          - Fn::Equals:
              - Ref: ScheduledActionUpDesiredSize
              - CapacityDesired
      - Fn::And:
          - Fn::Not:
              - Condition: ScheduledActionUpDesiredSizeOverride
          - Fn::Equals:
              - CapacityDesired
              - CapacityDesired
  ScheduledActionUpCapacityMaxSize:
    Fn::Or:
      - Fn::And:
          - Condition: ScheduledActionUpMaxSizeOverride
          - Fn::Equals:
              - Ref: ScheduledActionUpMaxSize
              - CapacityMax
      - Fn::And:
          - Fn::Not:
              - Condition: ScheduledActionUpMaxSizeOverride
          - Fn::Equals:
              - CapacityMax
              - CapacityMax
  ScheduledActionUpCapacityMinSize:
    Fn::Or:
      - Fn::And:
          - Condition: ScheduledActionUpMinSizeOverride
          - Fn::Equals:
              - Ref: ScheduledActionUpMinSize
              - CapacityMin
      - Fn::And:
          - Fn::Not:
              - Condition: ScheduledActionUpMinSizeOverride
          - Fn::Equals:
              - CapacityMin
              - CapacityMin
  ScheduledActionUpDesiredSizeOverride:
    Fn::Not:
      - Fn::Equals:
          - Ref: ScheduledActionUpDesiredSize
          - ''
  ScheduledActionUpKeepDesiredSize:
    Fn::Or:
      - Fn::And:
          - Condition: ScheduledActionUpDesiredSizeOverride
          - Fn::Equals:
              - Ref: ScheduledActionUpDesiredSize
              - k
      - Fn::And:
          - Fn::Not:
              - Condition: ScheduledActionUpDesiredSizeOverride
          - Fn::Equals:
              - CapacityDesired
              - k
  ScheduledActionUpKeepMaxSize:
    Fn::Or:
      - Fn::And:
          - Condition: ScheduledActionUpMaxSizeOverride
          - Fn::Equals:
              - Ref: ScheduledActionUpMaxSize
              - k
      - Fn::And:
          - Fn::Not:
              - Condition: ScheduledActionUpMaxSizeOverride
          - Fn::Equals:
              - CapacityMax
              - k
  ScheduledActionUpKeepMinSize:
    Fn::Or:
      - Fn::And:
          - Condition: ScheduledActionUpMinSizeOverride
          - Fn::Equals:
              - Ref: ScheduledActionUpMinSize
              - k
      - Fn::And:
          - Fn::Not:
              - Condition: ScheduledActionUpMinSizeOverride
          - Fn::Equals:
              - CapacityMin
              - k
  ScheduledActionUpMaxSizeOverride:
    Fn::Not:
      - Fn::Equals:
          - Ref: ScheduledActionUpMaxSize
          - ''
  ScheduledActionUpMinSizeOverride:
    Fn::Not:
      - Fn::Equals:
          - Ref: ScheduledActionUpMinSize
          - ''
  ScheduledActionUpRecurrenceOverride:
    Fn::Not:
      - Fn::Equals:
          - Ref: ScheduledActionUpRecurrence
          - ''
  ScheduledActionUpStartTimeOverride:
    Fn::Not:
      - Fn::Equals:
          - Ref: ScheduledActionUpStartTime
          - ''
  SecurityGroup0:
    Fn::Not:
      - Fn::Or:
          - Fn::And:
              - Condition: SecurityGroupsOverride
              - Fn::Equals:
                  - Fn::Select:
                      - 0
                      - Fn::Split:
                          - ','
                          - Ref: SecurityGroups
                  - None
          - Fn::And:
              - Fn::Not:
                  - Condition: SecurityGroupsOverride
              - Fn::Equals:
                  - Fn::Select:
                      - 0
                      - Fn::Split:
                          - ','
                          - BaseInstance,ElasticSearch,None,None
                  - None
  SecurityGroup1:
    Fn::Not:
      - Fn::Or:
          - Fn::And:
              - Condition: SecurityGroupsOverride
              - Fn::Equals:
                  - Fn::Select:
                      - 1
                      - Fn::Split:
                          - ','
                          - Ref: SecurityGroups
                  - None
          - Fn::And:
              - Fn::Not:
                  - Condition: SecurityGroupsOverride
              - Fn::Equals:
                  - Fn::Select:
                      - 1
                      - Fn::Split:
                          - ','
                          - BaseInstance,ElasticSearch,None,None
                  - None
  SecurityGroup2:
    Fn::Not:
      - Fn::Or:
          - Fn::And:
              - Condition: SecurityGroupsOverride
              - Fn::Equals:
                  - Fn::Select:
                      - 2
                      - Fn::Split:
                          - ','
                          - Ref: SecurityGroups
                  - None
          - Fn::And:
              - Fn::Not:
                  - Condition: SecurityGroupsOverride
              - Fn::Equals:
                  - Fn::Select:
                      - 2
                      - Fn::Split:
                          - ','
                          - BaseInstance,ElasticSearch,None,None
                  - None
  SecurityGroup3:
    Fn::Not:
      - Fn::Or:
          - Fn::And:
              - Condition: SecurityGroupsOverride
              - Fn::Equals:
                  - Fn::Select:
                      - 3
                      - Fn::Split:
                          - ','
                          - Ref: SecurityGroups
                  - None
          - Fn::And:
              - Fn::Not:
                  - Condition: SecurityGroupsOverride
              - Fn::Equals:
                  - Fn::Select:
                      - 3
                      - Fn::Split:
                          - ','
                          - BaseInstance,ElasticSearch,None,None
                  - None
  SecurityGroupsOverride:
    Fn::Not:
      - Fn::Equals:
          - Ref: SecurityGroups
          - ',,,'
  Spot:
    Fn::Or:
      - Condition: SpotAuto
      - Condition: LaunchTemplateDataInstanceMarketOptionsSpotOptionsMaxPrice
  SpotAuto:
    Fn::Or:
      - Fn::And:
          - Condition: SpotAutoOverride
          - Fn::Not:
              - Fn::Equals:
                  - Ref: SpotAuto
                  - None
      - Fn::And:
          - Fn::Not:
              - Condition: SpotAutoOverride
          - Fn::Not:
              - Fn::Equals:
                  - None
                  - None
  SpotAutoAllowedInstances:
    Fn::And:
      - Condition: SpotAuto
      - Fn::Or:
          - Fn::And:
              - Condition: SpotAutoAllowedInstancesOverride
              - Fn::Not:
                  - Fn::Equals:
                      - Ref: SpotAutoAllowedInstances
                      - None
          - Fn::And:
              - Fn::Not:
                  - Condition: SpotAutoAllowedInstancesOverride
              - Fn::Not:
                  - Fn::Equals:
                      - None
                      - None
  SpotAutoAllowedInstancesOverride:
    Fn::Not:
      - Fn::Equals:
          - Ref: SpotAutoAllowedInstances
          - ''
  SpotAutoMinOnDemandNumber:
    Fn::And:
      - Condition: SpotAuto
      - Fn::Or:
          - Fn::And:
              - Condition: SpotAutoMinOnDemandNumberOverride
              - Fn::Not:
                  - Fn::Equals:
                      - Ref: SpotAutoMinOnDemandNumber
                      - None
          - Fn::And:
              - Fn::Not:
                  - Condition: SpotAutoMinOnDemandNumberOverride
              - Fn::Not:
                  - Fn::Equals:
                      - None
                      - None
  SpotAutoMinOnDemandNumberOverride:
    Fn::Not:
      - Fn::Equals:
          - Ref: SpotAutoMinOnDemandNumber
          - ''
  SpotAutoOverride:
    Fn::Not:
      - Fn::Equals:
          - Ref: SpotAuto
          - ''
  TargetGroupCookieSticky:
    Fn::Not:
      - Fn::Equals:
          - None
          - None
  WillReplace:
    Fn::Equals:
      - Ref: UpdateMode
      - Replace
Description: elasticsearch (Generated by awsibox 0.2.20) [ec2]
Mappings:
  InstanceTypes:
    a1.2xlarge:
      InstaceEphemeral0: '0'
      InstaceEphemeral1: '0'
      InstaceEphemeral2: '0'
    a1.4xlarge:
      InstaceEphemeral0: '0'
      InstaceEphemeral1: '0'
      InstaceEphemeral2: '0'
    a1.large:
      InstaceEphemeral0: '0'
      InstaceEphemeral1: '0'
      InstaceEphemeral2: '0'
    a1.medium:
      InstaceEphemeral0: '0'
      InstaceEphemeral1: '0'
      InstaceEphemeral2: '0'
    a1.xlarge:
      InstaceEphemeral0: '0'
      InstaceEphemeral1: '0'
      InstaceEphemeral2: '0'
    c3.2xlarge:
      InstaceEphemeral0: '1'
      InstaceEphemeral1: '1'
      InstaceEphemeral2: '0'
    c3.4xlarge:
      InstaceEphemeral0: '1'
      InstaceEphemeral1: '1'
      InstaceEphemeral2: '0'
    c3.large:
      InstaceEphemeral0: '1'
      InstaceEphemeral1: '1'
      InstaceEphemeral2: '0'
    c3.xlarge:
      InstaceEphemeral0: '1'
      InstaceEphemeral1: '1'
      InstaceEphemeral2: '0'
    c4.2xlarge:
      InstaceEphemeral0: '0'
      InstaceEphemeral1: '0'
      InstaceEphemeral2: '0'
    c4.4xlarge:
      InstaceEphemeral0: '0'
      InstaceEphemeral1: '0'
      InstaceEphemeral2: '0'
    c4.large:
      InstaceEphemeral0: '0'
      InstaceEphemeral1: '0'
      InstaceEphemeral2: '0'
    c4.xlarge:
      InstaceEphemeral0: '0'
      InstaceEphemeral1: '0'
      InstaceEphemeral2: '0'
    c5.12xlarge:
      InstaceEphemeral0: '0'
      InstaceEphemeral1: '0'
      InstaceEphemeral2: '0'
    c5.18xlarge:
      InstaceEphemeral0: '0'
      InstaceEphemeral1: '0'
      InstaceEphemeral2: '0'
    c5.24xlarge:
      InstaceEphemeral0: '0'
      InstaceEphemeral1: '0'
      InstaceEphemeral2: '0'
    c5.2xlarge:
      InstaceEphemeral0: '0'
      InstaceEphemeral1: '0'
      InstaceEphemeral2: '0'
    c5.4xlarge:
      InstaceEphemeral0: '0'
      InstaceEphemeral1: '0'
      InstaceEphemeral2: '0'
    c5.9xlarge:
      InstaceEphemeral0: '0'
      InstaceEphemeral1: '0'
      InstaceEphemeral2: '0'
    c5.large:
      InstaceEphemeral0: '0'
      InstaceEphemeral1: '0'
      InstaceEphemeral2: '0'
    c5.xlarge:
      InstaceEphemeral0: '0'
      InstaceEphemeral1: '0'
      InstaceEphemeral2: '0'
    c5a.12xlarge:
      InstaceEphemeral0: '0'
      InstaceEphemeral1: '0'
      InstaceEphemeral2: '0'
    c5a.16xlarge:
      InstaceEphemeral0: '0'
      InstaceEphemeral1: '0'
      InstaceEphemeral2: '0'
    c5a.24xlarge:
      InstaceEphemeral0: '0'
      InstaceEphemeral1: '0'
      InstaceEphemeral2: '0'
    c5a.2xlarge:
      InstaceEphemeral0: '0'
      InstaceEphemeral1: '0'
      InstaceEphemeral2: '0'
    c5a.4xlarge:
      InstaceEphemeral0: '0'
      InstaceEphemeral1: '0'
      InstaceEphemeral2: '0'
    c5a.8xlarge:
      InstaceEphemeral0: '0'
      InstaceEphemeral1: '0'
      InstaceEphemeral2: '0'
    c5a.large:
      InstaceEphemeral0: '0'
      InstaceEphemeral1: '0'
      InstaceEphemeral2: '0'
    c5a.xlarge:
      InstaceEphemeral0: '0'
      InstaceEphemeral1: '0'
      InstaceEphemeral2: '0'
    d2.2xlarge:
      InstaceEphemeral0: '1'
      InstaceEphemeral1: '1'
      InstaceEphemeral2: '1'
    d2.4xlarge:
      InstaceEphemeral0: '1'
      InstaceEphemeral1: '1'
      InstaceEphemeral2: '1'
    d2.xlarge:
      InstaceEphemeral0: '1'
      InstaceEphemeral1: '1'
      InstaceEphemeral2: '1'
    default:
      InstaceEphemeral0: '0'
      InstaceEphemeral1: '0'
      InstaceEphemeral2: '0'
    g2.2xlarge:
      InstaceEphemeral0: '1'
      InstaceEphemeral1: '0'
      InstaceEphemeral2: '0'
    g3s.xlarge:
      InstaceEphemeral0: '0'
      InstaceEphemeral1: '0'
      InstaceEphemeral2: '0'
    i2.2xlarge:
      InstaceEphemeral0: '1'
      InstaceEphemeral1: '1'
      InstaceEphemeral2: '0'
    i2.4xlarge:
      InstaceEphemeral0: '1'
      InstaceEphemeral1: '1'
      InstaceEphemeral2: '1'
    i2.xlarge:
      InstaceEphemeral0: '1'
      InstaceEphemeral1: '0'
      InstaceEphemeral2: '0'
    m3.2xlarge:
      InstaceEphemeral0: '1'
      InstaceEphemeral1: '1'
      InstaceEphemeral2: '0'
    m3.large:
      InstaceEphemeral0: '1'
      InstaceEphemeral1: '0'
      InstaceEphemeral2: '0'
    m3.medium:
      InstaceEphemeral0: '1'
      InstaceEphemeral1: '0'
      InstaceEphemeral2: '0'
    m3.xlarge:
      InstaceEphemeral0: '1'
      InstaceEphemeral1: '1'
      InstaceEphemeral2: '0'
    m4.2xlarge:
      InstaceEphemeral0: '0'
      InstaceEphemeral1: '0'
      InstaceEphemeral2: '0'
    m4.4xlarge:
      InstaceEphemeral0: '0'
      InstaceEphemeral1: '0'
      InstaceEphemeral2: '0'
    m4.large:
      InstaceEphemeral0: '0'
      InstaceEphemeral1: '0'
      InstaceEphemeral2: '0'
    m4.xlarge:
      InstaceEphemeral0: '0'
      InstaceEphemeral1: '0'
      InstaceEphemeral2: '0'
    m5.12xlarge:
      InstaceEphemeral0: '0'
      InstaceEphemeral1: '0'
      InstaceEphemeral2: '0'
    m5.16xlarge:
      InstaceEphemeral0: '0'
      InstaceEphemeral1: '0'
      InstaceEphemeral2: '0'
    m5.24xlarge:
      InstaceEphemeral0: '0'
      InstaceEphemeral1: '0'
      InstaceEphemeral2: '0'
    m5.2xlarge:
      InstaceEphemeral0: '0'
      InstaceEphemeral1: '0'
      InstaceEphemeral2: '0'
    m5.4xlarge:
      InstaceEphemeral0: '0'
      InstaceEphemeral1: '0'
      InstaceEphemeral2: '0'
    m5.8xlarge:
      InstaceEphemeral0: '0'
      InstaceEphemeral1: '0'
      InstaceEphemeral2: '0'
    m5.large:
      InstaceEphemeral0: '0'
      InstaceEphemeral1: '0'
      InstaceEphemeral2: '0'
    m5.xlarge:
      InstaceEphemeral0: '0'
      InstaceEphemeral1: '0'
      InstaceEphemeral2: '0'
    m5a.12xlarge:
      InstaceEphemeral0: '0'
      InstaceEphemeral1: '0'
      InstaceEphemeral2: '0'
    m5a.16xlarge:
      InstaceEphemeral0: '0'
      InstaceEphemeral1: '0'
      InstaceEphemeral2: '0'
    m5a.24xlarge:
      InstaceEphemeral0: '0'
      InstaceEphemeral1: '0'
      InstaceEphemeral2: '0'
    m5a.2xlarge:
      InstaceEphemeral0: '0'
      InstaceEphemeral1: '0'
      InstaceEphemeral2: '0'
    m5a.4xlarge:
      InstaceEphemeral0: '0'
      InstaceEphemeral1: '0'
      InstaceEphemeral2: '0'
    m5a.8xlarge:
      InstaceEphemeral0: '0'
      InstaceEphemeral1: '0'
      InstaceEphemeral2: '0'
    m5a.large:
      InstaceEphemeral0: '0'
      InstaceEphemeral1: '0'
      InstaceEphemeral2: '0'
    m5a.xlarge:
      InstaceEphemeral0: '0'
      InstaceEphemeral1: '0'
      InstaceEphemeral2: '0'
    r3.2xlarge:
      InstaceEphemeral0: '1'
      InstaceEphemeral1: '0'
      InstaceEphemeral2: '0'
    r3.4xlarge:
      InstaceEphemeral0: '1'
      InstaceEphemeral1: '0'
      InstaceEphemeral2: '0'
    r3.large:
      InstaceEphemeral0: '1'
      InstaceEphemeral1: '0'
      InstaceEphemeral2: '0'
    r3.xlarge:
      InstaceEphemeral0: '1'
      InstaceEphemeral1: '0'
      InstaceEphemeral2: '0'
    r4.2xlarge:
      InstaceEphemeral0: '0'
      InstaceEphemeral1: '0'
      InstaceEphemeral2: '0'
    r4.4xlarge:
      InstaceEphemeral0: '0'
      InstaceEphemeral1: '0'
      InstaceEphemeral2: '0'
    r4.large:
      InstaceEphemeral0: '0'
      InstaceEphemeral1: '0'
      InstaceEphemeral2: '0'
    r4.xlarge:
      InstaceEphemeral0: '0'
      InstaceEphemeral1: '0'
      InstaceEphemeral2: '0'
    r5.12xlarge:
      InstaceEphemeral0: '0'
      InstaceEphemeral1: '0'
      InstaceEphemeral2: '0'
    r5.16xlarge:
      InstaceEphemeral0: '0'
      InstaceEphemeral1: '0'
      InstaceEphemeral2: '0'
    r5.24xlarge:
      InstaceEphemeral0: '0'
      InstaceEphemeral1: '0'
      InstaceEphemeral2: '0'
    r5.2xlarge:
      InstaceEphemeral0: '0'
      InstaceEphemeral1: '0'
      InstaceEphemeral2: '0'
    r5.4xlarge:
      InstaceEphemeral0: '0'
      InstaceEphemeral1: '0'
      InstaceEphemeral2: '0'
    r5.8xlarge:
      InstaceEphemeral0: '0'
      InstaceEphemeral1: '0'
      InstaceEphemeral2: '0'
    r5.large:
      InstaceEphemeral0: '0'
      InstaceEphemeral1: '0'
      InstaceEphemeral2: '0'
    r5.xlarge:
      InstaceEphemeral0: '0'
      InstaceEphemeral1: '0'
      InstaceEphemeral2: '0'
    r5a.12xlarge:
      InstaceEphemeral0: '0'
      InstaceEphemeral1: '0'
      InstaceEphemeral2: '0'
    r5a.16xlarge:
      InstaceEphemeral0: '0'
      InstaceEphemeral1: '0'
      InstaceEphemeral2: '0'
    r5a.24xlarge:
      InstaceEphemeral0: '0'
      InstaceEphemeral1: '0'
      InstaceEphemeral2: '0'
    r5a.2xlarge:
      InstaceEphemeral0: '0'
      InstaceEphemeral1: '0'
      InstaceEphemeral2: '0'
    r5a.4xlarge:
      InstaceEphemeral0: '0'
      InstaceEphemeral1: '0'
      InstaceEphemeral2: '0'
    r5a.8xlarge:
      InstaceEphemeral0: '0'
      InstaceEphemeral1: '0'
      InstaceEphemeral2: '0'
    r5a.large:
      InstaceEphemeral0: '0'
      InstaceEphemeral1: '0'
      InstaceEphemeral2: '0'
    r5a.xlarge:
      InstaceEphemeral0: '0'
      InstaceEphemeral1: '0'
      InstaceEphemeral2: '0'
    t2.2xlarge:
      InstaceEphemeral0: '0'
      InstaceEphemeral1: '0'
      InstaceEphemeral2: '0'
    t2.large:
      InstaceEphemeral0: '0'
      InstaceEphemeral1: '0'
      InstaceEphemeral2: '0'
    t2.medium:
      InstaceEphemeral0: '0'
      InstaceEphemeral1: '0'
      InstaceEphemeral2: '0'
    t2.micro:
      InstaceEphemeral0: '0'
      InstaceEphemeral1: '0'
      InstaceEphemeral2: '0'
    t2.nano:
      InstaceEphemeral0: '0'
      InstaceEphemeral1: '0'
      InstaceEphemeral2: '0'
    t2.small:
      InstaceEphemeral0: '0'
      InstaceEphemeral1: '0'
      InstaceEphemeral2: '0'
    t2.xlarge:
      InstaceEphemeral0: '0'
      InstaceEphemeral1: '0'
      InstaceEphemeral2: '0'
    t3.2xlarge:
      InstaceEphemeral0: '0'
      InstaceEphemeral1: '0'
      InstaceEphemeral2: '0'
    t3.large:
      InstaceEphemeral0: '0'
      InstaceEphemeral1: '0'
      InstaceEphemeral2: '0'
    t3.medium:
      InstaceEphemeral0: '0'
      InstaceEphemeral1: '0'
      InstaceEphemeral2: '0'
    t3.micro:
      InstaceEphemeral0: '0'
      InstaceEphemeral1: '0'
      InstaceEphemeral2: '0'
    t3.nano:
      InstaceEphemeral0: '0'
      InstaceEphemeral1: '0'
      InstaceEphemeral2: '0'
    t3.small:
      InstaceEphemeral0: '0'
      InstaceEphemeral1: '0'
      InstaceEphemeral2: '0'
    t3.xlarge:
      InstaceEphemeral0: '0'
      InstaceEphemeral1: '0'
      InstaceEphemeral2: '0'
    t3a.2xlarge:
      InstaceEphemeral0: '0'
      InstaceEphemeral1: '0'
      InstaceEphemeral2: '0'
    t3a.large:
      InstaceEphemeral0: '0'
      InstaceEphemeral1: '0'
      InstaceEphemeral2: '0'
    t3a.medium:
      InstaceEphemeral0: '0'
      InstaceEphemeral1: '0'
      InstaceEphemeral2: '0'
    t3a.micro:
      InstaceEphemeral0: '0'
      InstaceEphemeral1: '0'
      InstaceEphemeral2: '0'
    t3a.nano:
      InstaceEphemeral0: '0'
      InstaceEphemeral1: '0'
      InstaceEphemeral2: '0'
    t3a.small:
      InstaceEphemeral0: '0'
      InstaceEphemeral1: '0'
      InstaceEphemeral2: '0'
    t3a.xlarge:
      InstaceEphemeral0: '0'
      InstaceEphemeral1: '0'
      InstaceEphemeral2: '0'
    t4g.2xlarge:
      InstaceEphemeral0: '0'
      InstaceEphemeral1: '0'
      InstaceEphemeral2: '0'
    t4g.large:
      InstaceEphemeral0: '0'
      InstaceEphemeral1: '0'
      InstaceEphemeral2: '0'
    t4g.medium:
      InstaceEphemeral0: '0'
      InstaceEphemeral1: '0'
      InstaceEphemeral2: '0'
    t4g.micro:
      InstaceEphemeral0: '0'
      InstaceEphemeral1: '0'
      InstaceEphemeral2: '0'
    t4g.nano:
      InstaceEphemeral0: '0'
      InstaceEphemeral1: '0'
      InstaceEphemeral2: '0'
    t4g.small:
      InstaceEphemeral0: '0'
      InstaceEphemeral1: '0'
      InstaceEphemeral2: '0'
    t4g.xlarge:
      InstaceEphemeral0: '0'
      InstaceEphemeral1: '0'
      InstaceEphemeral2: '0'
  dev:
    eu-central-1:
      AlarmBackendExternal5XXEvaluationPeriods: 0
      AlarmBackendInternal5XXEvaluationPeriods: 0
      AlarmTargetEC2External5XXEvaluationPeriods: 0
      AlarmTargetEC2Internal5XXEvaluationPeriods: 0
      CapacityDesired: 2
      CapacityMax: 3
      CapacityMin: 1
      HostedZoneIdLB: Z215JYRZR1TBD5
      LaunchTemplateDataBlockDeviceMappingsXvdaEbsVolumeSize: 100
      LaunchTemplateDataImageId: ami-0cc293023f983ed53
      LaunchTemplateDataInstanceType: t3a.large
      ScheduledActionDownDesiredSize: 1
    eu-west-1:
      AlarmBackendExternal5XXEvaluationPeriods: 0
      AlarmBackendInternal5XXEvaluationPeriods: 0
      AlarmTargetEC2External5XXEvaluationPeriods: 0
      AlarmTargetEC2Internal5XXEvaluationPeriods: 0
      CapacityDesired: 2
      CapacityMax: 3
      CapacityMin: 1
      HostedZoneIdLB: Z32O12XQLNTSW2
      LaunchTemplateDataBlockDeviceMappingsXvdaEbsVolumeSize: 100
      LaunchTemplateDataImageId: ami-0bbc25e23a7640b9b
      LaunchTemplateDataInstanceType: t3a.large
      ScheduledActionDownDesiredSize: 1
    us-east-1:
      AlarmBackendExternal5XXEvaluationPeriods: 0
      AlarmBackendInternal5XXEvaluationPeriods: 0
      AlarmTargetEC2External5XXEvaluationPeriods: 0
      AlarmTargetEC2Internal5XXEvaluationPeriods: 0
      CapacityDesired: 2
      CapacityMax: 3
      CapacityMin: 1
      HostedZoneIdLB: Z35SXDOTRQ7X7K
      LaunchTemplateDataBlockDeviceMappingsXvdaEbsVolumeSize: 100
      LaunchTemplateDataImageId: ami-0b898040803850657
      LaunchTemplateDataInstanceType: t3a.large
      ScheduledActionDownDesiredSize: 1
  prd:
    eu-central-1:
      AlarmBackendExternal5XXEvaluationPeriods: 2
      AlarmBackendInternal5XXEvaluationPeriods: 2
      AlarmTargetEC2External5XXEvaluationPeriods: 2
      AlarmTargetEC2Internal5XXEvaluationPeriods: 2
      CapacityDesired: 0
      CapacityMax: 9
      CapacityMin: 0
      HostedZoneIdLB: Z215JYRZR1TBD5
      LaunchTemplateDataBlockDeviceMappingsXvdaEbsVolumeSize: 150
      LaunchTemplateDataImageId: ami-0cc293023f983ed53
      LaunchTemplateDataInstanceType: c5.2xlarge
      ScheduledActionDownDesiredSize: 2
    eu-west-1:
      AlarmBackendExternal5XXEvaluationPeriods: 2
      AlarmBackendInternal5XXEvaluationPeriods: 2
      AlarmTargetEC2External5XXEvaluationPeriods: 2
      AlarmTargetEC2Internal5XXEvaluationPeriods: 2
      CapacityDesired: 3
      CapacityMax: 9
      CapacityMin: 2
      HostedZoneIdLB: Z32O12XQLNTSW2
      LaunchTemplateDataBlockDeviceMappingsXvdaEbsVolumeSize: 150
      LaunchTemplateDataImageId: ami-0bbc25e23a7640b9b
      LaunchTemplateDataInstanceType: c5.2xlarge
      ScheduledActionDownDesiredSize: 2
    us-east-1:
      AlarmBackendExternal5XXEvaluationPeriods: 2
      AlarmBackendInternal5XXEvaluationPeriods: 2
      AlarmTargetEC2External5XXEvaluationPeriods: 2
      AlarmTargetEC2Internal5XXEvaluationPeriods: 2
      CapacityDesired: 3
      CapacityMax: 9
      CapacityMin: 2
      HostedZoneIdLB: Z35SXDOTRQ7X7K
      LaunchTemplateDataBlockDeviceMappingsXvdaEbsVolumeSize: 150
      LaunchTemplateDataImageId: ami-0b898040803850657
      LaunchTemplateDataInstanceType: c5.2xlarge
      ScheduledActionDownDesiredSize: 2
  stg:
    eu-central-1:
      AlarmBackendExternal5XXEvaluationPeriods: 0
      AlarmBackendInternal5XXEvaluationPeriods: 0
      AlarmTargetEC2External5XXEvaluationPeriods: 0
      AlarmTargetEC2Internal5XXEvaluationPeriods: 0
      CapacityDesired: 2
      CapacityMax: 3
      CapacityMin: 1
      HostedZoneIdLB: Z215JYRZR1TBD5
      LaunchTemplateDataBlockDeviceMappingsXvdaEbsVolumeSize: 100
      LaunchTemplateDataImageId: ami-0cc293023f983ed53
      LaunchTemplateDataInstanceType: t3a.large
      ScheduledActionDownDesiredSize: 1
    eu-west-1:
      AlarmBackendExternal5XXEvaluationPeriods: 0
      AlarmBackendInternal5XXEvaluationPeriods: 0
      AlarmTargetEC2External5XXEvaluationPeriods: 0
      AlarmTargetEC2Internal5XXEvaluationPeriods: 0
      CapacityDesired: 2
      CapacityMax: 3
      CapacityMin: 1
      HostedZoneIdLB: Z32O12XQLNTSW2
      LaunchTemplateDataBlockDeviceMappingsXvdaEbsVolumeSize: 100
      LaunchTemplateDataImageId: ami-0bbc25e23a7640b9b
      LaunchTemplateDataInstanceType: t3a.large
      ScheduledActionDownDesiredSize: 1
    us-east-1:
      AlarmBackendExternal5XXEvaluationPeriods: 0
      AlarmBackendInternal5XXEvaluationPeriods: 0
      AlarmTargetEC2External5XXEvaluationPeriods: 0
      AlarmTargetEC2Internal5XXEvaluationPeriods: 0
      CapacityDesired: 2
      CapacityMax: 3
      CapacityMin: 1
      HostedZoneIdLB: Z35SXDOTRQ7X7K
      LaunchTemplateDataBlockDeviceMappingsXvdaEbsVolumeSize: 100
      LaunchTemplateDataImageId: ami-0b898040803850657
      LaunchTemplateDataInstanceType: t3a.large
      ScheduledActionDownDesiredSize: 1
Outputs:
  AlarmBackendInternal5XX:
    Value:
      Fn::Sub:
        - Period=${AlarmBackendInternal5XXPeriod},EvaluationPeriods=${AlarmBackendInternal5XXEvaluationPeriods},Threshold=${AlarmBackendInternal5XXThreshold}
        - AlarmBackendInternal5XXEvaluationPeriods:
            Fn::If:
              - AlarmBackendInternal5XXEvaluationPeriodsOverride
              - Ref: AlarmBackendInternal5XXEvaluationPeriods
              - Fn::FindInMap:
                  - Ref: EnvShort
                  - Ref: AWS::Region
                  - AlarmBackendInternal5XXEvaluationPeriods
          AlarmBackendInternal5XXPeriod: 60
          AlarmBackendInternal5XXThreshold:
            Fn::If:
              - AlarmBackendInternal5XXThresholdOverride
              - Ref: AlarmBackendInternal5XXThreshold
              - '50'
  AlarmCPUHigh:
    Value:
      Fn::Sub:
        - Period=${AlarmCPUHighPeriod},EvaluationPeriods=${AlarmCPUHighEvaluationPeriods},Threshold=${AlarmCPUHighThreshold}
        - AlarmCPUHighEvaluationPeriods:
            Fn::If:
              - AlarmCPUHighEvaluationPeriodsOverride
              - Ref: AlarmCPUHighEvaluationPeriods
              - 0
          AlarmCPUHighPeriod: 60
          AlarmCPUHighThreshold:
            Fn::If:
              - AlarmCPUHighThresholdOverride
              - Ref: AlarmCPUHighThreshold
              - '60'
  AlarmCPULow:
    Value:
      Fn::Sub:
        - Period=${AlarmCPULowPeriod},EvaluationPeriods=${AlarmCPULowEvaluationPeriods},Threshold=${AlarmCPULowThreshold}
        - AlarmCPULowEvaluationPeriods:
            Fn::If:
              - AlarmCPULowEvaluationPeriodsOverride
              - Ref: AlarmCPULowEvaluationPeriods
              - 0
          AlarmCPULowPeriod: 60
          AlarmCPULowThreshold:
            Fn::If:
              - AlarmCPULowThresholdOverride
              - Ref: AlarmCPULowThreshold
              - '30'
  AlarmDiskUsed:
    Value:
      Fn::Sub:
        - Period=${AlarmDiskUsedPeriod},EvaluationPeriods=${AlarmDiskUsedEvaluationPeriods},Threshold=${AlarmDiskUsedThreshold}
        - AlarmDiskUsedEvaluationPeriods:
            Fn::If:
              - AlarmDiskUsedEvaluationPeriodsOverride
              - Ref: AlarmDiskUsedEvaluationPeriods
              - 3
          AlarmDiskUsedPeriod: 60
          AlarmDiskUsedThreshold:
            Fn::If:
              - AlarmDiskUsedThresholdOverride
              - Ref: AlarmDiskUsedThreshold
              - '80'
  BrandDomain:
    Value: aman.arda
  Capacity:
    Value:
      Fn::Sub:
        - Desired=${CapacityDesired},Min=${CapacityMin},Max=${CapacityMax}
        - CapacityDesired:
            Fn::If:
              - CapacityDesiredOverride
              - Ref: CapacityDesired
              - Fn::FindInMap:
                  - Ref: EnvShort
                  - Ref: AWS::Region
                  - CapacityDesired
          CapacityMax:
            Fn::If:
              - CapacityMaxOverride
              - Ref: CapacityMax
              - Fn::FindInMap:
                  - Ref: EnvShort
                  - Ref: AWS::Region
                  - CapacityMax
          CapacityMin:
            Fn::If:
              - CapacityMinOverride
              - Ref: CapacityMin
              - Fn::FindInMap:
                  - Ref: EnvShort
                  - Ref: AWS::Region
                  - CapacityMin
  DoNotSignal:
    Value:
      Ref: DoNotSignal
  EfsMounts:
    Condition: EfsMounts
    Value:
      Fn::Join:
        - ','
        - Ref: EfsMounts
  Env:
    Value:
      Ref: Env
  EnvRole:
    Value:
      Ref: EnvRole
  EnvStackVersion:
    Value:
      Ref: EnvStackVersion
  EventsRuleElasticSearchSnapShotScheduleExpression:
    Value:
      Fn::If:
        - EventsRuleElasticSearchSnapShotScheduleExpressionOverride
        - Ref: EventsRuleElasticSearchSnapShotScheduleExpression
        - cron(15 2 * * ? *)
  EventsRuleElasticSearchSnapShotState:
    Value:
      Fn::If:
        - EventsRuleElasticSearchSnapShotStateOverride
        - Ref: EventsRuleElasticSearchSnapShotState
        - ENABLED
  HealthCheck:
    Value:
      Fn::Sub:
        - Type=${AutoScalingGroupBaseHealthCheckType},Target=${HealthCheckTarget},Interval=${HealthCheckIntervalSeconds},Timeout=${HealthCheckTimeoutSeconds},Healthy=${HealthyThresholdCount},Unhealthy=${UnhealthyThresholdCount}
        - AutoScalingGroupBaseHealthCheckType: EC2
          HealthCheckIntervalSeconds: 30
          HealthCheckTarget: HTTP:9200/
          HealthCheckTimeoutSeconds: 6
          HealthyThresholdCount: 2
          UnhealthyThresholdCount: 3
  LaunchTemplateDataBlockDeviceMappingsAdditionalStorageEbsVolumeSize:
    Value:
      Fn::If:
        - LaunchTemplateDataBlockDeviceMappingsAdditionalStorageEbsVolumeSizeOverride
        - Ref: LaunchTemplateDataBlockDeviceMappingsAdditionalStorageEbsVolumeSize
        - 0
  LaunchTemplateDataBlockDeviceMappingsXvdaEbsVolumeSize:
    Value:
      Fn::If:
        - LaunchTemplateDataBlockDeviceMappingsXvdaEbsVolumeSizeOverride
        - Ref: LaunchTemplateDataBlockDeviceMappingsXvdaEbsVolumeSize
        - Fn::FindInMap:
            - Ref: EnvShort
            - Ref: AWS::Region
            - LaunchTemplateDataBlockDeviceMappingsXvdaEbsVolumeSize
  LaunchTemplateDataImageId:
    Value:
      Fn::If:
        - LaunchTemplateDataImageIdLatest
        - Ref: LaunchTemplateDataImageIdLatest
        - Fn::If:
            - LaunchTemplateDataImageIdOverride
            - Ref: LaunchTemplateDataImageId
            - Fn::FindInMap:
                - Ref: EnvShort
                - Ref: AWS::Region
                - LaunchTemplateDataImageId
  LaunchTemplateDataInstanceType:
    Value:
      Fn::If:
        - LaunchTemplateDataInstanceTypeOverride
        - Ref: LaunchTemplateDataInstanceType
        - Fn::FindInMap:
            - Ref: EnvShort
            - Ref: AWS::Region
            - LaunchTemplateDataInstanceType
  LaunchTemplateDataKeyName:
    Value:
      Fn::If:
        - LaunchTemplateDataKeyNameOverride
        - Ref: LaunchTemplateDataKeyName
        - None
  ListenersPort5601:
    Value:
      Fn::Sub:
        - Protocol=${Protocol},Access=${Access}
        - Access: AllowedIp
          Protocol: TCP
  ListenersPort9200:
    Value:
      Fn::Sub:
        - Protocol=${Protocol},Access=${Access}
        - Access: AllowedIp
          Protocol: HTTP
  LoadBalancerLog:
    Value:
      Fn::If:
        - LoadBalancerLogOverride
        - Ref: LoadBalancerLog
        - None
  RecordSetExternal:
    Value:
      Ref: RecordSetExternal
  RecordSetInternal:
    Value:
      Ref: RecordSetInternal
  ScheduledActionDown:
    Value:
      Fn::Join:
        - ''
        - - DesiredSize=
          - Fn::If:
              - ScheduledActionDownCapacityDesiredSize
              - Fn::If:
                  - CapacityDesiredOverride
                  - Ref: CapacityDesired
                  - Fn::FindInMap:
                      - Ref: EnvShort
                      - Ref: AWS::Region
                      - CapacityDesired
              - Fn::If:
                  - ScheduledActionDownKeepDesiredSize
                  - Ref: AWS::NoValue
                  - Fn::If:
                      - ScheduledActionDownDesiredSizeOverride
                      - Ref: ScheduledActionDownDesiredSize
                      - Fn::FindInMap:
                          - Ref: EnvShort
                          - Ref: AWS::Region
                          - ScheduledActionDownDesiredSize
          - ',MinSize='
          - Fn::If:
              - ScheduledActionDownCapacityMinSize
              - Fn::If:
                  - CapacityMinOverride
                  - Ref: CapacityMin
                  - Fn::FindInMap:
                      - Ref: EnvShort
                      - Ref: AWS::Region
                      - CapacityMin
              - Fn::If:
                  - ScheduledActionDownKeepMinSize
                  - Ref: AWS::NoValue
                  - Fn::If:
                      - ScheduledActionDownMinSizeOverride
                      - Ref: ScheduledActionDownMinSize
                      - CapacityMin
          - ',MaxSize='
          - Fn::If:
              - ScheduledActionDownCapacityMaxSize
              - Fn::If:
                  - CapacityMaxOverride
                  - Ref: CapacityMax
                  - Fn::FindInMap:
                      - Ref: EnvShort
                      - Ref: AWS::Region
                      - CapacityMax
              - Fn::If:
                  - ScheduledActionDownKeepMaxSize
                  - Ref: AWS::NoValue
                  - Fn::If:
                      - ScheduledActionDownMaxSizeOverride
                      - Ref: ScheduledActionDownMaxSize
                      - CapacityMax
          - ',Recurrence='
          - Fn::If:
              - ScheduledActionDownRecurrenceOverride
              - Ref: ScheduledActionDownRecurrence
              - 00 19 * * *
          - ',StartTime='
          - Fn::If:
              - ScheduledActionDownStartTimeOverride
              - Ref: ScheduledActionDownStartTime
              - Ref: AWS::NoValue
  ScheduledActionUp:
    Value:
      Fn::Join:
        - ''
        - - DesiredSize=
          - Fn::If:
              - ScheduledActionUpCapacityDesiredSize
              - Fn::If:
                  - CapacityDesiredOverride
                  - Ref: CapacityDesired
                  - Fn::FindInMap:
                      - Ref: EnvShort
                      - Ref: AWS::Region
                      - CapacityDesired
              - Fn::If:
                  - ScheduledActionUpKeepDesiredSize
                  - Ref: AWS::NoValue
                  - Fn::If:
                      - ScheduledActionUpDesiredSizeOverride
                      - Ref: ScheduledActionUpDesiredSize
                      - CapacityDesired
          - ',MinSize='
          - Fn::If:
              - ScheduledActionUpCapacityMinSize
              - Fn::If:
                  - CapacityMinOverride
                  - Ref: CapacityMin
                  - Fn::FindInMap:
                      - Ref: EnvShort
                      - Ref: AWS::Region
                      - CapacityMin
              - Fn::If:
                  - ScheduledActionUpKeepMinSize
                  - Ref: AWS::NoValue
                  - Fn::If:
                      - ScheduledActionUpMinSizeOverride
                      - Ref: ScheduledActionUpMinSize
                      - CapacityMin
          - ',MaxSize='
          - Fn::If:
              - ScheduledActionUpCapacityMaxSize
              - Fn::If:
                  - CapacityMaxOverride
                  - Ref: CapacityMax
                  - Fn::FindInMap:
                      - Ref: EnvShort
                      - Ref: AWS::Region
                      - CapacityMax
              - Fn::If:
                  - ScheduledActionUpKeepMaxSize
                  - Ref: AWS::NoValue
                  - Fn::If:
                      - ScheduledActionUpMaxSizeOverride
                      - Ref: ScheduledActionUpMaxSize
                      - CapacityMax
          - ',Recurrence='
          - Fn::If:
              - ScheduledActionUpRecurrenceOverride
              - Ref: ScheduledActionUpRecurrence
              - 30 08 * * mon-fri
          - ',StartTime='
          - Fn::If:
              - ScheduledActionUpStartTimeOverride
              - Ref: ScheduledActionUpStartTime
              - Ref: AWS::NoValue
  SecurityGroupLoadBalancer:
    Value:
      Fn::GetAtt:
        - SecurityGroupLoadBalancer
        - GroupId
  SecurityGroups:
    Value:
      Fn::Sub:
        - Rules=${SecurityGroupInstancesRules},${SecurityGroupName0}=${SecurityGroupValue0},${SecurityGroupName1}=${SecurityGroupValue1},${SecurityGroupName2}=${SecurityGroupValue2},${SecurityGroupName3}=${SecurityGroupValue3}
        - SecurityGroupInstancesRules:
            Ref: SecurityGroupInstancesRules
          SecurityGroupName0:
            Fn::Select:
              - 0
              - Fn::Split:
                  - ','
                  - Fn::If:
                      - SecurityGroupsOverride
                      - Ref: SecurityGroups
                      - BaseInstance,ElasticSearch,None,None
          SecurityGroupName1:
            Fn::Select:
              - 1
              - Fn::Split:
                  - ','
                  - Fn::If:
                      - SecurityGroupsOverride
                      - Ref: SecurityGroups
                      - BaseInstance,ElasticSearch,None,None
          SecurityGroupName2:
            Fn::Select:
              - 2
              - Fn::Split:
                  - ','
                  - Fn::If:
                      - SecurityGroupsOverride
                      - Ref: SecurityGroups
                      - BaseInstance,ElasticSearch,None,None
          SecurityGroupName3:
            Fn::Select:
              - 3
              - Fn::Split:
                  - ','
                  - Fn::If:
                      - SecurityGroupsOverride
                      - Ref: SecurityGroups
                      - BaseInstance,ElasticSearch,None,None
          SecurityGroupValue0:
            Fn::If:
              - SecurityGroup0
              - Fn::ImportValue:
                  Fn::Sub:
                    - SecurityGroup${ImportName}
                    - ImportName:
                        Fn::Select:
                          - 0
                          - Fn::Split:
                              - ','
                              - Fn::If:
                                  - SecurityGroupsOverride
                                  - Ref: SecurityGroups
                                  - BaseInstance,ElasticSearch,None,None
              - None
          SecurityGroupValue1:
            Fn::If:
              - SecurityGroup1
              - Fn::ImportValue:
                  Fn::Sub:
                    - SecurityGroup${ImportName}
                    - ImportName:
                        Fn::Select:
                          - 1
                          - Fn::Split:
                              - ','
                              - Fn::If:
                                  - SecurityGroupsOverride
                                  - Ref: SecurityGroups
                                  - BaseInstance,ElasticSearch,None,None
              - None
          SecurityGroupValue2:
            Fn::If:
              - SecurityGroup2
              - Fn::ImportValue:
                  Fn::Sub:
                    - SecurityGroup${ImportName}
                    - ImportName:
                        Fn::Select:
                          - 2
                          - Fn::Split:
                              - ','
                              - Fn::If:
                                  - SecurityGroupsOverride
                                  - Ref: SecurityGroups
                                  - BaseInstance,ElasticSearch,None,None
              - None
          SecurityGroupValue3:
            Fn::If:
              - SecurityGroup3
              - Fn::ImportValue:
                  Fn::Sub:
                    - SecurityGroup${ImportName}
                    - ImportName:
                        Fn::Select:
                          - 3
                          - Fn::Split:
                              - ','
                              - Fn::If:
                                  - SecurityGroupsOverride
                                  - Ref: SecurityGroups
                                  - BaseInstance,ElasticSearch,None,None
              - None
  StackType:
    Value: ec2
  UpdateMode:
    Value:
      Ref: UpdateMode
Parameters:
  AlarmBackendInternal5XXEvaluationPeriods:
    AllowedValues:
      - ''
      - '0'
      - '1'
      - '2'
      - '3'
      - '4'
      - '5'
      - '6'
      - '7'
      - '8'
      - '9'
    Default: ''
    Description: Number of periods for alarm evaluation - 0 to disable - empty for
      mapped value
    Type: String
  AlarmBackendInternal5XXThreshold:
    AllowedValues:
      - ''
      - '10'
      - '15'
      - '20'
      - '25'
      - '30'
      - '35'
      - '40'
      - '45'
      - '50'
      - '55'
      - '60'
      - '65'
      - '70'
      - '75'
      - '80'
      - '85'
      - '90'
      - '95'
      - '100'
    Default: ''
    Description: Threshold for alarm triggering - empty for mapped value
    Type: String
  AlarmCPUHighEvaluationPeriods:
    AllowedValues:
      - ''
      - '0'
      - '1'
      - '2'
      - '3'
      - '4'
      - '5'
      - '6'
      - '7'
      - '8'
      - '9'
    Default: ''
    Description: Number of periods for alarm evaluation - 0 to disable - empty for
      mapped value
    Type: String
  AlarmCPUHighThreshold:
    AllowedValues:
      - ''
      - '10'
      - '15'
      - '20'
      - '25'
      - '30'
      - '35'
      - '40'
      - '45'
      - '50'
      - '55'
      - '60'
      - '65'
      - '70'
      - '75'
      - '80'
      - '85'
      - '90'
      - '95'
      - '100'
    Default: ''
    Description: Threshold for alarm triggering - empty for mapped value
    Type: String
  AlarmCPULowEvaluationPeriods:
    AllowedValues:
      - ''
      - '0'
      - '1'
      - '2'
      - '3'
      - '4'
      - '5'
      - '6'
      - '7'
      - '8'
      - '9'
    Default: ''
    Description: Number of periods for alarm evaluation - 0 to disable - empty for
      mapped value
    Type: String
  AlarmCPULowThreshold:
    AllowedValues:
      - ''
      - '10'
      - '15'
      - '20'
      - '25'
      - '30'
      - '35'
      - '40'
      - '45'
      - '50'
      - '55'
      - '60'
      - '65'
      - '70'
      - '75'
      - '80'
      - '85'
      - '90'
      - '95'
      - '100'
    Default: ''
    Description: Threshold for alarm triggering - empty for mapped value
    Type: String
  AlarmDiskUsedEvaluationPeriods:
    AllowedValues:
      - ''
      - '0'
      - '1'
      - '2'
      - '3'
      - '4'
      - '5'
      - '6'
      - '7'
      - '8'
      - '9'
    Default: ''
    Description: Number of periods for alarm evaluation - 0 to disable - empty for
      mapped value
    Type: String
  AlarmDiskUsedThreshold:
    AllowedValues:
      - ''
      - '10'
      - '15'
      - '20'
      - '25'
      - '30'
      - '35'
      - '40'
      - '45'
      - '50'
      - '55'
      - '60'
      - '65'
      - '70'
      - '75'
      - '80'
      - '85'
      - '90'
      - '95'
      - '100'
    Default: ''
    Description: Threshold for alarm triggering - empty for mapped value
    Type: String
  AutoScalingGroupBaseHealthCheckGracePeriod:
    Default: ''
    Description: How long to wait before ASG check instance health - empty for default
      based on env/role
    Type: String
  CapacityDesired:
    Default: ''
    Description: Desired Autoscaling Capacity - empty for default based on env/role
    Type: String
  CapacityMax:
    Default: ''
    Description: Max Autoscaling Capacity - empty for default based on env/role
    Type: String
  CapacityMin:
    Default: ''
    Description: Min Autoscaling Capacity - empty for default based on env/role
    Type: String
  CloudWatchAgent:
    AllowedValues:
      - ''
      - 'True'
      - None
    Default: ''
    Description: CloudWatch Agent Install - empty for default based on env/role
    Type: String
  DoNotSignal:
    AllowedValues:
      - 'False'
      - 'True'
    Default: 'False'
    Description: Do Not Signal ASG - WARNING need to manually exec cfn-signal!
    Type: String
  EfsMounts:
    Default: ''
    Description: Efs Mounts List
    Type: CommaDelimitedList
  Env:
    AllowedValues:
      - dev
      - stg
      - prod
    Default: dev
    Description: Environment
    Type: String
  EnvRole:
    AllowedPattern: ^[a-zA-Z0-9-_.]*$
    Default: ''
    Description: Service Role
    Type: String
  EnvShort:
    AllowedValues:
      - dev
      - stg
      - prd
    Default: dev
    Description: Environment Short - NEVER CHANGE!
    Type: String
  EnvStackVersion:
    Default: '1'
    Description: Stack version, if changed with UpdateMode=Cfn triggers cfn-hup
    Type: String
  EventsRuleElasticSearchSnapShotScheduleExpression:
    Default: ''
    Description: Events Rule Schedule - empty for default based on env/role
    Type: String
  EventsRuleElasticSearchSnapShotState:
    AllowedValues:
      - ''
      - DISABLED
      - ENABLED
    Default: ''
    Description: Events Rule State - empty for default based on env/role
    Type: String
  LaunchTemplateDataBlockDeviceMappingsAdditionalStorageEbsVolumeSize:
    AllowedValues:
      - ''
      - '0'
      - '4'
      - '8'
      - '16'
      - '32'
      - '64'
      - '128'
      - '256'
      - '512'
      - '1024'
    Default: ''
    Description: Size in GiB of additional EBS storage - 0 to disable - empty for
      default
    Type: String
  LaunchTemplateDataBlockDeviceMappingsXvdaEbsVolumeSize:
    Default: ''
    Description: Size of HD in GB - empty for default based on env/role
    Type: String
  LaunchTemplateDataImageId:
    Default: ''
    Description: AMI ID - empty for default based on env/role/region
    Type: String
  LaunchTemplateDataImageIdLatest:
    AllowedValues:
      - /aws/service/ami-amazon-linux-latest/amzn2-ami-hvm-x86_64-gp2
    Default: /aws/service/ami-amazon-linux-latest/amzn2-ami-hvm-x86_64-gp2
    Description: Latest Amazon Linux2 ami available from SSM
    Type: AWS::SSM::Parameter::Value<String>
  LaunchTemplateDataInstanceMarketOptionsSpotOptionsMaxPrice:
    Default: ''
    Description: Maximum Spot Price of ASG - empty for default based on env/role -
      0 to disable
    Type: String
  LaunchTemplateDataInstanceType:
    AllowedValues:
      - default
      - m3.medium
      - m3.large
      - m3.xlarge
      - m3.2xlarge
      - c3.large
      - c3.xlarge
      - c3.2xlarge
      - c3.4xlarge
      - r3.large
      - r3.xlarge
      - r3.2xlarge
      - r3.4xlarge
      - i2.xlarge
      - i2.2xlarge
      - i2.4xlarge
      - d2.xlarge
      - d2.2xlarge
      - d2.4xlarge
      - t2.nano
      - t2.micro
      - t2.small
      - t2.medium
      - t2.large
      - t2.xlarge
      - t2.2xlarge
      - m4.large
      - m4.xlarge
      - m4.2xlarge
      - m4.4xlarge
      - c4.large
      - c4.xlarge
      - c4.2xlarge
      - c4.4xlarge
      - r4.large
      - r4.xlarge
      - r4.2xlarge
      - r4.4xlarge
      - g2.2xlarge
      - g3s.xlarge
      - t3.nano
      - t3.micro
      - t3.small
      - t3.medium
      - t3.large
      - t3.xlarge
      - t3.2xlarge
      - m5.large
      - m5.xlarge
      - m5.2xlarge
      - m5.4xlarge
      - m5.8xlarge
      - m5.12xlarge
      - m5.16xlarge
      - m5.24xlarge
      - c5.large
      - c5.xlarge
      - c5.2xlarge
      - c5.4xlarge
      - c5.9xlarge
      - c5.12xlarge
      - c5.18xlarge
      - c5.24xlarge
      - r5.large
      - r5.xlarge
      - r5.2xlarge
      - r5.4xlarge
      - r5.8xlarge
      - r5.12xlarge
      - r5.16xlarge
      - r5.24xlarge
      - a1.medium
      - a1.large
      - a1.xlarge
      - a1.2xlarge
      - a1.4xlarge
      - m5a.large
      - m5a.xlarge
      - m5a.2xlarge
      - m5a.4xlarge
      - m5a.8xlarge
      - m5a.12xlarge
      - m5a.16xlarge
      - m5a.24xlarge
      - r5a.large
      - r5a.xlarge
      - r5a.2xlarge
      - r5a.4xlarge
      - r5a.8xlarge
      - r5a.12xlarge
      - r5a.16xlarge
      - r5a.24xlarge
      - c5a.large
      - c5a.xlarge
      - c5a.2xlarge
      - c5a.4xlarge
      - c5a.8xlarge
      - c5a.12xlarge
      - c5a.16xlarge
      - c5a.24xlarge
      - t3a.nano
      - t3a.micro
      - t3a.small
      - t3a.medium
      - t3a.large
      - t3a.xlarge
      - t3a.2xlarge
      - t4g.nano
      - t4g.micro
      - t4g.small
      - t4g.medium
      - t4g.large
      - t4g.xlarge
      - t4g.2xlarge
    ConstraintDescription: must be a valid EC2 instance type.
    Default: default
    Description: InstanceType - default for default based on env/role
    Type: String
  LaunchTemplateDataKeyName:
    Default: ''
    Description: EC2 SSH Key - empty for default
    Type: String
  ListenerLoadBalancerHttpPort:
    Default: ''
    Description: Http Port where Load Balancer listen - empty for default based on
      env/role
    Type: String
  ListenerLoadBalancerHttpsPort:
    Default: ''
    Description: Http Port where Load Balancer listen - empty for default based on
      env/role
    Type: String
  LoadBalancerLog:
    Default: ''
    Description: None to disable - empty for mapped value - for ELBClassic Value is
      used for EmitInterval too
    Type: String
  ScheduledActionDownDesiredSize:
    Default: ''
    Description: k to keep current value - empty for mapped value
    Type: String
  ScheduledActionDownMaxSize:
    Default: ''
    Description: k to keep current value - empty for mapped value
    Type: String
  ScheduledActionDownMinSize:
    Default: ''
    Description: k to keep current value - empty for mapped value
    Type: String
  ScheduledActionDownRecurrence:
    Default: ''
    Description: empty for mapped value
    Type: String
  ScheduledActionDownStartTime:
    Default: ''
    Description: ''
    Type: String
  ScheduledActionUpDesiredSize:
    Default: ''
    Description: k to keep current value - empty for mapped value
    Type: String
  ScheduledActionUpMaxSize:
    Default: ''
    Description: k to keep current value - empty for mapped value
    Type: String
  ScheduledActionUpMinSize:
    Default: ''
    Description: k to keep current value - empty for mapped value
    Type: String
  ScheduledActionUpRecurrence:
    Default: ''
    Description: empty for mapped value
    Type: String
  ScheduledActionUpStartTime:
    Default: ''
    Description: ''
    Type: String
  SecurityGroups:
    AllowedPattern: ^(\w*,\w*){3}$
    Default: ',,,'
    Description: SecurityGroups List Extra - ,,, for default based on env/role
    Type: String
  SpotAuto:
    AllowedValues:
      - ''
      - 'True'
      - None
    Default: ''
    Description: ASG TAG for autospotting https://github.com/AutoSpotting/AutoSpotting
      - empty for default based on env/role
    Type: String
  SpotAutoAllowedInstances:
    Default: ''
    Description: ASG TAG for autospotting allowed instance types (space delimited)
      - current to use the same of ASG - empty for default based on env/role - None
      to disable
    Type: String
  SpotAutoMinOnDemandNumber:
    Default: ''
    Description: ASG TAG for autospotting minimum on-demand instance to keep - empty
      for default based on env/role - None to disable
    Type: String
  UpdateMode:
    Default: None
    Description: How to update Instances
    Type: String
Resources:
  AlarmBackendInternal5XX:
    Condition: AlarmBackendInternal5XX
    Properties:
      ActionsEnabled: 'true'
      AlarmActions:
        - Fn::ImportValue: SNSTopicCloudWatchAlarm
      ComparisonOperator: GreaterThanThreshold
      Dimensions:
        - Name: LoadBalancerName
          Value:
            Ref: LoadBalancerClassicInternal
      EvaluationPeriods:
        Fn::If:
          - AlarmBackendInternal5XXEvaluationPeriodsOverride
          - Ref: AlarmBackendInternal5XXEvaluationPeriods
          - Fn::FindInMap:
              - Ref: EnvShort
              - Ref: AWS::Region
              - AlarmBackendInternal5XXEvaluationPeriods
      MetricName: HTTPCode_Backend_5XX
      Namespace: AWS/ELB
      Period: 60
      Statistic: Sum
      Threshold:
        Fn::If:
          - AlarmBackendInternal5XXThresholdOverride
          - Ref: AlarmBackendInternal5XXThreshold
          - '50'
      TreatMissingData: notBreaching
    Type: AWS::CloudWatch::Alarm
  AlarmCPUHigh:
    Condition: AlarmCPUHigh
    Properties:
      ActionsEnabled: 'true'
      AlarmActions:
        - Ref: AutoScalingScalingPolicyUp
      AlarmDescription: Alarm if CPU too High
      ComparisonOperator: GreaterThanThreshold
      Dimensions:
        - Name: AutoScalingGroupName
          Value:
            Ref: AutoScalingGroup
      EvaluationPeriods:
        Fn::If:
          - AlarmCPUHighEvaluationPeriodsOverride
          - Ref: AlarmCPUHighEvaluationPeriods
          - 0
      MetricName: CPUUtilization
      Namespace: AWS/EC2
      Period: 60
      Statistic: Average
      Threshold:
        Fn::If:
          - AlarmCPUHighThresholdOverride
          - Ref: AlarmCPUHighThreshold
          - '60'
      Unit: Percent
    Type: AWS::CloudWatch::Alarm
  AlarmCPULow:
    Condition: AlarmCPULow
    Properties:
      ActionsEnabled: 'true'
      AlarmActions:
        - Ref: AutoScalingScalingPolicyDown
      AlarmDescription: Alarm if CPU too Low
      ComparisonOperator: LessThanOrEqualToThreshold
      Dimensions:
        - Name: AutoScalingGroupName
          Value:
            Ref: AutoScalingGroup
      EvaluationPeriods:
        Fn::If:
          - AlarmCPULowEvaluationPeriodsOverride
          - Ref: AlarmCPULowEvaluationPeriods
          - 0
      MetricName: CPUUtilization
      Namespace: AWS/EC2
      Period: 60
      Statistic: Average
      Threshold:
        Fn::If:
          - AlarmCPULowThresholdOverride
          - Ref: AlarmCPULowThreshold
          - '30'
      Unit: Percent
    Type: AWS::CloudWatch::Alarm
  AlarmDiskUsed:
    Condition: AlarmDiskUsed
    Properties:
      ActionsEnabled: 'true'
      ComparisonOperator: GreaterThanOrEqualToThreshold
      Dimensions:
        - Name: AutoScalingGroupName
          Value:
            Ref: AutoScalingGroup
      EvaluationPeriods:
        Fn::If:
          - AlarmDiskUsedEvaluationPeriodsOverride
          - Ref: AlarmDiskUsedEvaluationPeriods
          - 3
      MetricName: root_disk_used_percent
      Namespace: CWAgent
      Period: 60
      Statistic: Maximum
      Threshold:
        Fn::If:
          - AlarmDiskUsedThresholdOverride
          - Ref: AlarmDiskUsedThreshold
          - '80'
      Unit: Percent
    Type: AWS::CloudWatch::Alarm
  AutoScalingGroup:
    CreationPolicy:
      ResourceSignal:
        Count:
          Fn::If:
            - CapacityDesiredOverride
            - Ref: CapacityDesired
            - Fn::FindInMap:
                - Ref: EnvShort
                - Ref: AWS::Region
                - CapacityDesired
        Timeout: PT15M
    Properties:
      AvailabilityZones:
        Fn::GetAZs: ''
      DesiredCapacity:
        Fn::If:
          - CapacityDesiredOverride
          - Ref: CapacityDesired
          - Fn::FindInMap:
              - Ref: EnvShort
              - Ref: AWS::Region
              - CapacityDesired
      HealthCheckGracePeriod:
        Fn::If:
          - AutoScalingGroupBaseHealthCheckGracePeriodOverride
          - Ref: AutoScalingGroupBaseHealthCheckGracePeriod
          - 600
      HealthCheckType: EC2
      LaunchTemplate:
        LaunchTemplateId:
          Ref: LaunchTemplate
        Version:
          Fn::GetAtt:
            - LaunchTemplate
            - LatestVersionNumber
      LoadBalancerNames:
        - Ref: LoadBalancerClassicInternal
      MaxSize:
        Fn::If:
          - CapacityMaxOverride
          - Ref: CapacityMax
          - Fn::FindInMap:
              - Ref: EnvShort
              - Ref: AWS::Region
              - CapacityMax
      MetricsCollection:
        - Granularity: 1Minute
      MinSize:
        Fn::If:
          - CapacityMinOverride
          - Ref: CapacityMin
          - Fn::FindInMap:
              - Ref: EnvShort
              - Ref: AWS::Region
              - CapacityMin
      Tags:
        - Key: Name
          PropagateAtLaunch: true
          Value:
            Ref: EnvRole
        - Key: EnvStackName
          PropagateAtLaunch: true
          Value:
            Ref: AWS::StackName
        - Fn::If:
            - SpotAuto
            - Key: spot-enabled
              PropagateAtLaunch: true
              Value: 'true'
            - Ref: AWS::NoValue
        - Fn::If:
            - SpotAutoMinOnDemandNumber
            - Key: autospotting_min_on_demand_number
              PropagateAtLaunch: true
              Value:
                Fn::If:
                  - SpotAutoMinOnDemandNumberOverride
                  - Ref: SpotAutoMinOnDemandNumber
                  - None
            - Ref: AWS::NoValue
        - Fn::If:
            - SpotAutoAllowedInstances
            - Key: autospotting_allowed_instance_types
              PropagateAtLaunch: true
              Value:
                Fn::If:
                  - SpotAutoAllowedInstancesOverride
                  - Ref: SpotAutoAllowedInstances
                  - None
            - Ref: AWS::NoValue
      TargetGroupARNs: []
      TerminationPolicies:
        - OldestInstance
      VPCZoneIdentifier:
        Fn::Split:
          - ','
          - Fn::ImportValue: SubnetsPrivate
    Type: AWS::AutoScaling::AutoScalingGroup
    UpdatePolicy:
      AutoScalingReplacingUpdate:
        Fn::If:
          - WillReplace
          - WillReplace: 'true'
          - Ref: AWS::NoValue
      AutoScalingRollingUpdate:
        Fn::If:
          - RollingUpdate
          - MaxBatchSize: 1
            MinInstancesInService:
              Fn::If:
                - CapacityDesiredOverride
                - Ref: CapacityDesired
                - Fn::FindInMap:
                    - Ref: EnvShort
                    - Ref: AWS::Region
                    - CapacityDesired
            MinSuccessfulInstancesPercent: 100
            PauseTime: PT20M
            SuspendProcesses:
              - HealthCheck
              - ReplaceUnhealthy
              - AlarmNotification
              - ScheduledActions
            WaitOnResourceSignals: 'true'
          - Ref: AWS::NoValue
      AutoScalingScheduledAction:
        IgnoreUnmodifiedGroupSizeProperties: 'true'
  AutoScalingScalingPolicyDown:
    Properties:
      AdjustmentType: ChangeInCapacity
      AutoScalingGroupName:
        Ref: AutoScalingGroup
      EstimatedInstanceWarmup: 600
      PolicyType: StepScaling
      StepAdjustments:
        - MetricIntervalLowerBound: -10
          MetricIntervalUpperBound: 0
          ScalingAdjustment: -1
        - MetricIntervalLowerBound: -20
          MetricIntervalUpperBound: -10
          ScalingAdjustment: -2
        - MetricIntervalUpperBound: -20
          ScalingAdjustment: -2
    Type: AWS::AutoScaling::ScalingPolicy
  AutoScalingScalingPolicyUp:
    Properties:
      AdjustmentType: ChangeInCapacity
      AutoScalingGroupName:
        Ref: AutoScalingGroup
      EstimatedInstanceWarmup: 600
      PolicyType: StepScaling
      StepAdjustments:
        - MetricIntervalLowerBound: 0
          MetricIntervalUpperBound: 10
          ScalingAdjustment: 1
        - MetricIntervalLowerBound: 10
          MetricIntervalUpperBound: 20
          ScalingAdjustment: 2
        - MetricIntervalLowerBound: 20
          ScalingAdjustment: 2
    Type: AWS::AutoScaling::ScalingPolicy
  EventsRuleElasticSearchSnapShot:
    Properties:
      Description: Periodically invoke LambdaElasticSearchSnapShot
      Name:
        Fn::Sub: ${AWS::StackName}-${EnvRole}-RuleElasticSearchSnapShot
      ScheduleExpression:
        Fn::If:
          - EventsRuleElasticSearchSnapShotScheduleExpressionOverride
          - Ref: EventsRuleElasticSearchSnapShotScheduleExpression
          - cron(15 2 * * ? *)
      State:
        Fn::If:
          - EventsRuleElasticSearchSnapShotStateOverride
          - Ref: EventsRuleElasticSearchSnapShotState
          - ENABLED
      Targets:
        - Arn:
            Fn::GetAtt:
              - LambdaElasticSearchSnapShot
              - Arn
          Id: TargetFunction-01
    Type: AWS::Events::Rule
  IAMPolicyCloudFormation:
    Properties:
      PolicyDocument:
        Statement:
          - Action:
              - cloudformation:DescribeStackResource
              - cloudformation:SignalResource
            Effect: Allow
            Resource:
              Fn::Sub: arn:aws:cloudformation:*:*:stack/${AWS::StackName}/*
        Version: '2012-10-17'
      PolicyName: CloudFormation
      Roles:
        - Ref: RoleInstance
    Type: AWS::IAM::Policy
  IAMPolicyESSnapshot:
    Properties:
      PolicyDocument:
        Statement:
          - Action:
              - s3:CreateBucket
              - s3:ListBucket
              - s3:GetBucketLocation
              - s3:ListBucketMultipartUploads
              - s3:ListBucketVersions
            Effect: Allow
            Resource:
              Fn::Sub: arn:aws:s3:::${AWS::Region}-arda-aman-${EnvShort}-elasticsearch
          - Action:
              - s3:GetObject
              - s3:PutObject
              - s3:DeleteObject
              - s3:AbortMultipartUpload
              - s3:ListMultipartUploadParts
            Effect: Allow
            Resource:
              Fn::Sub: arn:aws:s3:::${AWS::Region}-arda-aman-${EnvShort}-elasticsearch/*
        Version: '2012-10-17'
      PolicyName: ESSnapshot
      Roles:
        - Ref: RoleInstance
    Type: AWS::IAM::Policy
  IAMPolicyESSnapshotRO:
    Properties:
      PolicyDocument:
        Statement:
          - Action:
              - s3:ListBucket
              - s3:GetBucketLocation
              - s3:ListBucketMultipartUploads
              - s3:ListBucketVersions
            Effect: Allow
            Resource:
              - arn:aws:s3:::eu-west-1-arda-aman-dev-elasticsearch
              - arn:aws:s3:::eu-west-1-arda-aman-stg-elasticsearch
              - arn:aws:s3:::eu-west-1-arda-aman-prd-elasticsearch
          - Action:
              - s3:GetObject
              - s3:ListMultipartUploadParts
            Effect: Allow
            Resource:
              - arn:aws:s3:::eu-west-1-arda-aman-dev-elasticsearch/*
              - arn:aws:s3:::eu-west-1-arda-aman-stg-elasticsearch/*
              - arn:aws:s3:::eu-west-1-arda-aman-prd-elasticsearch/*
        Version: '2012-10-17'
      PolicyName: ESSnapshotRO
      Roles:
        - Ref: RoleInstance
    Type: AWS::IAM::Policy
  IAMPolicyParameterStore:
    Properties:
      PolicyDocument:
        Statement:
          - Action: kms:Decrypt
            Effect: Allow
            Resource:
              Fn::ImportValue: KeyParameterStore
          - Action: ssm:DescribeParameters
            Effect: Allow
            Resource:
              Fn::Sub: arn:aws:ssm:${AWS::Region}:${AWS::AccountId}:*
          - Action: ssm:GetParameters
            Effect: Allow
            Resource:
              - Fn::Sub: arn:aws:ssm:${AWS::Region}:${AWS::AccountId}:parameter/${EnvRole}/*
              - Fn::Sub: arn:aws:ssm:${AWS::Region}:${AWS::AccountId}:parameter/${AWS::StackName}/${EnvRole}/*
        Version: '2012-10-17'
      PolicyName: ParameterStore
      Roles:
        - Ref: RoleInstance
    Type: AWS::IAM::Policy
  InstanceProfile:
    Properties:
      Path: /
      Roles:
        - Ref: RoleInstance
    Type: AWS::IAM::InstanceProfile
  LambdaElasticSearchSnapShot:
    Properties:
      Code:
        ZipFile:
          Fn::Join:
            - ''
            - - "import boto3\n"
              - "import logging\n"
              - "import urllib\n"
              - "import urllib2\n"
              - "import time\n"
              - "import os\n"
              - "import json\n"
              - "logger = logging.getLogger()\n"
              - "logger.setLevel(logging.INFO)\n"
              - "\n"
              - "class MethodRequest(urllib2.Request):\n"
              - "  def __init__(self, *args, **kwargs):\n"
              - "    if 'method' in kwargs:\n"
              - "      self._method = kwargs['method']\n"
              - "      del kwargs['method']\n"
              - "    else:\n"
              - "      self._method = None\n"
              - "    return urllib2.Request.__init__(self, *args, **kwargs)\n"
              - "\n"
              - "  def get_method(self, *args, **kwargs):\n"
              - "    if self._method is not None:\n"
              - "      return self._method\n"
              - "    return urllib2.Request.get_method(self, *args, **kwargs)\n"
              - "\n"
              - "def get_autoscale_info(ec2):\n"
              - "  instance_iterator = ec2.instances.filter(\n"
              - "    Filters=[\n"
              - "      {\n"
              - "        'Name': 'tag:aws:autoscaling:groupName',\n"
              - "        'Values': [os.environ['AutoScalingGroup']]\n"
              - "      },\n"
              - "      {\n"
              - "        'Name': 'instance-state-name',\n"
              - "        'Values': ['running']\n"
              - "      }\n"
              - "    ]\n"
              - "  )\n"
              - "  sorted_instances = sorted(\n"
              - "    instance_iterator,\n"
              - "    key=lambda i: (i.launch_time, i.id))\n"
              - "  return sorted_instances\n"
              - "\n"
              - "def lambda_handler(event, context):\n"
              - "  ec2 = boto3.resource('ec2')\n"
              - "  sorted_instances = get_autoscale_info(ec2)\n"
              - "  my_instance = sorted_instances[0]\n"
              - "  dnsname = my_instance.private_dns_name.partition('.')[0]\n"
              - "  logger.info(dnsname + ' ' + str(my_instance.launch_time))\n"
              - "  mydate = time.strftime('%F_%T')\n"
              - "  req_snap_data = {\n"
              - "    'type': 's3',\n"
              - "    'settings': {\n"
              - "      'bucket': os.environ['BucketElasticSearch'],\n"
              - "      'region': os.environ['Region'],\n"
              - "      'base_path': os.environ['StackName']\n"
              - "    }\n"
              - "  }\n"
              - "  req_snap = MethodRequest(\n"
              - "    'http://' + dnsname + ':9200/_snapshot/s3_repository?pretty',\n"
              - "    data=json.dumps(req_snap_data),\n"
              - "    method='PUT',\n"
              - "    headers={'Content-Type': 'application/json'}\n"
              - "  )\n"
              - "  f = urllib2.urlopen(req_snap)\n"
              - "  logger.info(f.read())\n"
              - "  time.sleep(3)\n"
              - "  req = MethodRequest('http://' + dnsname + ':9200/_snapshot/s3_repository/'\
                \ + mydate, method='PUT')\n"
              - "  f = urllib2.urlopen(req)\n"
              - "  logger.info(f.read())\n"
              - "  return(0)\n"
      Description: ElasticSearch SnapShot
      Environment:
        Variables:
          AutoScalingGroup:
            Ref: AutoScalingGroup
          BucketElasticSearch:
            Fn::Sub: ${AWS::Region}-arda-aman-${EnvShort}-elasticsearch
          Env:
            Ref: EnvShort
          EnvRole:
            Ref: EnvRole
          Region:
            Ref: AWS::Region
          StackName:
            Ref: AWS::StackName
      FunctionName:
        Fn::Sub: ${AWS::StackName}-${EnvRole}-ElasticSearchSnapShot
      Handler: index.lambda_handler
      MemorySize: 128
      Role:
        Fn::GetAtt:
          - RoleLambdaElasticSearchSnapShot
          - Arn
      Runtime: python2.7
      Timeout: 10
      VpcConfig:
        SecurityGroupIds:
          - Fn::ImportValue: SecurityGroupElasticSearch
        SubnetIds:
          Fn::Split:
            - ','
            - Fn::ImportValue: SubnetsPrivate
    Type: AWS::Lambda::Function
  LambdaPermissionElasticSearchSnapShotEventsRuleElasticSearchSnapShot:
    Properties:
      Action: lambda:InvokeFunction
      FunctionName:
        Fn::GetAtt:
          - LambdaElasticSearchSnapShot
          - Arn
      Principal: events.amazonaws.com
      SourceArn:
        Fn::GetAtt:
          - EventsRuleElasticSearchSnapShot
          - Arn
    Type: AWS::Lambda::Permission
  LaunchTemplate:
    Metadata:
      AWS::CloudFormation::Authentication:
        CfnS3Auth:
          buckets:
            - Fn::Sub: ${AWS::Region}-arda-aman-app-repository
            - Fn::Sub: ${AWS::Region}-arda-aman-app-data
          roleName:
            Ref: RoleInstance
          type: S3
      AWS::CloudFormation::Init:
        CWAGENT:
          files:
            /opt/aws/amazon-cloudwatch-agent/etc/amazon-cloudwatch-agent.json:
              content:
                Fn::Join:
                  - ''
                  - - "{\n"
                    - "  \"metrics\": {\n"
                    - "    \"append_dimensions\": {\n"
                    - "      \"AutoScalingGroupName\": \"${aws:AutoScalingGroupName}\"\
                      ,\n"
                    - "      \"InstanceId\": \"${!aws:InstanceId}\"\n"
                    - "    },\n"
                    - "    \"aggregation_dimensions\": [\n"
                    - "      [\"AutoScalingGroupName\"]\n"
                    - "    ],\n"
                    - "    \"metrics_collected\": {\n"
                    - "      \"mem\": {\n"
                    - "        \"measurement\": [\n"
                    - "          \"mem_used_percent\"\n"
                    - "        ]\n"
                    - "      },\n"
                    - "      \"disk\": {\n"
                    - "        \"resources\": [\n"
                    - "          \"/\"\n"
                    - "        ],\n"
                    - "        \"measurement\": [\n"
                    - "          {\n"
                    - "            \"name\": \"disk_used_percent\",\n"
                    - "            \"rename\": \"root_disk_used_percent\"\n"
                    - "          }\n"
                    - "        ],\n"
                    - "        \"drop_device\": true\n"
                    - "      }\n"
                    - "    }\n"
                    - "  }\n"
                    - "}\n"
          packages:
            rpm:
              amazon-cloudwatch-agent: https://s3.amazonaws.com/amazoncloudwatch-agent/amazon_linux/amd64/latest/amazon-cloudwatch-agent.rpm
          services:
            sysvinit:
              amazon-cloudwatch-agent:
                ensureRunning: 'true'
                files:
                  - /opt/aws/amazon-cloudwatch-agent/etc/amazon-cloudwatch-agent.json
        ELBWAITER:
          commands:
            ELBClassicInternalHealthCheck:
              command:
                Fn::Join:
                  - ''
                  - - until [ "$state" = '"InService"' ]; do
                    - '  state=$(aws --region '
                    - Ref: AWS::Region
                    - ' elb describe-instance-health'
                    - '  --load-balancer-name '
                    - Ref: LoadBalancerClassicInternal
                    - '  --instances $(curl -s http://169.254.169.254/latest/meta-data/instance-id)'
                    - '  --query InstanceStates[0].State);'
                    - '  sleep 10;'
                    - done
        PACKAGES:
          commands:
            01_disable-epel:
              command: yum-config-manager --disable epel >/dev/null
            02_install-ES-plugin-discovery-ec2:
              command: ./elasticsearch-plugin install --batch discovery-ec2
              cwd: /usr/share/elasticsearch/bin
              test: test ! -e /usr/share/elasticsearch/plugins/discovery-ec2
            03_install-ES-plugin-repository-s3:
              command: ./elasticsearch-plugin install --batch repository-s3
              cwd: /usr/share/elasticsearch/bin
              test: test ! -e /usr/share/elasticsearch/plugins/repository-s3
            06_install-ES-plugin-analysis-icu:
              command: ./elasticsearch-plugin install --batch analysis-icu
              cwd: /usr/share/elasticsearch/bin
              test: test ! -e /usr/share/elasticsearch/plugins/analysis-icu
            07_configure_kibana:
              command: sed -i '/^#server.host/ s/localhost/0.0.0.0/;/^#server.host/
                s/^#//' /etc/kibana/kibana.yml
          packages:
            yum:
              elasticsearch: []
              java-11-amazon-corretto-headless: []
              jq: []
              kibana: []
          services:
            sysvinit:
              elasticsearch:
                enabled: 'false'
              kibana:
                enabled: 'false'
        REPOSITORIES:
          commands:
            10_epel-repo:
              command: yum install -y https://dl.fedoraproject.org/pub/epel/epel-release-latest-7.noarch.rpm
              test: '! test -e /etc/yum.repos.d/epel.repo'
            20_elastic.co-signature:
              command: rpm --import https://artifacts.elastic.co/GPG-KEY-elasticsearch
              test: '! rpm -qi gpg-pubkey-d88e42b4-52371eca'
            40_repo-set-options:
              command: yum-config-manager --save --setopt=\*.skip_if_unavailable=1
          files:
            /etc/yum.repos.d/elasticsearch.repo:
              content:
                Fn::Join:
                  - ''
                  - - "[elasticsearch-6.x]\n"
                    - "name=Elasticsearch repository for 6.x packages\n"
                    - "baseurl=https://artifacts.elastic.co/packages/6.x/yum\n"
                    - "gpgcheck=1\n"
                    - "gpgkey=https://artifacts.elastic.co/GPG-KEY-elasticsearch\n"
                    - "enabled=1\n"
        SERVICES:
          commands:
            10-etc_sysconfig_elasticsearch:
              command:
                Fn::Join:
                  - ''
                  - - export MY_ES_HEAP_SIZE=$(expr $(grep "MemTotal:" /proc/meminfo
                      | egrep -o "([[:digit:]]+)") / 1000 / 2)m;
                    - "echo -e \"# Heap size defaults to 256m min, 1g max\n"
                    - "# Set ES_HEAP_SIZE to 50% of available RAM, but no more than\
                      \ 31g\n"
                    - ES_JAVA_OPTS=\"-Xms${MY_ES_HEAP_SIZE} -Xmx${MY_ES_HEAP_SIZE}
                      -XX:NewRatio=6\"" > /etc/sysconfig/elasticsearch
                    - ' && chgrp elasticsearch /etc/sysconfig/elasticsearch'
          files:
            /etc/elasticsearch/elasticsearch.yml:
              content:
                Fn::Join:
                  - ''
                  - - "cluster.name: aman-elasticsearch\n"
                    - "network.host: ['_local:ipv4_', '_site:ipv4_']\n"
                    - 'discovery.ec2.groups: '
                    - Ref: SecurityGroupInstancesRules
                    - "\npath.data: /var/lib/elasticsearch\n"
                    - "path.logs: /var/log/elasticsearch\n"
                    - "discovery.zen.hosts_provider: ec2\n"
                    - 'discovery.ec2.endpoint: '
                    - Fn::Sub: ec2.${AWS::Region}.amazonaws.com
                    - "\n"
              group: elasticsearch
          services:
            sysvinit:
              elasticsearch:
                ensureRunning: 'true'
                files:
                  - /etc/elasticsearch/elasticsearch.yml
                  - /etc/sysconfig/elasticsearch
              kibana:
                ensureRunning: 'true'
        SETUP:
          commands:
            01_disk:
              command:
                Fn::Join:
                  - ''
                  - - "n=0\n"
                    - "for disk in /dev/xvd[b-d]; do\n"
                    - "  [ -b \"$disk\" ] || continue\n"
                    - '  file -s "$disk" | grep -q "ext[34] filesystem" || '
                    - "  { mkfs.ext4 $disk || continue; }\n"
                    - '  mkdir -p /media/ephemeral${n} && '
                    - "  mount $disk /media/ephemeral${n}\n"
                    - "  n=$(($n+1))\n"
                    - done
            02_disk_additional:
              Fn::If:
                - LaunchTemplateDataBlockDeviceMappingsAdditionalStorageMount
                - command:
                    Fn::Sub:
                      - "file -s ${LaunchTemplateDataBlockDeviceMappingsAdditionalStorageDeviceName}1\
                        \ | grep -q \"ext[34] filesystem\" || { parted -s ${LaunchTemplateDataBlockDeviceMappingsAdditionalStorageDeviceName}\
                        \ mklabel gpt && parted -s ${LaunchTemplateDataBlockDeviceMappingsAdditionalStorageDeviceName}\
                        \ mkpart primary ext2 1 ${LaunchTemplateDataBlockDeviceMappingsAdditionalStorageEbsVolumeSize}G\
                        \ && mkfs.ext4 ${LaunchTemplateDataBlockDeviceMappingsAdditionalStorageDeviceName}1\
                        \ || continue; }\nmkdir -p /data && mount ${LaunchTemplateDataBlockDeviceMappingsAdditionalStorageDeviceName}1\
                        \ /data"
                      - LaunchTemplateDataBlockDeviceMappingsAdditionalStorageDeviceName: /dev/xvdx
                        LaunchTemplateDataBlockDeviceMappingsAdditionalStorageEbsVolumeSize:
                          Fn::If:
                            - LaunchTemplateDataBlockDeviceMappingsAdditionalStorageEbsVolumeSizeOverride
                            - Ref: LaunchTemplateDataBlockDeviceMappingsAdditionalStorageEbsVolumeSize
                            - 0
                - Ref: AWS::NoValue
            03_efs_mounts:
              Fn::If:
                - EfsMounts
                - command:
                    Fn::Join:
                      - ''
                      - - 'for mounts in '
                        - Fn::Join:
                            - ' '
                            - Ref: EfsMounts
                        - ";do\n"
                        - "  mkdir -p \"/media/${mounts}\"\n"
                        - '  mountpoint -q "/media/${mounts}" ||'
                        - '    mount -t nfs4 -o nfsvers=4,rsize=1048576,wsize=1048576,hard,timeo=600,retrans=2 '
                        - '    efs-${mounts}.'
                        - internal.aman.arda
                        - ':/ '
                        - "    /media/${mounts}\n"
                        - done
                - Ref: AWS::NoValue
            04_rmdir_tmp_ibox:
              command: rm -fr /tmp/ibox
          files:
            /etc/cfn/cfn-hup.conf:
              content:
                Fn::Join:
                  - ''
                  - - "[main]\n"
                    - stack=
                    - Ref: AWS::StackId
                    - "\n"
                    - region=
                    - Ref: AWS::Region
                    - "\n"
                    - role=
                    - Ref: RoleInstance
                    - "\n"
                    - "interval=5\n"
              group: root
              mode: '000400'
              owner: root
            /etc/cfn/hooks.d/cfn-auto-reloader.conf:
              content:
                Fn::Join:
                  - ''
                  - - "[cfn-auto-reloader-hook]\n"
                    - "triggers=post.add, post.update\n"
                    - "path=Resources.LaunchTemplate.Metadata.CloudFormationInitVersion\n"
                    - action=/opt/aws/bin/cfn-init -v
                    - ' --stack '
                    - Ref: AWS::StackName
                    - ' --role '
                    - Ref: RoleInstance
                    - ' --resource LaunchTemplate'
                    - ' --region '
                    - Ref: AWS::Region
                    - "\n"
                    - "runas=root\n"
            /etc/profile.d/ibox_env.sh:
              content:
                Fn::Join:
                  - ''
                  - - "#setup ibox environment variables\n"
                    - export Env=
                    - Ref: Env
                    - "\n"
                    - export EnvAbbr=
                    - Ref: EnvShort
                    - "\n"
                    - export EnvRegion=
                    - Ref: AWS::Region
                    - "\n"
                    - export EnvAccountId=
                    - Ref: AWS::AccountId
                    - "\n"
                    - export EnvRole=
                    - Ref: EnvRole
                    - "\n"
                    - export EnvBrand=
                    - aman.arda
                    - "\n"
                    - export EnvStackName=
                    - Ref: AWS::StackName
                    - "\n"
          services:
            sysvinit:
              cfn-hup:
                enabled: 'false'
                ensureRunning: 'true'
                files:
                  - /etc/cfn/cfn-hup.conf
                  - /etc/cfn/hooks.d/cfn-auto-reloader.conf
        configSets:
          buildami:
            - REPOSITORIES
            - PACKAGES
          buildamifull:
            - REPOSITORIES
            - PACKAGES
            - SETUP
          default:
            - REPOSITORIES
            - PACKAGES
            - SETUP
            - Ref: AWS::NoValue
            - SERVICES
            - Fn::If:
                - CloudWatchAgent
                - CWAGENT
                - Ref: AWS::NoValue
            - ELBWAITER
      CloudFormationInitVersion:
        Fn::If:
          - CloudFormationInit
          - Ref: EnvStackVersion
          - Ref: AWS::NoValue
    Properties:
      LaunchTemplateData:
        BlockDeviceMappings:
          - DeviceName: /dev/xvda
            Ebs:
              VolumeSize:
                Fn::If:
                  - LaunchTemplateDataBlockDeviceMappingsXvdaEbsVolumeSizeOverride
                  - Ref: LaunchTemplateDataBlockDeviceMappingsXvdaEbsVolumeSize
                  - Fn::FindInMap:
                      - Ref: EnvShort
                      - Ref: AWS::Region
                      - LaunchTemplateDataBlockDeviceMappingsXvdaEbsVolumeSize
              VolumeType: gp2
          - Fn::If:
              - LaunchTemplateDataBlockDeviceMappingsAdditionalStorage
              - DeviceName: /dev/xvdx
                Ebs:
                  VolumeSize:
                    Fn::If:
                      - LaunchTemplateDataBlockDeviceMappingsAdditionalStorageEbsVolumeSizeOverride
                      - Ref: LaunchTemplateDataBlockDeviceMappingsAdditionalStorageEbsVolumeSize
                      - 0
                  VolumeType: gp2
              - Ref: AWS::NoValue
          - Fn::If:
              - InstaceEphemeral0
              - DeviceName: /dev/xvdb
                VirtualName: ephemeral0
              - Ref: AWS::NoValue
          - Fn::If:
              - InstaceEphemeral1
              - DeviceName: /dev/xvdc
                VirtualName: ephemeral1
              - Ref: AWS::NoValue
          - Fn::If:
              - InstaceEphemeral2
              - DeviceName: /dev/xvdd
                VirtualName: ephemeral2
              - Ref: AWS::NoValue
        IamInstanceProfile:
          Arn:
            Fn::GetAtt:
              - InstanceProfile
              - Arn
        ImageId:
          Fn::If:
            - LaunchTemplateDataImageIdLatest
            - Ref: LaunchTemplateDataImageIdLatest
            - Fn::If:
                - LaunchTemplateDataImageIdOverride
                - Ref: LaunchTemplateDataImageId
                - Fn::FindInMap:
                    - Ref: EnvShort
                    - Ref: AWS::Region
                    - LaunchTemplateDataImageId
        InstanceMarketOptions:
          Fn::If:
            - LaunchTemplateDataInstanceMarketOptionsSpotOptionsMaxPrice
            - MarketType: spot
              SpotOptions:
                MaxPrice:
                  Fn::If:
                    - LaunchTemplateDataInstanceMarketOptionsSpotOptionsMaxPriceOverride
                    - Ref: LaunchTemplateDataInstanceMarketOptionsSpotOptionsMaxPrice
                    - '0'
            - Ref: AWS::NoValue
        InstanceType:
          Fn::If:
            - LaunchTemplateDataInstanceTypeOverride
            - Ref: LaunchTemplateDataInstanceType
            - Fn::FindInMap:
                - Ref: EnvShort
                - Ref: AWS::Region
                - LaunchTemplateDataInstanceType
        KeyName:
          Fn::If:
            - LaunchTemplateDataKeyNameOverride
            - Ref: LaunchTemplateDataKeyName
            - None
        Monitoring:
          Enabled: 'false'
        NetworkInterfaces:
          - AssociatePublicIpAddress: 'false'
            DeviceIndex: 0
            Groups:
              - Fn::GetAtt:
                  - SecurityGroupInstancesRules
                  - GroupId
              - Fn::If:
                  - SecurityGroup0
                  - Fn::ImportValue:
                      Fn::Sub:
                        - SecurityGroup${ImportName}
                        - ImportName:
                            Fn::Select:
                              - 0
                              - Fn::Split:
                                  - ','
                                  - Fn::If:
                                      - SecurityGroupsOverride
                                      - Ref: SecurityGroups
                                      - BaseInstance,ElasticSearch,None,None
                  - Ref: AWS::NoValue
              - Fn::If:
                  - SecurityGroup1
                  - Fn::ImportValue:
                      Fn::Sub:
                        - SecurityGroup${ImportName}
                        - ImportName:
                            Fn::Select:
                              - 1
                              - Fn::Split:
                                  - ','
                                  - Fn::If:
                                      - SecurityGroupsOverride
                                      - Ref: SecurityGroups
                                      - BaseInstance,ElasticSearch,None,None
                  - Ref: AWS::NoValue
              - Fn::If:
                  - SecurityGroup2
                  - Fn::ImportValue:
                      Fn::Sub:
                        - SecurityGroup${ImportName}
                        - ImportName:
                            Fn::Select:
                              - 2
                              - Fn::Split:
                                  - ','
                                  - Fn::If:
                                      - SecurityGroupsOverride
                                      - Ref: SecurityGroups
                                      - BaseInstance,ElasticSearch,None,None
                  - Ref: AWS::NoValue
              - Fn::If:
                  - SecurityGroup3
                  - Fn::ImportValue:
                      Fn::Sub:
                        - SecurityGroup${ImportName}
                        - ImportName:
                            Fn::Select:
                              - 3
                              - Fn::Split:
                                  - ','
                                  - Fn::If:
                                      - SecurityGroupsOverride
                                      - Ref: SecurityGroups
                                      - BaseInstance,ElasticSearch,None,None
                  - Ref: AWS::NoValue
        TagSpecifications:
          - ResourceType: instance
            Tags:
              - Key: Name
                Value:
                  Ref: EnvRole
              - Key: EnvStackName
                Value:
                  Ref: AWS::StackName
          - ResourceType: volume
            Tags:
              - Key: Name
                Value:
                  Ref: EnvRole
              - Key: EnvStackName
                Value:
                  Ref: AWS::StackName
        UserData:
          Fn::Base64:
            Fn::Join:
              - ''
              - - "#!/bin/bash\n"
                - "PATH=/opt/aws/bin:$PATH\n"
                - "export BASH_ENV=/etc/profile.d/ibox_env.sh\n"
                - "export ENV=$BASH_ENV\n"
                - "yum -C list installed aws-cfn-bootstrap || yum install -y aws-cfn-bootstrap\n"
                - Fn::Sub: ''
                - cfn-init -v
                - ' --stack '
                - Ref: AWS::StackName
                - ' --role '
                - Ref: RoleInstance
                - ' --resource LaunchTemplate'
                - ' --region '
                - Ref: AWS::Region
                - "\n"
                - Fn::If:
                    - DoNotSignal
                    - Ref: AWS::NoValue
                    - Fn::Sub: "cfn-signal -e $? --stack ${AWS::StackName} --role\
                        \ ${RoleInstance} --resource AutoScalingGroup --region ${AWS::Region}\n"
                - "rm /var/lib/cloud/instance/sem/config_scripts_user\n"
      LaunchTemplateName:
        Fn::Sub: ${AWS::StackName}-${EnvRole}
    Type: AWS::EC2::LaunchTemplate
  LoadBalancerClassicInternal:
    Properties:
      AccessLoggingPolicy:
        Fn::If:
          - LoadBalancerLog
          - EmitInterval:
              Fn::If:
                - LoadBalancerLogOverride
                - Ref: LoadBalancerLog
                - None
            Enabled: true
            S3BucketName:
              Fn::Sub: ${AWS::Region}-arda-aman-${EnvShort}-logs
            S3BucketPrefix: ''
          - Ref: AWS::NoValue
      ConnectionDrainingPolicy:
        Enabled: true
        Timeout: 5
      ConnectionSettings:
        IdleTimeout: 60
      CrossZone: 'true'
      HealthCheck:
        HealthyThreshold: 2
        Interval: 30
        Target: HTTP:9200/
        Timeout: 6
        UnhealthyThreshold: 3
      LBCookieStickinessPolicy:
        Fn::If:
          - LoadBalancerCookieSticky
          - - CookieExpirationPeriod: None
              PolicyName: LBCookieStickinessPolicy
          - Ref: AWS::NoValue
      Listeners:
        - InstancePort: 9200
          LoadBalancerPort: 9200
          PolicyNames:
            - Fn::If:
                - LoadBalancerCookieSticky
                - LBCookieStickinessPolicy
                - Ref: AWS::NoValue
          Protocol: HTTP
          SSLCertificateId:
            Fn::If:
              - ListenerLoadBalancerHttpsPort
              - Fn::FindInMap:
                  - Ref: EnvShort
                  - Ref: AWS::Region
                  - RegionalCertificateArn
              - Ref: AWS::NoValue
        - InstancePort: 5601
          LoadBalancerPort: 5601
          PolicyNames:
            - Fn::If:
                - LoadBalancerCookieSticky
                - LBCookieStickinessPolicy
                - Ref: AWS::NoValue
          Protocol: TCP
          SSLCertificateId:
            Fn::If:
              - ListenerLoadBalancerHttpsPort
              - Fn::FindInMap:
                  - Ref: EnvShort
                  - Ref: AWS::Region
                  - RegionalCertificateArn
              - Ref: AWS::NoValue
      Scheme: internal
      SecurityGroups:
        - Fn::GetAtt:
            - SecurityGroupLoadBalancer
            - GroupId
      Subnets:
        Fn::Split:
          - ','
          - Fn::ImportValue: SubnetsPrivate
    Type: AWS::ElasticLoadBalancing::LoadBalancer
  RecordSetExternal:
    Properties:
      AliasTarget:
        DNSName:
          Fn::Sub: dualstack.${LoadBalancerClassicInternal.DNSName}
        HostedZoneId:
          Fn::FindInMap:
            - Ref: EnvShort
            - Ref: AWS::Region
            - HostedZoneIdLB
      HostedZoneId:
        Fn::ImportValue: HostedZoneIdEnv
      Name:
        Fn::Sub: ${AWS::StackName}.${EnvRole}.${AWS::Region}.${EnvShort}.aman.arda
      Type: A
    Type: AWS::Route53::RecordSet
  RecordSetInternal:
    Properties:
      AliasTarget:
        DNSName:
          Fn::Sub: dualstack.${LoadBalancerClassicInternal.DNSName}
        HostedZoneId:
          Fn::FindInMap:
            - Ref: EnvShort
            - Ref: AWS::Region
            - HostedZoneIdLB
      HostedZoneId:
        Fn::ImportValue: HostedZoneIdPrivate
      Name:
        Fn::Sub: ${AWS::StackName}.${EnvRole}.internal.aman.arda
      Type: A
    Type: AWS::Route53::RecordSet
  RoleInstance:
    Properties:
      AssumeRolePolicyDocument:
        Statement:
          - Action: sts:AssumeRole
            Effect: Allow
            Principal:
              Service:
                - ec2.amazonaws.com
      ManagedPolicyArns:
        - Fn::ImportValue: IAMPolicyBaseInstance
        - Fn::ImportValue: IAMPolicySSM
        - Fn::If:
            - CloudWatchAgent
            - arn:aws:iam::aws:policy/CloudWatchAgentServerPolicy
            - Ref: AWS::NoValue
      Path: /
    Type: AWS::IAM::Role
  RoleLambdaElasticSearchSnapShot:
    Properties:
      AssumeRolePolicyDocument:
        Statement:
          - Action: sts:AssumeRole
            Effect: Allow
            Principal:
              Service:
                - lambda.amazonaws.com
                - Ref: AWS::NoValue
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/AmazonEC2ReadOnlyAccess
        - arn:aws:iam::aws:policy/service-role/AWSLambdaVPCAccessExecutionRole
      Path: /
    Type: AWS::IAM::Role
  ScheduledActionDown:
    Condition: ScheduledActionDown
    Properties:
      AutoScalingGroupName:
        Ref: AutoScalingGroup
      DesiredCapacity:
        Fn::If:
          - ScheduledActionDownCapacityDesiredSize
          - Fn::If:
              - CapacityDesiredOverride
              - Ref: CapacityDesired
              - Fn::FindInMap:
                  - Ref: EnvShort
                  - Ref: AWS::Region
                  - CapacityDesired
          - Fn::If:
              - ScheduledActionDownKeepDesiredSize
              - Ref: AWS::NoValue
              - Fn::If:
                  - ScheduledActionDownDesiredSizeOverride
                  - Ref: ScheduledActionDownDesiredSize
                  - Fn::FindInMap:
                      - Ref: EnvShort
                      - Ref: AWS::Region
                      - ScheduledActionDownDesiredSize
      MaxSize:
        Fn::If:
          - ScheduledActionDownCapacityMaxSize
          - Fn::If:
              - CapacityMaxOverride
              - Ref: CapacityMax
              - Fn::FindInMap:
                  - Ref: EnvShort
                  - Ref: AWS::Region
                  - CapacityMax
          - Fn::If:
              - ScheduledActionDownKeepMaxSize
              - Ref: AWS::NoValue
              - Fn::If:
                  - ScheduledActionDownMaxSizeOverride
                  - Ref: ScheduledActionDownMaxSize
                  - CapacityMax
      MinSize:
        Fn::If:
          - ScheduledActionDownCapacityMinSize
          - Fn::If:
              - CapacityMinOverride
              - Ref: CapacityMin
              - Fn::FindInMap:
                  - Ref: EnvShort
                  - Ref: AWS::Region
                  - CapacityMin
          - Fn::If:
              - ScheduledActionDownKeepMinSize
              - Ref: AWS::NoValue
              - Fn::If:
                  - ScheduledActionDownMinSizeOverride
                  - Ref: ScheduledActionDownMinSize
                  - CapacityMin
      Recurrence:
        Fn::If:
          - ScheduledActionDownRecurrenceOverride
          - Ref: ScheduledActionDownRecurrence
          - 00 19 * * *
      StartTime:
        Fn::If:
          - ScheduledActionDownStartTimeOverride
          - Ref: ScheduledActionDownStartTime
          - Ref: AWS::NoValue
    Type: AWS::AutoScaling::ScheduledAction
  ScheduledActionUp:
    Condition: ScheduledActionUp
    Properties:
      AutoScalingGroupName:
        Ref: AutoScalingGroup
      DesiredCapacity:
        Fn::If:
          - ScheduledActionUpCapacityDesiredSize
          - Fn::If:
              - CapacityDesiredOverride
              - Ref: CapacityDesired
              - Fn::FindInMap:
                  - Ref: EnvShort
                  - Ref: AWS::Region
                  - CapacityDesired
          - Fn::If:
              - ScheduledActionUpKeepDesiredSize
              - Ref: AWS::NoValue
              - Fn::If:
                  - ScheduledActionUpDesiredSizeOverride
                  - Ref: ScheduledActionUpDesiredSize
                  - CapacityDesired
      MaxSize:
        Fn::If:
          - ScheduledActionUpCapacityMaxSize
          - Fn::If:
              - CapacityMaxOverride
              - Ref: CapacityMax
              - Fn::FindInMap:
                  - Ref: EnvShort
                  - Ref: AWS::Region
                  - CapacityMax
          - Fn::If:
              - ScheduledActionUpKeepMaxSize
              - Ref: AWS::NoValue
              - Fn::If:
                  - ScheduledActionUpMaxSizeOverride
                  - Ref: ScheduledActionUpMaxSize
                  - CapacityMax
      MinSize:
        Fn::If:
          - ScheduledActionUpCapacityMinSize
          - Fn::If:
              - CapacityMinOverride
              - Ref: CapacityMin
              - Fn::FindInMap:
                  - Ref: EnvShort
                  - Ref: AWS::Region
                  - CapacityMin
          - Fn::If:
              - ScheduledActionUpKeepMinSize
              - Ref: AWS::NoValue
              - Fn::If:
                  - ScheduledActionUpMinSizeOverride
                  - Ref: ScheduledActionUpMinSize
                  - CapacityMin
      Recurrence:
        Fn::If:
          - ScheduledActionUpRecurrenceOverride
          - Ref: ScheduledActionUpRecurrence
          - 30 08 * * mon-fri
      StartTime:
        Fn::If:
          - ScheduledActionUpStartTimeOverride
          - Ref: ScheduledActionUpStartTime
          - Ref: AWS::NoValue
    Type: AWS::AutoScaling::ScheduledAction
  SecurityGroupIngressElasticSearchClient:
    Properties:
      FromPort: 9200
      GroupId:
        Fn::Sub: ${SecurityGroupLoadBalancer.GroupId}
      IpProtocol: tcp
      SourceSecurityGroupId:
        Fn::ImportValue: SecurityGroupElasticSearch
      ToPort: 9200
    Type: AWS::EC2::SecurityGroupIngress
  SecurityGroupIngressElasticSearchClientOnInstance:
    Properties:
      FromPort: 9200
      GroupId:
        Fn::Sub: ${SecurityGroupInstancesRules.GroupId}
      IpProtocol: tcp
      SourceSecurityGroupId:
        Fn::ImportValue: SecurityGroupElasticSearch
      ToPort: 9200
    Type: AWS::EC2::SecurityGroupIngress
  SecurityGroupIngressElasticSearchCluster:
    Properties:
      FromPort: 9300
      GroupId:
        Fn::Sub: ${SecurityGroupInstancesRules.GroupId}
      IpProtocol: tcp
      SourceSecurityGroupId:
        Ref: SecurityGroupInstancesRules
      ToPort: 9400
    Type: AWS::EC2::SecurityGroupIngress
  SecurityGroupIngressListenersPort5601:
    Properties:
      FromPort: 5601
      GroupId:
        Fn::GetAtt:
          - SecurityGroupInstancesRules
          - GroupId
      IpProtocol: tcp
      SourceSecurityGroupId:
        Ref: SecurityGroupLoadBalancer
      ToPort: 5601
    Type: AWS::EC2::SecurityGroupIngress
  SecurityGroupIngressListenersPort9200:
    Properties:
      FromPort: 9200
      GroupId:
        Fn::GetAtt:
          - SecurityGroupInstancesRules
          - GroupId
      IpProtocol: tcp
      SourceSecurityGroupId:
        Ref: SecurityGroupLoadBalancer
      ToPort: 9200
    Type: AWS::EC2::SecurityGroupIngress
  SecurityGroupInstancesRules:
    Properties:
      GroupDescription: Enable Access from LoadBalancer to Instances and between Instances
      VpcId:
        Fn::ImportValue: VpcId
    Type: AWS::EC2::SecurityGroup
  SecurityGroupLoadBalancer:
    Properties:
      GroupDescription: Enable access to LoadBalancer
      SecurityGroupIngress: []
      VpcId:
        Fn::ImportValue: VpcId
    Type: AWS::EC2::SecurityGroup

