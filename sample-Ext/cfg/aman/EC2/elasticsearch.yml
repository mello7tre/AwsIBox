IBoxLoader: !exclude [
  cloudfront/cloudfront-ios.yml,
]

elasticsearch:
  StackName: els
  Alarm:
    - CPUHigh:
        EvaluationPeriods: 0
    - CPULow:
        EvaluationPeriods: 0
    - DiskUsed:
        IBOXENABLED: True
  Apps: []
  DeploymentGroup: None 
  EventsRule:
    - ElasticSearchSnapShot:
        Description: 'Periodically invoke LambdaElasticSearchSnapShot'
        ScheduleExpression: 'cron(15 2 * * ? *)'
        State: 'ENABLED'
        Targets:
          - LambdaElasticSearchSnapShot:
              Arn: GetAtt('LambdaElasticSearchSnapShot', 'Arn')
              Id: 'TargetFunction-01'
  HealthCheckTarget: HTTP:9200/
  Lambda:
    - ElasticSearchSnapShot:
        Description: 'ElasticSearch SnapShot' 
        MemorySize: 128
        Runtime: python2.7
        SecurityGroupIds: [get_expvalue('SecurityGroupElasticSearch')]
        SubnetIds: Split(',', get_expvalue('SubnetsPrivate'))
        Timeout: 10
        Variables:
          - AutoScalingGroup: Ref('AutoScalingGroup')
          - BucketElasticSearch: Sub(get_endvalue('BucketElasticSearch'))
          - Region: Ref('AWS::Region')
          - StackName: Ref('AWS::StackName')
  LaunchTemplateData:
    BlockDeviceMappingsXvdaEbsVolumeSize: 100
    InstanceType: t3a.large
  Listeners:
    - Port9200:
        Access: AllowedIp
        InstancePort: 9200
        LoadBalancerPort: 9200
        Protocol: HTTP
    - Port5601:
        Access: AllowedIp
        InstancePort: 5601
        LoadBalancerPort: 5601
        Protocol: TCP
  LoadBalancerClassic: ['Internal']
  IAMPolicy:
    - ESSnapshot:
        Roles:
          - Ref('RoleInstance')
        Statement:
          - 1:
              Action:
                - 's3:CreateBucket'
                - 's3:ListBucket'
                - 's3:GetBucketLocation'
                - 's3:ListBucketMultipartUploads'
                - 's3:ListBucketVersions'
              Resource: Sub(f'arn:aws:s3:::{cfg.BucketElasticSearch}')
          - 2:
              Action:
                - 's3:GetObject'
                - 's3:PutObject'
                - 's3:DeleteObject'
                - 's3:AbortMultipartUpload'
                - 's3:ListMultipartUploadParts'
              Resource: Sub(f'arn:aws:s3:::{cfg.BucketElasticSearch}/*')
    - ESSnapshotRO:
        Roles:
          - Ref('RoleInstance')
        Statement:
          - 1:
              Action:
                - 's3:ListBucket'
                - 's3:GetBucketLocation'
                - 's3:ListBucketMultipartUploads'
                - 's3:ListBucketVersions'
              Resource:
                - 'arn:aws:s3:::eu-west-1-arda-aman-dev-elasticsearch'
                - 'arn:aws:s3:::eu-west-1-arda-aman-stg-elasticsearch'
                - 'arn:aws:s3:::eu-west-1-arda-aman-prd-elasticsearch'
          - 2:
              Action:
                - 's3:GetObject'
                - 's3:ListMultipartUploadParts'
              Resource:
                - 'arn:aws:s3:::eu-west-1-arda-aman-dev-elasticsearch/*'
                - 'arn:aws:s3:::eu-west-1-arda-aman-stg-elasticsearch/*'
                - 'arn:aws:s3:::eu-west-1-arda-aman-prd-elasticsearch/*'
  SecurityGroupIngress:
    - ElasticSearchClient:
        FromPort: 9200
        GroupId: Sub('${SecurityGroupLoadBalancer.GroupId}')
        SourceSecurityGroupId: get_expvalue('SecurityGroupElasticSearch')
        ToPort: 9200
    - ElasticSearchClientOnInstance:
        FromPort: 9200
        GroupId: Sub('${SecurityGroupInstancesRules.GroupId}')
        SourceSecurityGroupId: get_expvalue('SecurityGroupElasticSearch')
        ToPort: 9200
    - ElasticSearchCluster:
        FromPort: 9300
        GroupId: Sub('${SecurityGroupInstancesRules.GroupId}')
        SourceSecurityGroupId: Ref('SecurityGroupInstancesRules')
        ToPort: 9400
  SecurityGroups: 'BaseInstance,ElasticSearch,None,None'

dev: &cfg_dev
  Capacity:
    Desired: 2
    Max: 3
  ScheduledAction:
    - Down:
        DesiredSize: 1

stg:
  <<: *cfg_dev

prd:
  CapacityDesired: 3
  LaunchTemplateData:
    BlockDeviceMappingsXvdaEbsVolumeSize: 150
    InstanceType: c5.2xlarge
  ScheduledAction:
    - Down:
        DesiredSize: 2
