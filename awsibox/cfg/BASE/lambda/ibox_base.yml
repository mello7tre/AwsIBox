Permission: &permission
  IBOX_ENABLED: False
  Action: "lambda:InvokeFunction"

Function: &function
  IBOX_ENABLED: True
  IBOX_LINKED_OBJ:
    Role:
      Key: IAMRole
      Type: Lambda
      Conf:
        IBOX_RESNAME: Role.IBOX_RESNAME
  IBOX_OUTPUT:
    - _:
        IBOX_ENABLED_IF: get_endvalue(f"{IBOX_RESNAME}Export") == True
        Value: GetAtt(IBOX_RESNAME, "Arn")
        Export: Export(IBOX_RESNAME)
  Code:
    ZipFile.IBOX_CODE_KEY: Join("", import_lambda(get_endvalue(f"{IBOX_RESNAME}CodeZipFile")))
    S3Key.IBOX_AUTO_PO:
      Description: str(f"S3Key Name for lambda {IBOX_INDEXNAME} Code")
  Export: False
  Layers.IBOX_CUSTOM_OBJ: LambdaLayers
  Handler: "index.lambda_handler"
  Role: GetAtt(f"RoleLambda{IBOX_INDEXNAME}", "Arn")
  FunctionName: Sub("${AWS::StackName}-${EnvRole}-%s" % IBOX_INDEXNAME)
  Environment:
    Variables:
      - Env: Ref('EnvShort')
      - EnvRole: Ref('EnvRole')

LayerVersion: &layer_version
  IBOX_ENABLED: True
  IBOX_LINKED_OBJ:
    Key: LambdaLayerVersionPermission
    Type: Base
    Conf:
      IBOX_RESNAME: LambdaLayerPermission.IBOX_INDEXNAME
      IBOX_LINKED_OBJ_NAME: IBOX_RESNAME
  IBOX_OUTPUT:
    - _:
        Value: Ref(IBOX_RESNAME)
  Content:
    S3Key.IBOX_AUTO_PO:
      Description: str(f"S3Key Name for lambda {IBOX_INDEXNAME} Content")

global:
  LambdaPermission:
    - IBOX_BASE: *permission
  Lambda:
    - IBOX_BASE: *function
  LambdaLayerVersion:
    - IBOX_BASE: *layer_version
