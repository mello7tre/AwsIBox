global:
  Parameter:
    - SpotASG:
        Description: 'Create SpotASG / Create SpotASG as Main ASG - empty for default based on env/role'
        AllowedValues: ['', 'True', 'Main', 'None']
  Condition:
    - RollingUpdate:
        And(
          Not(Condition('ASGMainIsSpot')),
          Equals(Ref('UpdateMode'), 'Rolling')
        )
    - WillReplace:
        And(
          Not(Condition('ASGMainIsSpot')),
          Equals(Ref('UpdateMode'), 'Replace')
        )
    - RollingUpdateSpot:
        And(
          Condition('ASGMainIsSpot'),
          Equals(Ref('UpdateMode'), 'Rolling')
        )
    - WillReplaceSpot:
        And(
          Condition('ASGMainIsSpot'),
          Equals(Ref('UpdateMode'), 'Replace')
        )
    - SpotASG:
        get_condition('', 'not_equals', 'None', 'SpotASG')
    - ASGMainIsSpot:
        And(
          Condition('SpotASG'),
          get_condition('', 'equals', 'Main', 'SpotASG')
        )
  Alarm:
    - ASGSpotNotAvailable:
        IBOXENABLED: True
    - ASGOnDemandInExcess:
        IBOXENABLED: True
  IAMPolicy:
    - SNSTopicASGSpot:
        Condition: SpotASG
        Roles:
          - Ref('RoleInstance')
        Statement:
          - 1:
              Action: 'sns:Publish'
              Resource: Ref('SNSTopicASGSpot')
    - LambdaASGSpot:
        Condition: SpotASG
        Roles:
          - Ref('RoleLambdaASGSpot')
        Statement:
          - 1:
              Action: 'autoscaling:SetDesiredCapacity'
              Resource: Sub('arn:aws:autoscaling:*:*:autoScalingGroup:*:autoScalingGroupName/${AutoScalingGroup}')
  Lambda:
    - ASGSpot:
        Condition: SpotASG
        Description: 'Rebalance Spot and OnDeman AutoScalingGroup'
        MemorySize: 128
        ReservedConcurrentExecutions: 1
        Runtime: python2.7
        Timeout: 60
        Variables:
          - ASGOnDemand: Ref('AutoScalingGroup')
          - ASGSpot: Ref('AutoScalingGroupSpot')
  ScalingPolicyTrackings:
    - ASCpu:
        AutoScalingGroupName: If('SpotASG', Ref('AutoScalingGroupSpot'), Ref('AutoScalingGroup'))
    - ASCustom:
        AutoScalingGroupName: If('SpotASG', Ref('AutoScalingGroupSpot'), Ref('AutoScalingGroup'))
        TargetTrackingConfiguration:
          CustomizedMetricSpecification:
            Dimensions:
              - AutoScaling:
                  Name: AutoScalingGroupName
                  Value: If('ASGMainIsSpot', Ref('AutoScalingGroupSpot'), Ref('AutoScalingGroup'))
  SNSSubscription:
    - ASGSpotLambdaASGSpot:
        Condition: SpotASG
        TopicArn: Ref('SNSTopicASGSpot')
        Endpoint: GetAtt('LambdaASGSpot', 'Arn')
        Protocol: lambda
  SNSTopic:
    - ASGSpot:
        Condition: SpotASG
  SpotASG: None
