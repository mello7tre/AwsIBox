IBoxLoader: !include
  - bucket-policy.yml
  - iam/policy-bucket-replica.yml

Base: &base
  IBOX_LINKED_OBJ:
    IAMRole:
      Key: IAMRole
      Type: BucketReplica
      Conf:
        IBOX_RESNAME: Role.IBOX_RESNAME.Replica
        Condition: IBOX_RESNAME.Replica
    IAMPolicy:
      Key: IAMPolicy
      Type: BucketReplica
      Conf:
        IBOX_RESNAME: IAMPolicyReplica.IBOX_RESNAME
        IBOX_LINKED_OBJ_NAME: IBOX_REMAPNAME
        IBOX_LINKED_OBJ_INDEX: IBOX_RESNAME
  IBOX_CONDITION:
    - _:
        get_condition("", "equals", "yes", f"{IBOX_RESNAME}Create")
    - _Cors:
        get_condition("", "equals", "yes", f"{IBOX_RESNAME}Cors")
    - _PolicyStatementReplicaPrincipal:
        get_condition("", "not_equals", "none", f"{IBOX_RESNAME}PolicyStatementReplicaPrincipal")
    - _Replica:
        And(Condition(IBOX_RESNAME), get_condition("", "equals", "yes", f"{IBOX_RESNAME}ReplicationConfigurationEnabled"))
    - _Versioning:
        get_condition("", "equals", "Enabled", f"{IBOX_RESNAME}Versioning")
  IBOX_OUTPUT:
    - _:
        Value: If(IBOX_RESNAME, Ref(IBOX_RESNAME), Sub(IBOX_REMAPNAME))
  OutputValueRegion.IBOX_PCO:
    IBOX_CONDITION:
      - _OutputValueRegion:
          get_condition("", "not_equals", "AWSRegion", f"{IBOX_RESNAME}OutputValueRegion")
    IBOX_OUTPUT:
      - _:
          Condition: None
          Export: Export(IBOX_RESNAME)
          Value: >-
            If(f"{IBOX_RESNAME}OutputValueRegion",
               Sub("${Region}-%s" % IBOX_REMAPNAME.replace("${AWS::Region}-", "", 1),
                   **{"Region": get_endvalue(f"{IBOX_RESNAME}OutputValueRegion")}),
               If(IBOX_RESNAME, Ref(IBOX_RESNAME), Sub(IBOX_REMAPNAME))
            )
  Condition: IBOX_RESNAME
  BucketName: Sub(IBOX_REMAPNAME)
  Create: "no"
  AccountsRead:
    dev: none
    stg: none
    prd: none
  AccountsWrite:
    dev: none
    stg: none
    prd: none
  AccountsDelete:
    dev: none
    stg: none
    prd: none
  Cors: "no"
  CorsConfiguration:
    IBOX_IF:
      - _Cors
      - IBOX_IFVALUE
      - Ref("AWS::NoValue")
    CorsRules:
      - 0:
          AllowedHeaders: ["Authorization"]
          AllowedMethods: ["GET"]
          AllowedOrigins: ["*"]
          MaxAge: 3000
  CloudFrontOriginAccessIdentityExtra:
    Dev: none
    Stg: none
    Prd: none
  PolicyStatementReplica:
    Resource: {}
    Principal: none
  ReplicationConfiguration:
    IBOX_IF:
      - _Replica
      - IBOX_IFVALUE
      - Ref("AWS::NoValue")
    Enabled: "no"
    Role: GetAtt(f"Role{IBOX_RESNAME}Replica", "Arn")
    Rules:
      - IBOX_BASE:
          IBOX_IF:
            - _ReplicationConfigurationRules.IBOX_PROPNAME.DestinationBucket
            - IBOX_IFVALUE
            - Ref("AWS::NoValue")
          Destination:
            Bucket.IBOX_PCO:
              IBOX_PARAMETER:
                - _ReplicationConfigurationRules.IBOX_PROPNAME.DestinationBucket:
                    Description: "Replica Destination Bucket - empty for default based on Env/Roles/Region"
              IBOX_CONDITION:
                - _ReplicationConfigurationRules.IBOX_PROPNAME.DestinationBucket:
                    get_condition("", "not_equals", "none", f"{IBOX_RESNAME}ReplicationConfigurationRules{IBOX_PROPNAME}DestinationBucket")
          Status: Enabled
  Versioning: Disabled
  VersioningConfiguration:
    IBOX_IF:
      - _Versioning
      - IBOX_IFVALUE
      - Ref("AWS::NoValue")
    Status: get_endvalue(f"{IBOX_RESNAME}Versioning")


global:
  Bucket:
    - IBOX_BASE: *base
