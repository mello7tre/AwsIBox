IBoxLoader: !include
  - bucket-policy.yml

Base: &base
  IBOX_LINKED_OBJ:
    Key: IAMRole
    Type: BucketReplica
    Conf:
      IBOX_RESNAME: Role.IBOX_RESNAME.Replica
      Condition: IBOX_RESNAME.Replica
  IBOX_CONDITION:
    - _:
        get_condition("", "equals", "yes", f"{IBOX_RESNAME}Create")
    - _Cors:
        get_condition("", "equals", "yes", f"{IBOX_RESNAME}Cors")
    - _PolicyStatementReplicaPrincipal:
        get_condition("", "not_equals", "none", f"{IBOX_RESNAME}PolicyStatementReplicaPrincipal")
    - _Replica:
        And(Condition(IBOX_RESNAME), get_condition("", "equals", "yes", f"{IBOX_RESNAME}ReplicationEnabled"))
    - _Versioning:
        get_condition("", "equals", "Enabled", f"{IBOX_RESNAME}Versioning")
  IBOX_OUTPUT:
    - _:
        Value: If(IBOX_RESNAME, Ref(IBOX_RESNAME), Sub(IBOX_REMAPNAME))
  OutputValueRegion.IBOX_PCO:
    IBOX_CONDITION:
      - _OutputValueRegion:
          get_condition("", "not_equals", "AWSRegion", f"{IBOX_RESNAME}OutputValueRegion")
    IBOX_OUTPUT:
      - _:
          Condition: None
          Export: Export(IBOX_RESNAME)
          Value: >-
            If(f"{IBOX_RESNAME}OutputValueRegion",
               Sub("${Region}-%s" % IBOX_REMAPNAME.replace("${AWS::Region}-", "", 1),
                   **{"Region": get_endvalue(f"{IBOX_RESNAME}OutputValueRegion")}),
               If(IBOX_RESNAME, Ref(IBOX_RESNAME), Sub(IBOX_REMAPNAME))
            )
  Condition: IBOX_RESNAME
  BucketName: Sub(IBOX_REMAPNAME)
  Create: "no"
  AccountsRead:
    dev: none
    stg: none
    prd: none
  AccountsWrite:
    dev: none
    stg: none
    prd: none
  AccountsDelete:
    dev: none
    stg: none
    prd: none
  Cors: "no"
  CorsConfiguration:
    IBOX_IF:
      - _Cors
      - IBOX_IFVALUE
      - Ref("AWS::NoValue")
    CorsRules:
      - 0:
          AllowedHeaders: ["Authorization"]
          AllowedMethods: ["GET"]
          AllowedOrigins: ["*"]
          MaxAge: 3000
  CloudFrontOriginAccessIdentityExtra:
    Dev: none
    Stg: none
    Prd: none
  PolicyStatementReplica:
    Resource: {}
    Principal: none
  Replication:
    Enabled: "no"
    ConfigurationRules: {}
  Versioning: Disabled
  VersioningConfiguration:
    IBOX_IF:
      - _Versioning
      - IBOX_IFVALUE
      - Ref("AWS::NoValue")
    Status: get_endvalue(f"{IBOX_RESNAME}Versioning")


global:
  Bucket:
    - IBOX_BASE: *base
