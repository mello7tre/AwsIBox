PoliciesLambdaECSDrainInstance: &policies_lambda_ecs_drain_instance
  Policies:
    - 1:
        PolicyDocument:
          Statement:
            - IBOX_LIST:
            - LifeCycle:
                Action: 'autoscaling:CompleteLifecycleAction'
                Effect: Allow
                Resource: '*'
            - ecs1:
                Action:
                  - 'ecs:ListContainerInstances'
                  - 'ecs:ListTasks'
                  - 'ecs:DescribeTasks'
                Effect: Allow
                Resource: '*'
            - ecs2:
                Action:
                  - 'ecs:DescribeContainerInstances'
                  - 'ecs:UpdateContainerInstancesState'
                Effect: Allow
                Resource: '*'
            - sns:
                Action: 'sns:Publish'
                Effect: Allow
                Resource: Ref('SNSTopicECSDrainInstance')
            - clf:
                Action: 'cloudformation:ListExports'
                Effect: Allow
                Resource: '*'
          Version: '2012-10-17'
        PolicyName: LambdaECSDrainInstance


global:
  Lambda:
    - ECSDrainInstance:
        IBOX_LINKED_OBJ:
          Role:
            Conf: *policies_lambda_ecs_drain_instance
        Code:
          ZipFile: str(IBOX_INDEXNAME)
        Description: 'Gracefully drain ECS tasks from EC2 instances before the instances are terminated by autoscaling.'
        MemorySize: 128
        Runtime: python3.9
        Timeout: 300
  IAMRole:
    - ASGLifecycleHookECSDrainInstance:
        Export: True
        Principal: autoscaling.amazonaws.com
        Policies:
          - ASGLifecycleHookECSDrainInstance:
              PolicyDocument:
                Statement:
                  - IBOX_LIST:
                  - 1:
                      Action: 'sns:Publish'
                      Effect: Allow
                      Resource: Ref('SNSTopicECSDrainInstance')
                Version: '2012-10-17'
              PolicyName: ASGLifecycleHookECSDrainInstance
  SNSSubscription:
    - ECSDrainInstanceLambdaECSDrainInstance:
        IBOX_SOURCE_OBJ: SNSSubscriptionLambda
        TopicArn: Ref('SNSTopicECSDrainInstance')
        Endpoint: GetAtt('LambdaECSDrainInstance', 'Arn')
        Protocol: lambda
  SNSTopic:
    - ECSDrainInstance:
        Export: True
