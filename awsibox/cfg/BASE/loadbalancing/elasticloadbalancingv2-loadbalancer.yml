LoadBalancerAttributesLogEnabled: &attr_log_enabled
  IBOX_IF:
    - LoadBalancerLog
    - IBOX_IFVALUE
    - 
      Key: access_logs.s3.enabled
      Value: 'false'
  Key: access_logs.s3.enabled
  Value: 'true'
LoadBalancerAttributesLogBucket: &attr_log_bucket
  IBOX_IF:
    - LoadBalancerLog
    - IBOX_IFVALUE
    - Ref('AWS::NoValue')
  Key: access_logs.s3.bucket
  Value: Sub(cfg.BucketNameLogs)
LoadBalancerAttributesLogPrefix: &att_log_prefix
  IBOX_IF:
    - LoadBalancerLog
    - IBOX_IFVALUE
    - Ref('AWS::NoValue')
  Key: access_logs.s3.prefix
  Value: Sub('${EnvRole}.${AWS::StackName}')

Application: &app
  IBOX_PARAMETER:
    - LoadBalancerHttp2:
        Description: 'empty for mapped value'
        AllowedValues: ['', 'true', 'false']
  LoadBalancerAttributes:
    - LogEnabled: *attr_log_enabled
    - LogBucket: *attr_log_bucket
    - LogPrefix: *att_log_prefix
    - Http2:
        Key: routing.http2.enabled
        Value: get_endvalue('LoadBalancerHttp2')
  SecurityGroups:
    - GetAtt('SecurityGroupLoadBalancer', 'GroupId')
  Type: application

NET: &net
  LoadBalancerAttributes:
    - LogEnabled: *attr_log_enabled
    - LogBucket: *attr_log_bucket
    - LogPrefix: *att_log_prefix
    - CrossZone:
        Key: load_balancing.cross_zone.enabled
        Value: 'true'
  Type: network

ALB: &alb
  <<: *app
  IBOX_OUTPUT:
    - _:
        Condition: IBOX_RESNAME
        Value: Ref(IBOX_RESNAME)
        Export: Export(Sub('%s-${AWS::StackName}' % IBOX_RESNAME))
    - _DNS:
        Condition: IBOX_RESNAME
        Value: GetAtt(IBOX_RESNAME, 'DNSName')
        Export: Export(Sub('%sDNS-${AWS::StackName}' % IBOX_RESNAME))
    - _FullName:
        Condition: IBOX_RESNAME
        Value: GetAtt(IBOX_RESNAME, 'LoadBalancerFullName')
        Export: Export(Sub('%sFullName-${AWS::StackName}' % IBOX_RESNAME))
  Condition: IBOX_RESNAME
  SecurityGroups:
    - get_expvalue(f'SecurityGroup{IBOX_RESNAME}')
    - GetAtt(f'SecurityGroup{IBOX_RESNAME}', 'GroupId')

External: &external
  Scheme: 'internet-facing'
  Subnets: Split(',', get_expvalue('SubnetsPublic'))

Internal: &internal
  Scheme: 'internal'
  Subnets: Split(',', get_expvalue('SubnetsPrivate'))

global:
  ElasticLoadBalancingV2LoadBalancerAPP:
    - External:
        <<: *external
        <<: *app
    - Internal:
        <<: *internal
        <<: *app
  ElasticLoadBalancingV2LoadBalancerNET:
    - External:
        <<: *external
        <<: *net
    - Internal:
        <<: *internal
        <<: *net
  ElasticLoadBalancingV2LoadBalancerALB:
    - External:
        <<: *external
        <<: *alb
    - Internal:
        <<: *internal
        <<: *alb
