IBoxLoader: !include [
  autoscaling.yml,
  loadbalancing-elb.yml,
  securitygroup.yml,
  alarms.yml,
  cloudfront-ios.yml,
  parameterstore.yml,
  imageid-ec2.yml,
  launchtemplate.yml,
]

ec2:
  Parameter:
    - UpdateMode:
        Description: 'How to update Instances'
        AllowedValue: ['None', 'Replace', 'Rolling', 'CodeDeploy', 'Cfn']
        Default: 'None'
    - AutoScalingGroupBaseHealthCheckGracePeriod:
        Description: 'How long to wait before ASG check instance health - empty for default based on env/role'
  Condition:
    - RollingUpdate:
        Equals(Ref('UpdateMode'), 'Rolling')
    - WillReplace:
        Equals(Ref('UpdateMode'), 'Replace')
    - Spot:
        And(
          Condition('LaunchTemplateDataInstanceMarketOptionsSpotOptionsMaxPrice'),
          Equals('1', '1'),
        )
  Output:
    - UpdateMode:
        Value: Ref('UpdateMode')
  AutoScalingGroup:
    - Base:
        AvailabilityZones: GetAZs()
        DesiredCapacity: get_endvalue('CapacityDesired')
        MinSize: get_endvalue('CapacityMin')
        CreationPolicy:
          ResourceSignal:
            Count: get_endvalue('CapacityDesired')
            Timeout: PT15M
        HealthCheckGracePeriod: 600
        HealthCheckType: EC2
        LaunchTemplate:
          LaunchTemplateId: Ref('LaunchTemplate')
          Version: GetAtt('LaunchTemplate', 'LatestVersionNumber')
        MaxSize: get_endvalue('CapacityMax')
        MetricsCollection:
          - 0:
              Granularity: 1Minute
        Tags:
          - Name:
              Key: Name
              Value: Ref('EnvRole')
              PropagateAtLaunch: True
          - EnvStackName:
              Key: EnvStackName
              Value: Ref('AWS::StackName')
              PropagateAtLaunch: True
        TerminationPolicies: ['OldestInstance']
        UpdatePolicy:
          AutoScalingReplacingUpdate:
            IBOXIF:
              - WillReplace
              - Ref('AWS::NoValue')
            WillReplace: True
          AutoScalingRollingUpdate:
            IBOXIF:
              - RollingUpdate
              - Ref('AWS::NoValue')
            MaxBatchSize: 1
            MinInstancesInService: get_endvalue('CapacityDesired')
            MinSuccessfulInstancesPercent: 100 
            PauseTime: PT20M
            SuspendProcesses:
              - HealthCheck
              - ReplaceUnhealthy
              - AlarmNotification
              - ScheduledActions
            WaitOnResourceSignals: True
          AutoScalingScheduledAction:
            IgnoreUnmodifiedGroupSizeProperties: True
  MappingClass:
    - EC2:
  AlarmCPUBase: &cpu
    Dimensions:
      - Autoscaling:
          Name: AutoScalingGroupName
          Value: Ref('AutoScalingGroup')
    Namespace: 'AWS/EC2'
  Alarm:
    - CPUHigh:
        <<: *cpu
        Enabled: True
    - CPULow:
        <<: *cpu
        Enabled: True
  CustomUserDataScript: init.sh
  DeploymentGroup: False
  LoadBalancer:
    CookieSticky: None
    IdleTimeout: 60
  IAMPolicy:
    - CloudFormation:
        Roles:
          - Ref('RoleInstance')
        Statement:
          - 1:
              Action:
                - 'cloudformation:DescribeStackResource'
                - 'cloudformation:SignalResource'
              Resource: Sub('arn:aws:cloudformation:*:*:stack/${AWS::StackName}/*')
    - ParameterStore:
        Roles:
          - Ref('RoleInstance')
  Role:
    - Instance:
        ManagedPolicyArns:
          - get_expvalue('IAMPolicyBaseInstance')
          - get_expvalue('IAMPolicySSM')
        Principal: ec2.amazonaws.com
  ScalingPolicyTrackings:
    - ASCustom:
        TargetTrackingConfiguration:
          CustomizedMetricSpecification:
            Dimensions:
              - AutoScaling:
                  Name: AutoScalingGroupName
                  Value: Ref('AutoScalingGroup')
  ScheduledAction:
    - Down:
        DesiredSize: CapacityDesired
        MaxSize: CapacityMax
        MinSize: CapacityMin
        Recurrence: '00 19 * * *'
    - Up:
        DesiredSize: CapacityDesired
        MaxSize: CapacityMax
        MinSize: CapacityMin
        Recurrence: '30 08 * * mon-fri'

dev: &cfg_dev
  Alarm:
    - BackendExternal5XX:
        EvaluationPeriods: 0
    - BackendInternal5XX:
        EvaluationPeriods: 0
    - TargetEC2External5XX:
        EvaluationPeriods: 0
    - TargetEC2Internal5XX:
        EvaluationPeriods: 0

stg: *cfg_dev 


prd:
  #AutoScalingGroupBaseHealthCheckType: ELB

IBoxLoaderAfter: !include [
  spot-auto.yml,
  cloudwatch-agent.yml,
]
