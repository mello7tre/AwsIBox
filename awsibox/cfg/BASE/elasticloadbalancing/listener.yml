Http: &http
  IBOX_PARAMETER:
    - ListenerLoadBalancerHttpPort:
        Description: 'Http Port where Load Balancer listen - empty for default based on env/role'
  Port: get_endvalue('ListenerLoadBalancerHttpPort')
  Protocol: HTTP

Https: &https
  IBOX_PARAMETER:
    - ListenerLoadBalancerHttpsPort:
        Description: 'Https Port where Load Balancer listen - empty for default based on env/role'
  Certificates:
    Regional:
      CertificateArn: get_endvalue('RegionalCertificateArn')
  Port: get_endvalue('ListenerLoadBalancerHttpsPort')
  Protocol: HTTPS
  SslPolicy.IBOX_AUTO_PO: {}
  SslPolicy: ELBSecurityPolicy-2016-08

External: &external
  DefaultActions:
    - TG:
        Type: forward
        TargetGroupArn: Ref(f'TargetGroupExternal')
  LoadBalancerArn: Ref(f'LoadBalancerApplicationExternal')
  
Internal: &internal
  DefaultActions:
    - TG:
        Type: forward
        TargetGroupArn: Ref(f'TargetGroupInternal')
  LoadBalancerArn: Ref(f'LoadBalancerApplicationInternal')

HttpExternal: &httpexternal
  <<: [*external, *http]

HttpInternal: &httpinternal
  <<: [*internal, *http]

HttpsExternal: &httpsexternal
  <<: [*external, *https]

ALB: &alb
  DefaultActions:
    - 404:
        FixedResponseConfig:
          ContentType: 'text/plain'
          MessageBody: "404 Not Found\n"
          StatusCode: '404'
        Type: 'fixed-response' 


global:
  ElasticLoadBalancingV2Listener:
    - IBOX_BASE:
        Access: Public
        Port.IBOX_AUTO_PO: {}
    - EC2HttpInternal:
        IBOX_ENABLED: False
        DefaultActions:
          - TG:
              Type: forward
              TargetGroupArn: Ref('ElasticLoadBalancingV2TargetGroupLoadBalancerApplicationInternal')
        LoadBalancerArn: Ref('LoadBalancerApplicationInternal')
        Port: 80
        Protocol: HTTP
    - EC2HttpsExternal:
        IBOX_ENABLED: False
        DefaultActions:
          - TG:
              Type: forward
              TargetGroupArn: Ref('ElasticLoadBalancingV2TargetGroupLoadBalancerApplicationExternal')
        LoadBalancerArn: Ref('LoadBalancerApplicationExternal')
        Port: 443
        Protocol: HTTPS
        Certificates:
          Regional:
            CertificateArn: get_endvalue('RegionalCertificateArn')
        SslPolicy.IBOX_AUTO_PO: {}
        SslPolicy: ELBSecurityPolicy-2016-08
    - EC2TCPExternal:
        IBOX_ENABLED: False
        DefaultActions:
          - TG:
              Type: forward
              TargetGroupArn: Ref('ElasticLoadBalancingV2TargetGroupLoadBalancerNetworkExternal')
        LoadBalancerArn: Ref('LoadBalancerNetworkExternal')
        Protocol: TCP
        Port: 80
    - EC2TCPInternal:
        IBOX_ENABLED: False
        DefaultActions:
          - TG:
              Type: forward
              TargetGroupArn: Ref('ElasticLoadBalancingV2TargetGroupLoadBalancerNetworkInternal')
        LoadBalancerArn: Ref('LoadBalancerNetworkInternal')
        Protocol: TCP
        Port: 80
  ListenerV2ECS:
    - HttpExternal:
        <<: *httpexternal
        LoadBalancerArn: get_expvalue('LoadBalancerApplicationExternal', 'LoadBalancerApplicationStack')
    - HttpInternal:
        <<: *httpinternal
        LoadBalancerArn: get_expvalue('LoadBalancerApplicationInternal', 'LoadBalancerApplicationStack')
    - HttpsExternal:
        <<: *httpsexternal
        LoadBalancerArn: get_expvalue('LoadBalancerApplicationExternal', 'LoadBalancerApplicationStack')
  ListenerV2ALB:
    - HttpExternal:
        <<: [*alb, *httpexternal]
        IBOX_OUTPUT:
          - _:
              Condition: LoadBalancerApplicationExternal
              Value: Ref(IBOX_RESNAME)
              Export: Export(Sub('%s-${AWS::StackName}' % IBOX_RESNAME))
        Condition: LoadBalancerApplicationExternal
    - HttpInternal:
        <<: [*alb, *httpinternal]
        IBOX_OUTPUT:
          - _:
              Condition: LoadBalancerApplicationInternal
              Value: Ref(IBOX_RESNAME)
              Export: Export(Sub('%s-${AWS::StackName}' % IBOX_RESNAME))
        Condition: LoadBalancerApplicationInternal
    - HttpsExternal:
        <<: [*alb, *httpsexternal]
        IBOX_OUTPUT:
          - _:
              Condition: LoadBalancerApplicationExternal
              Value: Ref(IBOX_RESNAME)
              Export: Export(Sub('%s-${AWS::StackName}' % IBOX_RESNAME))
        Condition: LoadBalancerApplicationExternal
  ListenerLoadBalancerHttpPort: 80
  ListenerLoadBalancerHttpsPort: 443
